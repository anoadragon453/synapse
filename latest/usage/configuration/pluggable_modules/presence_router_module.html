<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Presence Router - Synapse</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../../favicon.png">
        
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        
        <link rel="stylesheet" href="../../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Setup</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../setup/installation.html"><strong aria-hidden="true">2.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../../../setup/postgres.html"><strong aria-hidden="true">2.2.</strong> Using Postgres</a></li><li class="chapter-item expanded "><a href="../../../setup/reverse_proxy.html"><strong aria-hidden="true">2.3.</strong> Configuring a Reverse Proxy</a></li><li class="chapter-item expanded "><a href="../../../setup/turn-howto.html"><strong aria-hidden="true">2.4.</strong> Configuring a Turn Server</a></li><li class="chapter-item expanded "><a href="../../../setup/delegate.html"><strong aria-hidden="true">2.5.</strong> Delegation</a></li></ol></li><li class="chapter-item expanded "><a href="../../../upgrading/index.html"><strong aria-hidden="true">3.</strong> Upgrading</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../upgrading/MSC1711_certificates_FAQ.html"><strong aria-hidden="true">3.1.</strong> Upgrading from pre-Synapse 1.0</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Usage</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../usage/federate.html"><strong aria-hidden="true">4.1.</strong> Federation</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.</strong> Configuration</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../usage/configuration/sample_config.html"><strong aria-hidden="true">4.2.1.</strong> Sample Configuration Files</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.2.</strong> User Authentication</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.2.1.</strong> Single-Sign On</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../usage/configuration/user_authentication/single_sign_on/openid.html"><strong aria-hidden="true">4.2.2.1.1.</strong> OpenID Connect</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.2.1.2.</strong> SAML</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.2.1.3.</strong> CAS</div></li><li class="chapter-item expanded "><a href="../../../usage/configuration/user_authentication/single_sign_on/sso_mapping_providers.html"><strong aria-hidden="true">4.2.2.1.4.</strong> SSO Mapping Providers</a></li></ol></li><li class="chapter-item expanded "><a href="../../../usage/configuration/user_authentication/password_auth_providers.html"><strong aria-hidden="true">4.2.2.2.</strong> Password Auth Providers</a></li><li class="chapter-item expanded "><a href="../../../usage/configuration/user_authentication/jwt.html"><strong aria-hidden="true">4.2.2.3.</strong> JSON Web Tokens</a></li></ol></li><li class="chapter-item expanded "><a href="../../../usage/configuration/CAPTCHA_SETUP.html"><strong aria-hidden="true">4.2.3.</strong> Registration Captcha</a></li><li class="chapter-item expanded "><a href="../../../usage/configuration/application_services.html"><strong aria-hidden="true">4.2.4.</strong> Application Services</a></li><li class="chapter-item expanded "><a href="../../../usage/configuration/server_notices.html"><strong aria-hidden="true">4.2.5.</strong> Server Notices</a></li><li class="chapter-item expanded "><a href="../../../usage/configuration/consent_tracking.html"><strong aria-hidden="true">4.2.6.</strong> Consent Tracking</a></li><li class="chapter-item expanded "><a href="../../../usage/configuration/url_previews.html"><strong aria-hidden="true">4.2.7.</strong> URL Previews</a></li><li class="chapter-item expanded "><a href="../../../usage/configuration/user_directory.html"><strong aria-hidden="true">4.2.8.</strong> User Directory</a></li><li class="chapter-item expanded "><a href="../../../usage/configuration/message_retention_policies.html"><strong aria-hidden="true">4.2.9.</strong> Message Retention Policies</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.10.</strong> Pluggable Modules</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.10.1.</strong> Third Party Rules</div></li><li class="chapter-item expanded "><a href="../../../usage/configuration/pluggable_modules/spam_checker.html"><strong aria-hidden="true">4.2.10.2.</strong> Spam Checker</a></li><li class="chapter-item expanded "><a href="../../../usage/configuration/pluggable_modules/presence_router_module.html" class="active"><strong aria-hidden="true">4.2.10.3.</strong> Presence Router</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.10.4.</strong> Writing a Module</div></li></ol></li><li class="chapter-item expanded "><a href="../../../usage/configuration/workers/workers.html"><strong aria-hidden="true">4.2.11.</strong> Workers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../usage/configuration/workers/synctl_workers.html"><strong aria-hidden="true">4.2.11.1.</strong> Using synctl with Workers</a></li><li class="chapter-item expanded "><a href="../../../usage/configuration/workers/systemd-with-workers/index.html"><strong aria-hidden="true">4.2.11.2.</strong> Systemd</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../administration/index.html"><strong aria-hidden="true">4.3.</strong> Administration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../usage/administration/admin_api/index.html"><strong aria-hidden="true">4.3.1.</strong> Admin API</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../usage/administration/admin_api/account_validity.html"><strong aria-hidden="true">4.3.1.1.</strong> Account Validity</a></li><li class="chapter-item expanded "><a href="../../../usage/administration/admin_api/delete_group.html"><strong aria-hidden="true">4.3.1.2.</strong> Delete Group</a></li><li class="chapter-item expanded "><a href="../../../usage/administration/admin_api/event_reports.html"><strong aria-hidden="true">4.3.1.3.</strong> Event Reports</a></li><li class="chapter-item expanded "><a href="../../../usage/administration/admin_api/media_admin_api.html"><strong aria-hidden="true">4.3.1.4.</strong> Media</a></li><li class="chapter-item expanded "><a href="../../../usage/administration/admin_api/purge_history.html"><strong aria-hidden="true">4.3.1.5.</strong> Purge History</a></li><li class="chapter-item expanded "><a href="../../../usage/administration/admin_api/purge_room.html"><strong aria-hidden="true">4.3.1.6.</strong> Purge Rooms</a></li><li class="chapter-item expanded "><a href="../../../usage/administration/admin_api/register_api.html"><strong aria-hidden="true">4.3.1.7.</strong> Register Users</a></li><li class="chapter-item expanded "><a href="../../../usage/administration/admin_api/room_membership.html"><strong aria-hidden="true">4.3.1.8.</strong> Manipulate Room Membership</a></li><li class="chapter-item expanded "><a href="../../../usage/administration/admin_api/rooms.html"><strong aria-hidden="true">4.3.1.9.</strong> Rooms</a></li><li class="chapter-item expanded "><a href="../../../usage/administration/admin_api/server_notices.html"><strong aria-hidden="true">4.3.1.10.</strong> Server Notices</a></li><li class="chapter-item expanded "><a href="../../../usage/administration/admin_api/shutdown_room.html"><strong aria-hidden="true">4.3.1.11.</strong> Shutdown Room</a></li><li class="chapter-item expanded "><a href="../../../usage/administration/admin_api/statistics.html"><strong aria-hidden="true">4.3.1.12.</strong> Statistics</a></li><li class="chapter-item expanded "><a href="../../../usage/administration/admin_api/user_admin_api.html"><strong aria-hidden="true">4.3.1.13.</strong> Users</a></li><li class="chapter-item expanded "><a href="../../../usage/administration/admin_api/version_api.html"><strong aria-hidden="true">4.3.1.14.</strong> Server Version</a></li></ol></li><li class="chapter-item expanded "><a href="../../../usage/administration/manhole.html"><strong aria-hidden="true">4.3.2.</strong> Manhole</a></li><li class="chapter-item expanded "><a href="../../../usage/administration/metrics-howto.html"><strong aria-hidden="true">4.3.3.</strong> Monitoring</a></li><li class="chapter-item expanded "><a href="../../../usage/administration/structured_logging.html"><strong aria-hidden="true">4.3.4.</strong> Structured Logging</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.5.</strong> Scripts</div></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Development</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../development/contributing_guide.html"><strong aria-hidden="true">5.1.</strong> Contributing Guide</a></li><li class="chapter-item expanded "><a href="../../../development/code_style.html"><strong aria-hidden="true">5.2.</strong> Code Style</a></li><li class="chapter-item expanded "><a href="../../../development/git.html"><strong aria-hidden="true">5.3.</strong> Git Usage</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.4.</strong> Testing</div></li><li class="chapter-item expanded "><a href="../../../development/opentracing.html"><strong aria-hidden="true">5.5.</strong> OpenTracing</a></li><li class="chapter-item expanded "><a href="../../../development/synapse_architecture/architecture.html"><strong aria-hidden="true">5.6.</strong> Synapse Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../development/synapse_architecture/log_contexts.html"><strong aria-hidden="true">5.6.1.</strong> Log Contexts</a></li><li class="chapter-item expanded "><a href="../../../development/synapse_architecture/replication.html"><strong aria-hidden="true">5.6.2.</strong> Replication</a></li><li class="chapter-item expanded "><a href="../../../development/synapse_architecture/tcp_replication.html"><strong aria-hidden="true">5.6.3.</strong> TCP Replication</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.7.</strong> Feature Documentation</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">5.7.1.</strong> Single-Sign On</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../development/feature_documentation/single_sign_on/saml.html"><strong aria-hidden="true">5.7.1.1.</strong> SAML</a></li><li class="chapter-item expanded "><a href="../../../development/feature_documentation/single_sign_on/cas.html"><strong aria-hidden="true">5.7.1.2.</strong> CAS</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.7.2.</strong> State Resolution</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../development/feature_documentation/state_resolution/auth_chain_difference_algorithm.html"><strong aria-hidden="true">5.7.2.1.</strong> The Auth Chain Difference Algorithm</a></li></ol></li><li class="chapter-item expanded "><a href="../../../development/feature_documentation/media_repository.html"><strong aria-hidden="true">5.7.3.</strong> Media Repository</a></li><li class="chapter-item expanded "><a href="../../../development/feature_documentation/room_and_user_statistics.html"><strong aria-hidden="true">5.7.4.</strong> Room and User Statistics</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.8.</strong> Scripts</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Other</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../other/deprecation_policy.html"><strong aria-hidden="true">6.1.</strong> Dependency Deprecation Policy</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Synapse</h1>

                    <div class="right-buttons">
                        
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/anoadragon453/synapse" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                        
                        <a href="https://github.com/anoadragon453/synapse/edit/develop/src/usage/configuration/pluggable_modules/presence_router_module.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="presence-router-module"><a class="header" href="#presence-router-module">Presence Router Module</a></h1>
<p>Synapse supports configuring a module that can specify additional users
(local or remote) to should receive certain presence updates from local
users.</p>
<p>Note that routing presence via Application Service transactions is not
currently supported.</p>
<p>The presence routing module is implemented as a Python class, which will
be imported by the running Synapse.</p>
<h2 id="python-presence-router-class"><a class="header" href="#python-presence-router-class">Python Presence Router Class</a></h2>
<p>The Python class is instantiated with two objects:</p>
<ul>
<li>A configuration object of some type (see below).</li>
<li>An instance of <code>synapse.module_api.ModuleApi</code>.</li>
</ul>
<p>It then implements methods related to presence routing.</p>
<p>Note that one method of <code>ModuleApi</code> that may be useful is:</p>
<pre><code class="language-python">async def ModuleApi.send_local_online_presence_to(users: Iterable[str]) -&gt; None
</code></pre>
<p>which can be given a list of local or remote MXIDs to broadcast known, online user
presence to (for those users that the receiving user is considered interested in). 
It does not include state for users who are currently offline, and it can only be
called on workers that support sending federation.</p>
<h3 id="module-structure"><a class="header" href="#module-structure">Module structure</a></h3>
<p>Below is a list of possible methods that can be implemented, and whether they are
required.</p>
<h4 id="parse_config"><a class="header" href="#parse_config"><code>parse_config</code></a></h4>
<pre><code class="language-python">def parse_config(config_dict: dict) -&gt; Any
</code></pre>
<p><strong>Required.</strong> A static method that is passed a dictionary of config options, and
should return a validated config object. This method is described further in
<a href="#configuration">Configuration</a>.</p>
<h4 id="get_users_for_states"><a class="header" href="#get_users_for_states"><code>get_users_for_states</code></a></h4>
<pre><code class="language-python">async def get_users_for_states(
    self,
    state_updates: Iterable[UserPresenceState],
) -&gt; Dict[str, Set[UserPresenceState]]:
</code></pre>
<p><strong>Required.</strong> An asynchronous method that is passed an iterable of user presence
state. This method can determine whether a given presence update should be sent to certain
users. It does this by returning a dictionary with keys representing local or remote
Matrix User IDs, and values being a python set
of <code>synapse.handlers.presence.UserPresenceState</code> instances.</p>
<p>Synapse will then attempt to send the specified presence updates to each user when
possible.</p>
<h4 id="get_interested_users"><a class="header" href="#get_interested_users"><code>get_interested_users</code></a></h4>
<pre><code class="language-python">async def get_interested_users(self, user_id: str) -&gt; Union[Set[str], str]
</code></pre>
<p><strong>Required.</strong> An asynchronous method that is passed a single Matrix User ID. This
method is expected to return the users that the passed in user may be interested in the
presence of. Returned users may be local or remote. The presence routed as a result of
what this method returns is sent in addition to the updates already sent between users
that share a room together. Presence updates are deduplicated.</p>
<p>This method should return a python set of Matrix User IDs, or the object
<code>synapse.events.presence_router.PresenceRouter.ALL_USERS</code> to indicate that the passed
user should receive presence information for <em>all</em> known users.</p>
<p>For clarity, if the user <code>@alice:example.org</code> is passed to this method, and the Set
<code>{&quot;@bob:example.com&quot;, &quot;@charlie:somewhere.org&quot;}</code> is returned, this signifies that Alice
should receive presence updates sent by Bob and Charlie, regardless of whether these
users share a room.</p>
<h3 id="example"><a class="header" href="#example">Example</a></h3>
<p>Below is an example implementation of a presence router class.</p>
<pre><code class="language-python">from typing import Dict, Iterable, Set, Union
from synapse.events.presence_router import PresenceRouter
from synapse.handlers.presence import UserPresenceState
from synapse.module_api import ModuleApi

class PresenceRouterConfig:
    def __init__(self):
        # Config options with their defaults
        # A list of users to always send all user presence updates to
        self.always_send_to_users = []  # type: List[str]
        
        # A list of users to ignore presence updates for. Does not affect
        # shared-room presence relationships
        self.blacklisted_users = []  # type: List[str]

class ExamplePresenceRouter:
    &quot;&quot;&quot;An example implementation of synapse.presence_router.PresenceRouter.
    Supports routing all presence to a configured set of users, or a subset
    of presence from certain users to members of certain rooms.

    Args:
        config: A configuration object.
        module_api: An instance of Synapse's ModuleApi.
    &quot;&quot;&quot;
    def __init__(self, config: PresenceRouterConfig, module_api: ModuleApi):
        self._config = config
        self._module_api = module_api

    @staticmethod
    def parse_config(config_dict: dict) -&gt; PresenceRouterConfig:
        &quot;&quot;&quot;Parse a configuration dictionary from the homeserver config, do
        some validation and return a typed PresenceRouterConfig.

        Args:
            config_dict: The configuration dictionary.

        Returns:
            A validated config object.
        &quot;&quot;&quot;
        # Initialise a typed config object
        config = PresenceRouterConfig()
        always_send_to_users = config_dict.get(&quot;always_send_to_users&quot;)
        blacklisted_users = config_dict.get(&quot;blacklisted_users&quot;)

        # Do some validation of config options... otherwise raise a
        # synapse.config.ConfigError.
        config.always_send_to_users = always_send_to_users
        config.blacklisted_users = blacklisted_users

        return config

    async def get_users_for_states(
        self,
        state_updates: Iterable[UserPresenceState],
    ) -&gt; Dict[str, Set[UserPresenceState]]:
        &quot;&quot;&quot;Given an iterable of user presence updates, determine where each one
        needs to go. Returned results will not affect presence updates that are
        sent between users who share a room.

        Args:
            state_updates: An iterable of user presence state updates.

        Returns:
          A dictionary of user_id -&gt; set of UserPresenceState that the user should 
          receive.
        &quot;&quot;&quot;
        destination_users = {}  # type: Dict[str, Set[UserPresenceState]

        # Ignore any updates for blacklisted users
        desired_updates = set()
        for update in state_updates:
            if update.state_key not in self._config.blacklisted_users:
                desired_updates.add(update)

        # Send all presence updates to specific users
        for user_id in self._config.always_send_to_users:
            destination_users[user_id] = desired_updates

        return destination_users

    async def get_interested_users(
        self,
        user_id: str,
    ) -&gt; Union[Set[str], PresenceRouter.ALL_USERS]:
        &quot;&quot;&quot;
        Retrieve a list of users that `user_id` is interested in receiving the
        presence of. This will be in addition to those they share a room with.
        Optionally, the object PresenceRouter.ALL_USERS can be returned to indicate
        that this user should receive all incoming local and remote presence updates.

        Note that this method will only be called for local users.

        Args:
          user_id: A user requesting presence updates.

        Returns:
          A set of user IDs to return additional presence updates for, or
          PresenceRouter.ALL_USERS to return presence updates for all other users.
        &quot;&quot;&quot;
        if user_id in self._config.always_send_to_users:
            return PresenceRouter.ALL_USERS

        return set()
</code></pre>
<h4 id="a-note-on-get_users_for_states-and-get_interested_users"><a class="header" href="#a-note-on-get_users_for_states-and-get_interested_users">A note on <code>get_users_for_states</code> and <code>get_interested_users</code></a></h4>
<p>Both of these methods are effectively two different sides of the same coin. The logic
regarding which users should receive updates for other users should be the same 
between them.</p>
<p><code>get_users_for_states</code> is called when presence updates come in from either federation 
or local users, and is used to either direct local presence to remote users, or to
wake up the sync streams of local users to collect remote presence.</p>
<p>In contrast, <code>get_interested_users</code> is used to determine the users that presence should
be fetched for when a local user is syncing. This presence is then retrieved, before
being fed through <code>get_users_for_states</code> once again, with only the syncing user's
routing information pulled from the resulting dictionary.</p>
<p>Their routing logic should thus line up, else you may run into unintended behaviour.</p>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>Once you've crafted your module and installed it into the same Python environment as
Synapse, amend your homeserver config file with the following.</p>
<pre><code class="language-yaml">presence:
  routing_module:
    module: my_module.ExamplePresenceRouter
    config:
      # Any configuration options for your module. The below is an example.
      # of setting options for ExamplePresenceRouter.
      always_send_to_users: [&quot;@presence_gobbler:example.org&quot;]
      blacklisted_users:
        - &quot;@alice:example.com&quot;
        - &quot;@bob:example.com&quot;
      ...
</code></pre>
<p>The contents of <code>config</code> will be passed as a Python dictionary to the static
<code>parse_config</code> method of your class. The object returned by this method will
then be passed to the <code>__init__</code> method of your module as <code>config</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../../usage/configuration/pluggable_modules/spam_checker.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../../usage/configuration/workers/workers.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../../usage/configuration/pluggable_modules/spam_checker.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../../usage/configuration/workers/workers.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
