<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Synapse</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="setup/index.html"><strong aria-hidden="true">2.</strong> Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../INSTALL.html"><strong aria-hidden="true">2.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="setup/postgres.html"><strong aria-hidden="true">2.2.</strong> Using Postgres</a></li><li class="chapter-item expanded "><a href="setup/reverse_proxy.html"><strong aria-hidden="true">2.3.</strong> Configuring a Reverse Proxy</a></li><li class="chapter-item expanded "><a href="setup/turn-howto.html"><strong aria-hidden="true">2.4.</strong> Configuring a Turn Server</a></li><li class="chapter-item expanded "><a href="setup/delegate.html"><strong aria-hidden="true">2.5.</strong> Delegation</a></li></ol></li><li class="chapter-item expanded "><a href="upgrading/index.html"><strong aria-hidden="true">3.</strong> Upgrading</a></li><li class="chapter-item expanded "><a href="usage/index.html"><strong aria-hidden="true">4.</strong> Usage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usage/federate.html"><strong aria-hidden="true">4.1.</strong> Federation</a></li><li class="chapter-item expanded "><a href="configuration/index.html"><strong aria-hidden="true">4.2.</strong> Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usage/configuration/sample_config.html"><strong aria-hidden="true">4.2.1.</strong> Sample Config</a></li><li class="chapter-item expanded "><a href="usage/configuration/user_authentication/index.html"><strong aria-hidden="true">4.2.2.</strong> User Authentication</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usage/configuration/user_authentication/openid.html"><strong aria-hidden="true">4.2.2.1.</strong> OpenID</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.2.2.</strong> CAS</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usage/configuration/user_authentication/sso_mapping_providers.html"><strong aria-hidden="true">4.2.2.2.1.</strong> SSO Mapping Providers</a></li></ol></li><li class="chapter-item expanded "><a href="usage/configuration/user_authentication/password_auth_providers.html"><strong aria-hidden="true">4.2.2.3.</strong> Password Auth Providers</a></li><li class="chapter-item expanded "><a href="usage/configuration/user_authentication/jwt.html"><strong aria-hidden="true">4.2.2.4.</strong> JSON Web Tokens</a></li></ol></li><li class="chapter-item expanded "><a href="usage/configuration/CAPTCHA_SETUP.html"><strong aria-hidden="true">4.2.3.</strong> Registration Captcha</a></li><li class="chapter-item expanded "><a href="usage/configuration/application_services.html"><strong aria-hidden="true">4.2.4.</strong> Application Services</a></li><li class="chapter-item expanded "><a href="usage/configuration/server_notices.html"><strong aria-hidden="true">4.2.5.</strong> Server Notices</a></li><li class="chapter-item expanded "><a href="usage/configuration/consent_tracking.html"><strong aria-hidden="true">4.2.6.</strong> Consent Tracking</a></li><li class="chapter-item expanded "><a href="usage/configuration/url_previews.html"><strong aria-hidden="true">4.2.7.</strong> URL Previews</a></li><li class="chapter-item expanded "><a href="usage/configuration/user_directory.html"><strong aria-hidden="true">4.2.8.</strong> User Directory</a></li><li class="chapter-item expanded "><a href="usage/configuration/message_retention_policies.html"><strong aria-hidden="true">4.2.9.</strong> Message Retention Policies</a></li><li class="chapter-item expanded "><a href="usage/configuration/pluggable_modules/index.html"><strong aria-hidden="true">4.2.10.</strong> Pluggable Modules</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usage/configuration/pluggable_modules/third_party_rules.html"><strong aria-hidden="true">4.2.10.1.</strong> Third Party Rules</a></li><li class="chapter-item expanded "><a href="usage/configuration/pluggable_modules/spam_checker.html"><strong aria-hidden="true">4.2.10.2.</strong> Spam Checker</a></li><li class="chapter-item expanded "><a href="usage/configuration/pluggable_modules/presence_router_module.html"><strong aria-hidden="true">4.2.10.3.</strong> Presence Router</a></li></ol></li><li class="chapter-item expanded "><a href="usage/configuration/worker_setup.html"><strong aria-hidden="true">4.2.11.</strong> Workers</a></li></ol></li><li class="chapter-item expanded "><a href="administration/index.html"><strong aria-hidden="true">4.3.</strong> Administration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usage/administration/admin_api/index.html"><strong aria-hidden="true">4.3.1.</strong> Admin API</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usage/administration/admin_api/account_validity.html"><strong aria-hidden="true">4.3.1.1.</strong> Account Validity</a></li><li class="chapter-item expanded "><a href="usage/administration/admin_api/delete_group.html"><strong aria-hidden="true">4.3.1.2.</strong> Delete Group</a></li><li class="chapter-item expanded "><a href="usage/administration/admin_api/event_reports.html"><strong aria-hidden="true">4.3.1.3.</strong> Event Reports</a></li><li class="chapter-item expanded "><a href="usage/administration/admin_api/media_admin_api.html"><strong aria-hidden="true">4.3.1.4.</strong> Media</a></li><li class="chapter-item expanded "><a href="usage/administration/admin_api/purge_history.html"><strong aria-hidden="true">4.3.1.5.</strong> Purge History</a></li><li class="chapter-item expanded "><a href="usage/administration/admin_api/purge_room.html"><strong aria-hidden="true">4.3.1.6.</strong> Purge Rooms</a></li><li class="chapter-item expanded "><a href="usage/administration/admin_api/register_api.html"><strong aria-hidden="true">4.3.1.7.</strong> Register Users</a></li><li class="chapter-item expanded "><a href="usage/administration/admin_api/room_membership.html"><strong aria-hidden="true">4.3.1.8.</strong> Manipulate Room Membership</a></li><li class="chapter-item expanded "><a href="usage/administration/admin_api/rooms.html"><strong aria-hidden="true">4.3.1.9.</strong> Rooms</a></li><li class="chapter-item expanded "><a href="usage/administration/admin_api/server_notices.html"><strong aria-hidden="true">4.3.1.10.</strong> Server Notices</a></li><li class="chapter-item expanded "><a href="usage/administration/admin_api/shutdown_room.html"><strong aria-hidden="true">4.3.1.11.</strong> Shutdown Room</a></li><li class="chapter-item expanded "><a href="usage/administration/admin_api/statistics.html"><strong aria-hidden="true">4.3.1.12.</strong> Statistics</a></li><li class="chapter-item expanded "><a href="usage/administration/admin_api/user_admin_api.html"><strong aria-hidden="true">4.3.1.13.</strong> Users</a></li><li class="chapter-item expanded "><a href="usage/administration/admin_api/version_api.html"><strong aria-hidden="true">4.3.1.14.</strong> Server Version</a></li></ol></li><li class="chapter-item expanded "><a href="usage/administration/manhole.html"><strong aria-hidden="true">4.3.2.</strong> Manhole</a></li><li class="chapter-item expanded "><a href="usage/administration/metrics-howto.html"><strong aria-hidden="true">4.3.3.</strong> Monitoring</a></li><li class="chapter-item expanded "><a href="usage/administration/structured_logging.html"><strong aria-hidden="true">4.3.4.</strong> Structured Logging</a></li><li class="chapter-item expanded "><a href="usage/administration/scripts.html"><strong aria-hidden="true">4.3.5.</strong> Scripts</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="development/index.html"><strong aria-hidden="true">5.</strong> Development</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../CONTRIBUTING.html"><strong aria-hidden="true">5.1.</strong> Contributing Guide</a></li><li class="chapter-item expanded "><a href="development/code_style.html"><strong aria-hidden="true">5.2.</strong> Code Style</a></li><li class="chapter-item expanded "><a href="development/git.html"><strong aria-hidden="true">5.3.</strong> Git Usage</a></li><li class="chapter-item expanded "><a href="development/testing.html"><strong aria-hidden="true">5.4.</strong> Testing</a></li><li class="chapter-item expanded "><a href="development/opentracing.html"><strong aria-hidden="true">5.5.</strong> OpenTracing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="development/log_contexts.html"><strong aria-hidden="true">5.5.1.</strong> Log Contexts</a></li></ol></li><li class="chapter-item expanded "><a href="development/feature_documentation/index.html"><strong aria-hidden="true">5.6.</strong> Feature Documentation</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">5.6.1.</strong> Single-Sign On</div></li><li class="chapter-item expanded "><a href="development/feature_documentation/media_repository.html"><strong aria-hidden="true">5.6.2.</strong> Media Repository</a></li><li class="chapter-item expanded "><a href="development/feature_documentation/room_and_user_statistics.html"><strong aria-hidden="true">5.6.3.</strong> Room and User Statistics</a></li><li class="chapter-item expanded "><a href="development/feature_documentation/replication.html"><strong aria-hidden="true">5.6.4.</strong> Replication</a></li><li class="chapter-item expanded "><a href="development/feature_documentation/tcp_replication.html"><strong aria-hidden="true">5.6.5.</strong> TCP Replication</a></li></ol></li><li class="chapter-item expanded "><a href="development/scripts.html"><strong aria-hidden="true">5.7.</strong> Scripts</a></li></ol></li><li class="chapter-item expanded "><a href="other/index.html"><strong aria-hidden="true">6.</strong> Other</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="other/deprecation_policy.html"><strong aria-hidden="true">6.1.</strong> Dependency Deprecation Policy</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Synapse</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Welcome to the documentation repository for Synapse, the reference
<a href="https://matrix.org">Matrix</a> homeserver implementation.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="setup"><a class="header" href="#setup">Setup</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="installation-instructions"><a class="header" href="#installation-instructions">Installation Instructions</a></h1>
<p>There are 3 steps to follow under <strong>Installation Instructions</strong>.</p>
<ul>
<li><a href="../INSTALL.html#installation-instructions">Installation Instructions</a>
<ul>
<li><a href="../INSTALL.html#choosing-your-server-name">Choosing your server name</a></li>
<li><a href="../INSTALL.html#installing-synapse">Installing Synapse</a>
<ul>
<li><a href="../INSTALL.html#installing-from-source">Installing from source</a>
<ul>
<li><a href="../INSTALL.html#platform-specific-prerequisites">Platform-specific prerequisites</a>
<ul>
<li><a href="../INSTALL.html#debianubunturaspbian">Debian/Ubuntu/Raspbian</a></li>
<li><a href="../INSTALL.html#archlinux">ArchLinux</a></li>
<li><a href="../INSTALL.html#centosfedora">CentOS/Fedora</a></li>
<li><a href="../INSTALL.html#macos">macOS</a></li>
<li><a href="../INSTALL.html#opensuse">OpenSUSE</a></li>
<li><a href="../INSTALL.html#openbsd">OpenBSD</a></li>
<li><a href="../INSTALL.html#windows">Windows</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="../INSTALL.html#prebuilt-packages">Prebuilt packages</a>
<ul>
<li><a href="../INSTALL.html#docker-images-and-ansible-playbooks">Docker images and Ansible playbooks</a></li>
<li><a href="../INSTALL.html#debianubuntu">Debian/Ubuntu</a>
<ul>
<li><a href="../INSTALL.html#matrixorg-packages">Matrix.org packages</a></li>
<li><a href="../INSTALL.html#downstream-debian-packages">Downstream Debian packages</a></li>
<li><a href="../INSTALL.html#downstream-ubuntu-packages">Downstream Ubuntu packages</a></li>
</ul>
</li>
<li><a href="../INSTALL.html#fedora">Fedora</a></li>
<li><a href="../INSTALL.html#opensuse-1">OpenSUSE</a></li>
<li><a href="../INSTALL.html#suse-linux-enterprise-server">SUSE Linux Enterprise Server</a></li>
<li><a href="../INSTALL.html#archlinux-1">ArchLinux</a></li>
<li><a href="../INSTALL.html#void-linux">Void Linux</a></li>
<li><a href="../INSTALL.html#freebsd">FreeBSD</a></li>
<li><a href="../INSTALL.html#openbsd-1">OpenBSD</a></li>
<li><a href="../INSTALL.html#nixos">NixOS</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="../INSTALL.html#setting-up-synapse">Setting up Synapse</a>
<ul>
<li><a href="../INSTALL.html#using-postgresql">Using PostgreSQL</a></li>
<li><a href="../INSTALL.html#tls-certificates">TLS certificates</a></li>
<li><a href="../INSTALL.html#client-well-known-uri">Client Well-Known URI</a></li>
<li><a href="../INSTALL.html#email">Email</a></li>
<li><a href="../INSTALL.html#registering-a-user">Registering a user</a></li>
<li><a href="../INSTALL.html#setting-up-a-turn-server">Setting up a TURN server</a></li>
<li><a href="../INSTALL.html#url-previews">URL previews</a></li>
<li><a href="../INSTALL.html#troubleshooting-installation">Troubleshooting Installation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="choosing-your-server-name"><a class="header" href="#choosing-your-server-name">Choosing your server name</a></h2>
<p>It is important to choose the name for your server before you install Synapse,
because it cannot be changed later.</p>
<p>The server name determines the &quot;domain&quot; part of user-ids for users on your
server: these will all be of the format <code>@user:my.domain.name</code>. It also
determines how other matrix servers will reach yours for federation.</p>
<p>For a test configuration, set this to the hostname of your server. For a more
production-ready setup, you will probably want to specify your domain
(<code>example.com</code>) rather than a matrix-specific hostname here (in the same way
that your email address is probably <code>user@example.com</code> rather than
<code>user@email.example.com</code>) - but doing so may require more advanced setup: see
<a href="../docs/federate.html">Setting up Federation</a>.</p>
<h2 id="installing-synapse"><a class="header" href="#installing-synapse">Installing Synapse</a></h2>
<h3 id="installing-from-source"><a class="header" href="#installing-from-source">Installing from source</a></h3>
<p>(Prebuilt packages are available for some platforms - see <a href="../INSTALL.html#prebuilt-packages">Prebuilt packages</a>.)</p>
<p>When installing from source please make sure that the <a href="../INSTALL.html#platform-specific-prerequisites">Platform-specific prerequisites</a> are already installed.</p>
<p>System requirements:</p>
<ul>
<li>POSIX-compliant system (tested on Linux &amp; OS X)</li>
<li>Python 3.5.2 or later, up to Python 3.9.</li>
<li>At least 1GB of free RAM if you want to join large public rooms like #matrix:matrix.org</li>
</ul>
<p>To install the Synapse homeserver run:</p>
<pre><code class="language-sh">mkdir -p ~/synapse
virtualenv -p python3 ~/synapse/env
source ~/synapse/env/bin/activate
pip install --upgrade pip
pip install --upgrade setuptools
pip install matrix-synapse
</code></pre>
<p>This will download Synapse from <a href="https://pypi.org/project/matrix-synapse">PyPI</a>
and install it, along with the python libraries it uses, into a virtual environment
under <code>~/synapse/env</code>.  Feel free to pick a different directory if you
prefer.</p>
<p>This Synapse installation can then be later upgraded by using pip again with the
update flag:</p>
<pre><code class="language-sh">source ~/synapse/env/bin/activate
pip install -U matrix-synapse
</code></pre>
<p>Before you can start Synapse, you will need to generate a configuration
file. To do this, run (in your virtualenv, as before):</p>
<pre><code class="language-sh">cd ~/synapse
python -m synapse.app.homeserver \
    --server-name my.domain.name \
    --config-path homeserver.yaml \
    --generate-config \
    --report-stats=[yes|no]
</code></pre>
<p>... substituting an appropriate value for <code>--server-name</code>.</p>
<p>This command will generate you a config file that you can then customise, but it will
also generate a set of keys for you. These keys will allow your homeserver to
identify itself to other homeserver, so don't lose or delete them. It would be
wise to back them up somewhere safe. (If, for whatever reason, you do need to
change your homeserver's keys, you may find that other homeserver have the
old key cached. If you update the signing key, you should change the name of the
key in the <code>&lt;server name&gt;.signing.key</code> file (the second word) to something
different. See the <a href="https://matrix.org/docs/spec/server_server/latest.html#retrieving-server-keys">spec</a> for more information on key management).</p>
<p>To actually run your new homeserver, pick a working directory for Synapse to
run (e.g. <code>~/synapse</code>), and:</p>
<pre><code class="language-sh">cd ~/synapse
source env/bin/activate
synctl start
</code></pre>
<h4 id="platform-specific-prerequisites"><a class="header" href="#platform-specific-prerequisites">Platform-specific prerequisites</a></h4>
<p>Synapse is written in Python but some of the libraries it uses are written in
C. So before we can install Synapse itself we need a working C compiler and the
header files for Python C extensions.</p>
<h5 id="debianubunturaspbian"><a class="header" href="#debianubunturaspbian">Debian/Ubuntu/Raspbian</a></h5>
<p>Installing prerequisites on Ubuntu or Debian:</p>
<pre><code class="language-sh">sudo apt install build-essential python3-dev libffi-dev \
                     python3-pip python3-setuptools sqlite3 \
                     libssl-dev virtualenv libjpeg-dev libxslt1-dev
</code></pre>
<h5 id="archlinux"><a class="header" href="#archlinux">ArchLinux</a></h5>
<p>Installing prerequisites on ArchLinux:</p>
<pre><code class="language-sh">sudo pacman -S base-devel python python-pip \
               python-setuptools python-virtualenv sqlite3
</code></pre>
<h5 id="centosfedora"><a class="header" href="#centosfedora">CentOS/Fedora</a></h5>
<p>Installing prerequisites on CentOS or Fedora Linux:</p>
<pre><code class="language-sh">sudo dnf install libtiff-devel libjpeg-devel libzip-devel freetype-devel \
                 libwebp-devel libxml2-devel libxslt-devel libpq-devel \
                 python3-virtualenv libffi-devel openssl-devel python3-devel
sudo dnf groupinstall &quot;Development Tools&quot;
</code></pre>
<h5 id="macos"><a class="header" href="#macos">macOS</a></h5>
<p>Installing prerequisites on macOS:</p>
<pre><code class="language-sh">xcode-select --install
sudo easy_install pip
sudo pip install virtualenv
brew install pkg-config libffi
</code></pre>
<p>On macOS Catalina (10.15) you may need to explicitly install OpenSSL
via brew and inform <code>pip</code> about it so that <code>psycopg2</code> builds:</p>
<pre><code class="language-sh">brew install openssl@1.1
export LDFLAGS=&quot;-L/usr/local/opt/openssl/lib&quot;
export CPPFLAGS=&quot;-I/usr/local/opt/openssl/include&quot;
</code></pre>
<h5 id="opensuse"><a class="header" href="#opensuse">OpenSUSE</a></h5>
<p>Installing prerequisites on openSUSE:</p>
<pre><code class="language-sh">sudo zypper in -t pattern devel_basis
sudo zypper in python-pip python-setuptools sqlite3 python-virtualenv \
               python-devel libffi-devel libopenssl-devel libjpeg62-devel
</code></pre>
<h5 id="openbsd"><a class="header" href="#openbsd">OpenBSD</a></h5>
<p>A port of Synapse is available under <code>net/synapse</code>. The filesystem
underlying the homeserver directory (defaults to <code>/var/synapse</code>) has to be
mounted with <code>wxallowed</code> (cf. <code>mount(8)</code>), so creating a separate filesystem
and mounting it to <code>/var/synapse</code> should be taken into consideration.</p>
<p>To be able to build Synapse's dependency on python the <code>WRKOBJDIR</code>
(cf. <code>bsd.port.mk(5)</code>) for building python, too, needs to be on a filesystem
mounted with <code>wxallowed</code> (cf. <code>mount(8)</code>).</p>
<p>Creating a <code>WRKOBJDIR</code> for building python under <code>/usr/local</code> (which on a
default OpenBSD installation is mounted with <code>wxallowed</code>):</p>
<pre><code class="language-sh">doas mkdir /usr/local/pobj_wxallowed
</code></pre>
<p>Assuming <code>PORTS_PRIVSEP=Yes</code> (cf. <code>bsd.port.mk(5)</code>) and <code>SUDO=doas</code> are
configured in <code>/etc/mk.conf</code>:</p>
<pre><code class="language-sh">doas chown _pbuild:_pbuild /usr/local/pobj_wxallowed
</code></pre>
<p>Setting the <code>WRKOBJDIR</code> for building python:</p>
<pre><code class="language-sh">echo WRKOBJDIR_lang/python/3.7=/usr/local/pobj_wxallowed  \\nWRKOBJDIR_lang/python/2.7=/usr/local/pobj_wxallowed &gt;&gt; /etc/mk.conf
</code></pre>
<p>Building Synapse:</p>
<pre><code class="language-sh">cd /usr/ports/net/synapse
make install
</code></pre>
<h5 id="windows"><a class="header" href="#windows">Windows</a></h5>
<p>If you wish to run or develop Synapse on Windows, the Windows Subsystem For
Linux provides a Linux environment on Windows 10 which is capable of using the
Debian, Fedora, or source installation methods. More information about WSL can
be found at <a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">https://docs.microsoft.com/en-us/windows/wsl/install-win10</a> for
Windows 10 and <a href="https://docs.microsoft.com/en-us/windows/wsl/install-on-server">https://docs.microsoft.com/en-us/windows/wsl/install-on-server</a>
for Windows Server.</p>
<h3 id="prebuilt-packages"><a class="header" href="#prebuilt-packages">Prebuilt packages</a></h3>
<p>As an alternative to installing from source, prebuilt packages are available
for a number of platforms.</p>
<h4 id="docker-images-and-ansible-playbooks"><a class="header" href="#docker-images-and-ansible-playbooks">Docker images and Ansible playbooks</a></h4>
<p>There is an official synapse image available at
<a href="https://hub.docker.com/r/matrixdotorg/synapse">https://hub.docker.com/r/matrixdotorg/synapse</a> which can be used with
the docker-compose file available at <a href="../contrib/docker">contrib/docker</a>. Further
information on this including configuration options is available in the README
on hub.docker.com.</p>
<p>Alternatively, Andreas Peters (previously Silvio Fricke) has contributed a
Dockerfile to automate a synapse server in a single Docker image, at
<a href="https://hub.docker.com/r/avhost/docker-matrix/tags/">https://hub.docker.com/r/avhost/docker-matrix/tags/</a></p>
<p>Slavi Pantaleev has created an Ansible playbook,
which installs the offical Docker image of Matrix Synapse
along with many other Matrix-related services (Postgres database, Element, coturn,
ma1sd, SSL support, etc.).
For more details, see
<a href="https://github.com/spantaleev/matrix-docker-ansible-deploy">https://github.com/spantaleev/matrix-docker-ansible-deploy</a></p>
<h4 id="debianubuntu"><a class="header" href="#debianubuntu">Debian/Ubuntu</a></h4>
<h5 id="matrixorg-packages"><a class="header" href="#matrixorg-packages">Matrix.org packages</a></h5>
<p>Matrix.org provides Debian/Ubuntu packages of the latest stable version of
Synapse via <a href="https://packages.matrix.org/debian/">https://packages.matrix.org/debian/</a>. They are available for Debian
9 (Stretch), Ubuntu 16.04 (Xenial), and later. To use them:</p>
<pre><code class="language-sh">sudo apt install -y lsb-release wget apt-transport-https
sudo wget -O /usr/share/keyrings/matrix-org-archive-keyring.gpg https://packages.matrix.org/debian/matrix-org-archive-keyring.gpg
echo &quot;deb [signed-by=/usr/share/keyrings/matrix-org-archive-keyring.gpg] https://packages.matrix.org/debian/ $(lsb_release -cs) main&quot; |
    sudo tee /etc/apt/sources.list.d/matrix-org.list
sudo apt update
sudo apt install matrix-synapse-py3
</code></pre>
<p><strong>Note</strong>: if you followed a previous version of these instructions which
recommended using <code>apt-key add</code> to add an old key from
<code>https://matrix.org/packages/debian/</code>, you should note that this key has been
revoked. You should remove the old key with <code>sudo apt-key remove C35EB17E1EAE708E6603A9B3AD0592FE47F0DF61</code>, and follow the above instructions to
update your configuration.</p>
<p>The fingerprint of the repository signing key (as shown by <code>gpg /usr/share/keyrings/matrix-org-archive-keyring.gpg</code>) is
<code>AAF9AE843A7584B5A3E4CD2BCF45A512DE2DA058</code>.</p>
<h5 id="downstream-debian-packages"><a class="header" href="#downstream-debian-packages">Downstream Debian packages</a></h5>
<p>We do not recommend using the packages from the default Debian <code>buster</code>
repository at this time, as they are old and suffer from known security
vulnerabilities. You can install the latest version of Synapse from
<a href="../INSTALL.html#matrixorg-packages">our repository</a> or from <code>buster-backports</code>. Please
see the <a href="https://backports.debian.org/Instructions/">Debian documentation</a>
for information on how to use backports.</p>
<p>If you are using Debian <code>sid</code> or testing, Synapse is available in the default
repositories and it should be possible to install it simply with:</p>
<pre><code class="language-sh">sudo apt install matrix-synapse
</code></pre>
<h5 id="downstream-ubuntu-packages"><a class="header" href="#downstream-ubuntu-packages">Downstream Ubuntu packages</a></h5>
<p>We do not recommend using the packages in the default Ubuntu repository
at this time, as they are old and suffer from known security vulnerabilities.
The latest version of Synapse can be installed from <a href="../INSTALL.html#matrixorg-packages">our repository</a>.</p>
<h4 id="fedora"><a class="header" href="#fedora">Fedora</a></h4>
<p>Synapse is in the Fedora repositories as <code>matrix-synapse</code>:</p>
<pre><code class="language-sh">sudo dnf install matrix-synapse
</code></pre>
<p>Oleg Girko provides Fedora RPMs at
<a href="https://obs.infoserver.lv/project/monitor/matrix-synapse">https://obs.infoserver.lv/project/monitor/matrix-synapse</a></p>
<h4 id="opensuse-1"><a class="header" href="#opensuse-1">OpenSUSE</a></h4>
<p>Synapse is in the OpenSUSE repositories as <code>matrix-synapse</code>:</p>
<pre><code class="language-sh">sudo zypper install matrix-synapse
</code></pre>
<h4 id="suse-linux-enterprise-server"><a class="header" href="#suse-linux-enterprise-server">SUSE Linux Enterprise Server</a></h4>
<p>Unofficial package are built for SLES 15 in the openSUSE:Backports:SLE-15 repository at
<a href="https://download.opensuse.org/repositories/openSUSE:/Backports:/SLE-15/standard/">https://download.opensuse.org/repositories/openSUSE:/Backports:/SLE-15/standard/</a></p>
<h4 id="archlinux-1"><a class="header" href="#archlinux-1">ArchLinux</a></h4>
<p>The quickest way to get up and running with ArchLinux is probably with the community package
<a href="https://www.archlinux.org/packages/community/any/matrix-synapse/">https://www.archlinux.org/packages/community/any/matrix-synapse/</a>, which should pull in most of
the necessary dependencies.</p>
<p>pip may be outdated (6.0.7-1 and needs to be upgraded to 6.0.8-1 ):</p>
<pre><code class="language-sh">sudo pip install --upgrade pip
</code></pre>
<p>If you encounter an error with lib bcrypt causing an Wrong ELF Class:
ELFCLASS32 (x64 Systems), you may need to reinstall py-bcrypt to correctly
compile it under the right architecture. (This should not be needed if
installing under virtualenv):</p>
<pre><code class="language-sh">sudo pip uninstall py-bcrypt
sudo pip install py-bcrypt
</code></pre>
<h4 id="void-linux"><a class="header" href="#void-linux">Void Linux</a></h4>
<p>Synapse can be found in the void repositories as 'synapse':</p>
<pre><code class="language-sh">xbps-install -Su
xbps-install -S synapse
</code></pre>
<h4 id="freebsd"><a class="header" href="#freebsd">FreeBSD</a></h4>
<p>Synapse can be installed via FreeBSD Ports or Packages contributed by Brendan Molloy from:</p>
<ul>
<li>Ports: <code>cd /usr/ports/net-im/py-matrix-synapse &amp;&amp; make install clean</code></li>
<li>Packages: <code>pkg install py37-matrix-synapse</code></li>
</ul>
<h4 id="openbsd-1"><a class="header" href="#openbsd-1">OpenBSD</a></h4>
<p>As of OpenBSD 6.7 Synapse is available as a pre-compiled binary. The filesystem
underlying the homeserver directory (defaults to <code>/var/synapse</code>) has to be
mounted with <code>wxallowed</code> (cf. <code>mount(8)</code>), so creating a separate filesystem
and mounting it to <code>/var/synapse</code> should be taken into consideration.</p>
<p>Installing Synapse:</p>
<pre><code class="language-sh">doas pkg_add synapse
</code></pre>
<h4 id="nixos"><a class="header" href="#nixos">NixOS</a></h4>
<p>Robin Lambertz has packaged Synapse for NixOS at:
<a href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/services/misc/matrix-synapse.nix">https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/services/misc/matrix-synapse.nix</a></p>
<h2 id="setting-up-synapse"><a class="header" href="#setting-up-synapse">Setting up Synapse</a></h2>
<p>Once you have installed synapse as above, you will need to configure it.</p>
<h3 id="using-postgresql"><a class="header" href="#using-postgresql">Using PostgreSQL</a></h3>
<p>By default Synapse uses <a href="https://sqlite.org/">SQLite</a> and in doing so trades performance for convenience.
SQLite is only recommended in Synapse for testing purposes or for servers with
very light workloads.</p>
<p>Almost all installations should opt to use <a href="https://www.postgresql.org">PostgreSQL</a>. Advantages include:</p>
<ul>
<li>significant performance improvements due to the superior threading and
caching model, smarter query optimiser</li>
<li>allowing the DB to be run on separate hardware</li>
</ul>
<p>For information on how to install and use PostgreSQL in Synapse, please see
<a href="../docs/postgres.html">docs/postgres.md</a></p>
<h3 id="tls-certificates"><a class="header" href="#tls-certificates">TLS certificates</a></h3>
<p>The default configuration exposes a single HTTP port on the local
interface: <code>http://localhost:8008</code>. It is suitable for local testing,
but for any practical use, you will need Synapse's APIs to be served
over HTTPS.</p>
<p>The recommended way to do so is to set up a reverse proxy on port
<code>8448</code>. You can find documentation on doing so in
<a href="../docs/reverse_proxy.html">docs/reverse_proxy.md</a>.</p>
<p>Alternatively, you can configure Synapse to expose an HTTPS port. To do
so, you will need to edit <code>homeserver.yaml</code>, as follows:</p>
<ul>
<li>First, under the <code>listeners</code> section, uncomment the configuration for the
TLS-enabled listener. (Remove the hash sign (<code>#</code>) at the start of
each line). The relevant lines are like this:</li>
</ul>
<pre><code class="language-yaml">  - port: 8448
    type: http
    tls: true
    resources:
      - names: [client, federation]
</code></pre>
<ul>
<li>
<p>You will also need to uncomment the <code>tls_certificate_path</code> and
<code>tls_private_key_path</code> lines under the <code>TLS</code> section. You will need to manage
provisioning of these certificates yourself â€” Synapse had built-in ACME
support, but the ACMEv1 protocol Synapse implements is deprecated, not
allowed by LetsEncrypt for new sites, and will break for existing sites in
late 2020. See <a href="../docs/ACME.html">ACME.md</a>.</p>
<p>If you are using your own certificate, be sure to use a <code>.pem</code> file that
includes the full certificate chain including any intermediate certificates
(for instance, if using certbot, use <code>fullchain.pem</code> as your certificate, not
<code>cert.pem</code>).</p>
</li>
</ul>
<p>For a more detailed guide to configuring your server for federation, see
<a href="../docs/federate.html">federate.md</a>.</p>
<h3 id="client-well-known-uri"><a class="header" href="#client-well-known-uri">Client Well-Known URI</a></h3>
<p>Setting up the client Well-Known URI is optional but if you set it up, it will
allow users to enter their full username (e.g. <code>@user:&lt;server_name&gt;</code>) into clients
which support well-known lookup to automatically configure the homeserver and
identity server URLs. This is useful so that users don't have to memorize or think
about the actual homeserver URL you are using.</p>
<p>The URL <code>https://&lt;server_name&gt;/.well-known/matrix/client</code> should return JSON in
the following format.</p>
<pre><code class="language-json">{
  &quot;m.homeserver&quot;: {
    &quot;base_url&quot;: &quot;https://&lt;matrix.example.com&gt;&quot;
  }
}
</code></pre>
<p>It can optionally contain identity server information as well.</p>
<pre><code class="language-json">{
  &quot;m.homeserver&quot;: {
    &quot;base_url&quot;: &quot;https://&lt;matrix.example.com&gt;&quot;
  },
  &quot;m.identity_server&quot;: {
    &quot;base_url&quot;: &quot;https://&lt;identity.example.com&gt;&quot;
  }
}
</code></pre>
<p>To work in browser based clients, the file must be served with the appropriate
Cross-Origin Resource Sharing (CORS) headers. A recommended value would be
<code>Access-Control-Allow-Origin: *</code> which would allow all browser based clients to
view it.</p>
<p>In nginx this would be something like:</p>
<pre><code class="language-nginx">location /.well-known/matrix/client {
    return 200 '{&quot;m.homeserver&quot;: {&quot;base_url&quot;: &quot;https://&lt;matrix.example.com&gt;&quot;}}';
    default_type application/json;
    add_header Access-Control-Allow-Origin *;
}
</code></pre>
<p>You should also ensure the <code>public_baseurl</code> option in <code>homeserver.yaml</code> is set
correctly. <code>public_baseurl</code> should be set to the URL that clients will use to
connect to your server. This is the same URL you put for the <code>m.homeserver</code>
<code>base_url</code> above.</p>
<pre><code class="language-yaml">public_baseurl: &quot;https://&lt;matrix.example.com&gt;&quot;
</code></pre>
<h3 id="email"><a class="header" href="#email">Email</a></h3>
<p>It is desirable for Synapse to have the capability to send email. This allows
Synapse to send password reset emails, send verifications when an email address
is added to a user's account, and send email notifications to users when they
receive new messages.</p>
<p>To configure an SMTP server for Synapse, modify the configuration section
headed <code>email</code>, and be sure to have at least the <code>smtp_host</code>, <code>smtp_port</code>
and <code>notif_from</code> fields filled out.  You may also need to set <code>smtp_user</code>,
<code>smtp_pass</code>, and <code>require_transport_security</code>.</p>
<p>If email is not configured, password reset, registration and notifications via
email will be disabled.</p>
<h3 id="registering-a-user"><a class="header" href="#registering-a-user">Registering a user</a></h3>
<p>The easiest way to create a new user is to do so from a client like <a href="https://element.io/">Element</a>.</p>
<p>Alternatively, you can do so from the command line. This can be done as follows:</p>
<ol>
<li>If synapse was installed via pip, activate the virtualenv as follows (if Synapse was
installed via a prebuilt package, <code>register_new_matrix_user</code> should already be
on the search path):
<pre><code class="language-sh">cd ~/synapse
source env/bin/activate
synctl start # if not already running
</code></pre>
</li>
<li>Run the following command:
<pre><code class="language-sh">register_new_matrix_user -c homeserver.yaml http://localhost:8008
</code></pre>
</li>
</ol>
<p>This will prompt you to add details for the new user, and will then connect to
the running Synapse to create the new user. For example:</p>
<pre><code>New user localpart: erikj
Password:
Confirm password:
Make admin [no]:
Success!
</code></pre>
<p>This process uses a setting <code>registration_shared_secret</code> in
<code>homeserver.yaml</code>, which is shared between Synapse itself and the
<code>register_new_matrix_user</code> script. It doesn't matter what it is (a random
value is generated by <code>--generate-config</code>), but it should be kept secret, as
anyone with knowledge of it can register users, including admin accounts,
on your server even if <code>enable_registration</code> is <code>false</code>.</p>
<h3 id="setting-up-a-turn-server"><a class="header" href="#setting-up-a-turn-server">Setting up a TURN server</a></h3>
<p>For reliable VoIP calls to be routed via this homeserver, you MUST configure
a TURN server. See <a href="../docs/turn-howto.html">docs/turn-howto.md</a> for details.</p>
<h3 id="url-previews"><a class="header" href="#url-previews">URL previews</a></h3>
<p>Synapse includes support for previewing URLs, which is disabled by default.  To
turn it on you must enable the <code>url_preview_enabled: True</code> config parameter
and explicitly specify the IP ranges that Synapse is not allowed to spider for
previewing in the <code>url_preview_ip_range_blacklist</code> configuration parameter.
This is critical from a security perspective to stop arbitrary Matrix users
spidering 'internal' URLs on your network. At the very least we recommend that
your loopback and RFC1918 IP addresses are blacklisted.</p>
<p>This also requires the optional <code>lxml</code> python dependency to be  installed. This
in turn requires the <code>libxml2</code> library to be available - on  Debian/Ubuntu this
means <code>apt-get install libxml2-dev</code>, or equivalent for your OS.</p>
<h3 id="troubleshooting-installation"><a class="header" href="#troubleshooting-installation">Troubleshooting Installation</a></h3>
<p><code>pip</code> seems to leak <em>lots</em> of memory during installation. For instance, a Linux
host with 512MB of RAM may run out of memory whilst installing Twisted. If this
happens, you will have to individually install the dependencies which are
failing, e.g.:</p>
<pre><code class="language-sh">pip install twisted
</code></pre>
<p>If you have any other problems, feel free to ask in
<a href="https://matrix.to/#/#synapse:matrix.org">#synapse:matrix.org</a>.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="using-postgres"><a class="header" href="#using-postgres">Using Postgres</a></h1>
<p>Postgres version 9.5 or later is known to work.</p>
<h2 id="install-postgres-client-libraries"><a class="header" href="#install-postgres-client-libraries">Install postgres client libraries</a></h2>
<p>Synapse will require the python postgres client library in order to
connect to a postgres database.</p>
<ul>
<li>
<p>If you are using the <a href="setup/../../INSTALL.html#matrixorg-packages">matrix.org debian/ubuntu
packages</a>, the necessary python
library will already be installed, but you will need to ensure the
low-level postgres library is installed, which you can do with
<code>apt install libpq5</code>.</p>
</li>
<li>
<p>For other pre-built packages, please consult the documentation from
the relevant package.</p>
</li>
<li>
<p>If you installed synapse <a href="setup/../../INSTALL.html#installing-from-source">in a
virtualenv</a>, you can install
the library with:</p>
<pre><code>~/synapse/env/bin/pip install &quot;matrix-synapse[postgres]&quot;
</code></pre>
<p>(substituting the path to your virtualenv for <code>~/synapse/env</code>, if
you used a different path). You will require the postgres
development files. These are in the <code>libpq-dev</code> package on
Debian-derived distributions.</p>
</li>
</ul>
<h2 id="set-up-database"><a class="header" href="#set-up-database">Set up database</a></h2>
<p>Assuming your PostgreSQL database user is called <code>postgres</code>, first authenticate as the database user with:</p>
<pre><code>su - postgres
# Or, if your system uses sudo to get administrative rights
sudo -u postgres bash
</code></pre>
<p>Then, create a user <code>synapse_user</code> with:</p>
<pre><code>createuser --pwprompt synapse_user
</code></pre>
<p>Before you can authenticate with the <code>synapse_user</code>, you must create a
database that it can access. To create a database, first connect to the
database with your database user:</p>
<pre><code>su - postgres # Or: sudo -u postgres bash
psql
</code></pre>
<p>and then run:</p>
<pre><code>CREATE DATABASE synapse
 ENCODING 'UTF8'
 LC_COLLATE='C'
 LC_CTYPE='C'
 template=template0
 OWNER synapse_user;
</code></pre>
<p>This would create an appropriate database named <code>synapse</code> owned by the
<code>synapse_user</code> user (which must already have been created as above).</p>
<p>Note that the PostgreSQL database <em>must</em> have the correct encoding set
(as shown above), otherwise it will not be able to store UTF8 strings.</p>
<p>You may need to enable password authentication so <code>synapse_user</code> can
connect to the database. See
<a href="https://www.postgresql.org/docs/current/auth-pg-hba-conf.html">https://www.postgresql.org/docs/current/auth-pg-hba-conf.html</a>.</p>
<p>If you get an error along the lines of <code>FATAL:  Ident authentication failed for user &quot;synapse_user&quot;</code>, you may need to use an authentication method other than
<code>ident</code>:</p>
<ul>
<li>
<p>If the <code>synapse_user</code> user has a password, add the password to the <code>database:</code>
section of <code>homeserver.yaml</code>. Then add the following to <code>pg_hba.conf</code>:</p>
<pre><code>host    synapse     synapse_user    ::1/128     md5  # or `scram-sha-256` instead of `md5` if you use that
</code></pre>
</li>
<li>
<p>If the <code>synapse_user</code> user does not have a password, then a password doesn't
have to be added to <code>homeserver.yaml</code>. But the following does need to be added
to <code>pg_hba.conf</code>:</p>
<pre><code>host    synapse     synapse_user    ::1/128     trust
</code></pre>
</li>
</ul>
<p>Note that line order matters in <code>pg_hba.conf</code>, so make sure that if you do add a
new line, it is inserted before:</p>
<pre><code>host    all         all             ::1/128     ident
</code></pre>
<h3 id="fixing-incorrect-collate-or-ctype"><a class="header" href="#fixing-incorrect-collate-or-ctype">Fixing incorrect <code>COLLATE</code> or <code>CTYPE</code></a></h3>
<p>Synapse will refuse to set up a new database if it has the wrong values of
<code>COLLATE</code> and <code>CTYPE</code> set, and will log warnings on existing databases. Using
different locales can cause issues if the locale library is updated from
underneath the database, or if a different version of the locale is used on any
replicas.</p>
<p>The safest way to fix the issue is to take a dump and recreate the database with
the correct <code>COLLATE</code> and <code>CTYPE</code> parameters (as shown above). It is also possible to change the
parameters on a live database and run a <code>REINDEX</code> on the entire database,
however extreme care must be taken to avoid database corruption.</p>
<p>Note that the above may fail with an error about duplicate rows if corruption
has already occurred, and such duplicate rows will need to be manually removed.</p>
<h2 id="fixing-inconsistent-sequences-error"><a class="header" href="#fixing-inconsistent-sequences-error">Fixing inconsistent sequences error</a></h2>
<p>Synapse uses Postgres sequences to generate IDs for various tables. A sequence
and associated table can get out of sync if, for example, Synapse has been
downgraded and then upgraded again.</p>
<p>To fix the issue shut down Synapse (including any and all workers) and run the
SQL command included in the error message. Once done Synapse should start
successfully.</p>
<h2 id="tuning-postgres"><a class="header" href="#tuning-postgres">Tuning Postgres</a></h2>
<p>The default settings should be fine for most deployments. For larger
scale deployments tuning some of the settings is recommended, details of
which can be found at
<a href="https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server">https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server</a>.</p>
<p>In particular, we've found tuning the following values helpful for
performance:</p>
<ul>
<li><code>shared_buffers</code></li>
<li><code>effective_cache_size</code></li>
<li><code>work_mem</code></li>
<li><code>maintenance_work_mem</code></li>
<li><code>autovacuum_work_mem</code></li>
</ul>
<p>Note that the appropriate values for those fields depend on the amount
of free memory the database host has available.</p>
<h2 id="synapse-config"><a class="header" href="#synapse-config">Synapse config</a></h2>
<p>When you are ready to start using PostgreSQL, edit the <code>database</code>
section in your config file to match the following lines:</p>
<pre><code class="language-yaml">database:
  name: psycopg2
  args:
    user: &lt;user&gt;
    password: &lt;pass&gt;
    database: &lt;db&gt;
    host: &lt;host&gt;
    cp_min: 5
    cp_max: 10
</code></pre>
<p>All key, values in <code>args</code> are passed to the <code>psycopg2.connect(..)</code>
function, except keys beginning with <code>cp_</code>, which are consumed by the
twisted adbapi connection pool. See the <a href="https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-PARAMKEYWORDS">libpq
documentation</a>
for a list of options which can be passed.</p>
<p>You should consider tuning the <code>args.keepalives_*</code> options if there is any danger of
the connection between your homeserver and database dropping, otherwise Synapse
may block for an extended period while it waits for a response from the
database server. Example values might be:</p>
<pre><code class="language-yaml"># seconds of inactivity after which TCP should send a keepalive message to the server
keepalives_idle: 10

# the number of seconds after which a TCP keepalive message that is not
# acknowledged by the server should be retransmitted
keepalives_interval: 10

# the number of TCP keepalives that can be lost before the client's connection
# to the server is considered dead
keepalives_count: 3
</code></pre>
<h2 id="porting-from-sqlite"><a class="header" href="#porting-from-sqlite">Porting from SQLite</a></h2>
<h3 id="overview"><a class="header" href="#overview">Overview</a></h3>
<p>The script <code>synapse_port_db</code> allows porting an existing synapse server
backed by SQLite to using PostgreSQL. This is done in as a two phase
process:</p>
<ol>
<li>Copy the existing SQLite database to a separate location (while the
server is down) and running the port script against that offline
database.</li>
<li>Shut down the server. Rerun the port script to port any data that
has come in since taking the first snapshot. Restart server against
the PostgreSQL database.</li>
</ol>
<p>The port script is designed to be run repeatedly against newer snapshots
of the SQLite database file. This makes it safe to repeat step 1 if
there was a delay between taking the previous snapshot and being ready
to do step 2.</p>
<p>It is safe to at any time kill the port script and restart it.</p>
<p>Note that the database may take up significantly more (25% - 100% more)
space on disk after porting to Postgres.</p>
<h3 id="using-the-port-script"><a class="header" href="#using-the-port-script">Using the port script</a></h3>
<p>Firstly, shut down the currently running synapse server and copy its
database file (typically <code>homeserver.db</code>) to another location. Once the
copy is complete, restart synapse. For instance:</p>
<pre><code>./synctl stop
cp homeserver.db homeserver.db.snapshot
./synctl start
</code></pre>
<p>Copy the old config file into a new config file:</p>
<pre><code>cp homeserver.yaml homeserver-postgres.yaml
</code></pre>
<p>Edit the database section as described in the section <em>Synapse config</em>
above and with the SQLite snapshot located at <code>homeserver.db.snapshot</code>
simply run:</p>
<pre><code>synapse_port_db --sqlite-database homeserver.db.snapshot \
    --postgres-config homeserver-postgres.yaml
</code></pre>
<p>The flag <code>--curses</code> displays a coloured curses progress UI.</p>
<p>If the script took a long time to complete, or time has otherwise passed
since the original snapshot was taken, repeat the previous steps with a
newer snapshot.</p>
<p>To complete the conversion shut down the synapse server and run the port
script one last time, e.g. if the SQLite database is at <code>homeserver.db</code>
run:</p>
<pre><code>synapse_port_db --sqlite-database homeserver.db \
    --postgres-config homeserver-postgres.yaml
</code></pre>
<p>Once that has completed, change the synapse config to point at the
PostgreSQL database configuration file <code>homeserver-postgres.yaml</code>:</p>
<pre><code>./synctl stop
mv homeserver.yaml homeserver-old-sqlite.yaml
mv homeserver-postgres.yaml homeserver.yaml
./synctl start
</code></pre>
<p>Synapse should now be running against PostgreSQL.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="using-a-reverse-proxy-with-synapse"><a class="header" href="#using-a-reverse-proxy-with-synapse">Using a reverse proxy with Synapse</a></h1>
<p>It is recommended to put a reverse proxy such as
<a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html">nginx</a>,
<a href="https://httpd.apache.org/docs/current/mod/mod_proxy_http.html">Apache</a>,
<a href="https://caddyserver.com/docs/quick-starts/reverse-proxy">Caddy</a>,
<a href="https://www.haproxy.org/">HAProxy</a> or
<a href="https://man.openbsd.org/relayd.8">relayd</a> in front of Synapse. One advantage
of doing so is that it means that you can expose the default https port
(443) to Matrix clients without needing to run Synapse with root
privileges.</p>
<p>You should configure your reverse proxy to forward requests to <code>/_matrix</code> or
<code>/_synapse/client</code> to Synapse, and have it set the <code>X-Forwarded-For</code> and
<code>X-Forwarded-Proto</code> request headers.</p>
<p>You should remember that Matrix clients and other Matrix servers do not
necessarily need to connect to your server via the same server name or
port. Indeed, clients will use port 443 by default, whereas servers default to
port 8448. Where these are different, we refer to the 'client port' and the
'federation port'. See <a href="https://matrix.org/docs/spec/server_server/latest#resolving-server-names">the Matrix
specification</a>
for more details of the algorithm used for federation connections, and
<a href="setup/delegate.html">delegate.md</a> for instructions on setting up delegation.</p>
<p><strong>NOTE</strong>: Your reverse proxy must not <code>canonicalise</code> or <code>normalise</code>
the requested URI in any way (for example, by decoding <code>%xx</code> escapes).
Beware that Apache <em>will</em> canonicalise URIs unless you specify
<code>nocanon</code>.</p>
<p>Let's assume that we expect clients to connect to our server at
<code>https://matrix.example.com</code>, and other servers to connect at
<code>https://example.com:8448</code>.  The following sections detail the configuration of
the reverse proxy and the homeserver.</p>
<h2 id="reverse-proxy-configuration-examples"><a class="header" href="#reverse-proxy-configuration-examples">Reverse-proxy configuration examples</a></h2>
<p><strong>NOTE</strong>: You only need one of these.</p>
<h3 id="nginx"><a class="header" href="#nginx">nginx</a></h3>
<pre><code>server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # For the federation port
    listen 8448 ssl http2 default_server;
    listen [::]:8448 ssl http2 default_server;

    server_name matrix.example.com;

    location ~* ^(\/_matrix|\/_synapse\/client) {
        proxy_pass http://localhost:8008;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $host;

        # Nginx by default only allows file uploads up to 1M in size
        # Increase client_max_body_size to match max_upload_size defined in homeserver.yaml
        client_max_body_size 50M;
    }
}
</code></pre>
<p><strong>NOTE</strong>: Do not add a path after the port in <code>proxy_pass</code>, otherwise nginx will
canonicalise/normalise the URI.</p>
<h3 id="caddy-1"><a class="header" href="#caddy-1">Caddy 1</a></h3>
<pre><code>matrix.example.com {
  proxy /_matrix http://localhost:8008 {
    transparent
  }

  proxy /_synapse/client http://localhost:8008 {
    transparent
  }
}

example.com:8448 {
  proxy / http://localhost:8008 {
    transparent
  }
}
</code></pre>
<h3 id="caddy-2"><a class="header" href="#caddy-2">Caddy 2</a></h3>
<pre><code>matrix.example.com {
  reverse_proxy /_matrix/* http://localhost:8008
  reverse_proxy /_synapse/client/* http://localhost:8008
}

example.com:8448 {
  reverse_proxy http://localhost:8008
}
</code></pre>
<h3 id="apache"><a class="header" href="#apache">Apache</a></h3>
<pre><code>&lt;VirtualHost *:443&gt;
    SSLEngine on
    ServerName matrix.example.com

    RequestHeader set &quot;X-Forwarded-Proto&quot; expr=%{REQUEST_SCHEME}
    AllowEncodedSlashes NoDecode
    ProxyPreserveHost on
    ProxyPass /_matrix http://127.0.0.1:8008/_matrix nocanon
    ProxyPassReverse /_matrix http://127.0.0.1:8008/_matrix
    ProxyPass /_synapse/client http://127.0.0.1:8008/_synapse/client nocanon
    ProxyPassReverse /_synapse/client http://127.0.0.1:8008/_synapse/client
&lt;/VirtualHost&gt;

&lt;VirtualHost *:8448&gt;
    SSLEngine on
    ServerName example.com

    RequestHeader set &quot;X-Forwarded-Proto&quot; expr=%{REQUEST_SCHEME}
    AllowEncodedSlashes NoDecode
    ProxyPass /_matrix http://127.0.0.1:8008/_matrix nocanon
    ProxyPassReverse /_matrix http://127.0.0.1:8008/_matrix
&lt;/VirtualHost&gt;
</code></pre>
<p><strong>NOTE</strong>: ensure the  <code>nocanon</code> options are included.</p>
<p><strong>NOTE 2</strong>: It appears that Synapse is currently incompatible with the ModSecurity module for Apache (<code>mod_security2</code>). If you need it enabled for other services on your web server, you can disable it for Synapse's two VirtualHosts by including the following lines before each of the two <code>&lt;/VirtualHost&gt;</code> above:</p>
<pre><code>&lt;IfModule security2_module&gt;
    SecRuleEngine off
&lt;/IfModule&gt;
</code></pre>
<p><strong>NOTE 3</strong>: Missing <code>ProxyPreserveHost on</code> can lead to a redirect loop.</p>
<h3 id="haproxy"><a class="header" href="#haproxy">HAProxy</a></h3>
<pre><code>frontend https
  bind :::443 v4v6 ssl crt /etc/ssl/haproxy/ strict-sni alpn h2,http/1.1
  http-request set-header X-Forwarded-Proto https if { ssl_fc }
  http-request set-header X-Forwarded-Proto http if !{ ssl_fc }
  http-request set-header X-Forwarded-For %[src]

  # Matrix client traffic
  acl matrix-host hdr(host) -i matrix.example.com
  acl matrix-path path_beg /_matrix
  acl matrix-path path_beg /_synapse/client

  use_backend matrix if matrix-host matrix-path

frontend matrix-federation
  bind :::8448 v4v6 ssl crt /etc/ssl/haproxy/synapse.pem alpn h2,http/1.1
  http-request set-header X-Forwarded-Proto https if { ssl_fc }
  http-request set-header X-Forwarded-Proto http if !{ ssl_fc }
  http-request set-header X-Forwarded-For %[src]

  default_backend matrix

backend matrix
  server matrix 127.0.0.1:8008
</code></pre>
<h3 id="relayd"><a class="header" href="#relayd">Relayd</a></h3>
<pre><code>table &lt;webserver&gt;    { 127.0.0.1 }
table &lt;matrixserver&gt; { 127.0.0.1 }

http protocol &quot;https&quot; {
    tls { no tlsv1.0, ciphers &quot;HIGH&quot; }
    tls keypair &quot;example.com&quot;
    match header set &quot;X-Forwarded-For&quot;   value &quot;$REMOTE_ADDR&quot;
    match header set &quot;X-Forwarded-Proto&quot; value &quot;https&quot;

    # set CORS header for .well-known/matrix/server, .well-known/matrix/client
    # httpd does not support setting headers, so do it here
    match request path &quot;/.well-known/matrix/*&quot; tag &quot;matrix-cors&quot;
    match response tagged &quot;matrix-cors&quot; header set &quot;Access-Control-Allow-Origin&quot; value &quot;*&quot;

    pass quick path &quot;/_matrix/*&quot;         forward to &lt;matrixserver&gt;
    pass quick path &quot;/_synapse/client/*&quot; forward to &lt;matrixserver&gt;

    # pass on non-matrix traffic to webserver
    pass                                 forward to &lt;webserver&gt;
}

relay &quot;https_traffic&quot; {
    listen on egress port 443 tls
    protocol &quot;https&quot;
    forward to &lt;matrixserver&gt; port 8008 check tcp
    forward to &lt;webserver&gt;    port 8080 check tcp
}

http protocol &quot;matrix&quot; {
    tls { no tlsv1.0, ciphers &quot;HIGH&quot; }
    tls keypair &quot;example.com&quot;
    block
    pass quick path &quot;/_matrix/*&quot;         forward to &lt;matrixserver&gt;
    pass quick path &quot;/_synapse/client/*&quot; forward to &lt;matrixserver&gt;
}

relay &quot;matrix_federation&quot; {
    listen on egress port 8448 tls
    protocol &quot;matrix&quot;
    forward to &lt;matrixserver&gt; port 8008 check tcp
}
</code></pre>
<h2 id="homeserver-configuration"><a class="header" href="#homeserver-configuration">Homeserver Configuration</a></h2>
<p>You will also want to set <code>bind_addresses: ['127.0.0.1']</code> and
<code>x_forwarded: true</code> for port 8008 in <code>homeserver.yaml</code> to ensure that
client IP addresses are recorded correctly.</p>
<p>Having done so, you can then use <code>https://matrix.example.com</code> (instead
of <code>https://matrix.example.com:8448</code>) as the &quot;Custom server&quot; when
connecting to Synapse from a client.</p>
<h2 id="health-check-endpoint"><a class="header" href="#health-check-endpoint">Health check endpoint</a></h2>
<p>Synapse exposes a health check endpoint for use by reverse proxies.
Each configured HTTP listener has a <code>/health</code> endpoint which always returns
200 OK (and doesn't get logged).</p>
<h2 id="synapse-administration-endpoints"><a class="header" href="#synapse-administration-endpoints">Synapse administration endpoints</a></h2>
<p>Endpoints for administering your Synapse instance are placed under
<code>/_synapse/admin</code>. These require authentication through an access token of an
admin user. However as access to these endpoints grants the caller a lot of power,
we do not recommend exposing them to the public internet without good reason.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="configuring-a-turn-server"><a class="header" href="#configuring-a-turn-server">Configuring a Turn Server</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="delegation"><a class="header" href="#delegation">Delegation</a></h1>
<p>By default, other homeservers will expect to be able to reach yours via
your <code>server_name</code>, on port 8448. For example, if you set your <code>server_name</code>
to <code>example.com</code> (so that your user names look like <code>@user:example.com</code>),
other servers will try to connect to yours at <code>https://example.com:8448/</code>.</p>
<p>Delegation is a Matrix feature allowing a homeserver admin to retain a
<code>server_name</code> of <code>example.com</code> so that user IDs, room aliases, etc continue
to look like <code>*:example.com</code>, whilst having federation traffic routed
to a different server and/or port (e.g. <code>synapse.example.com:443</code>).</p>
<h2 id="well-known-delegation"><a class="header" href="#well-known-delegation">.well-known delegation</a></h2>
<p>To use this method, you need to be able to alter the
<code>server_name</code> 's https server to serve the <code>/.well-known/matrix/server</code>
URL. Having an active server (with a valid TLS certificate) serving your
<code>server_name</code> domain is out of the scope of this documentation.</p>
<p>The URL <code>https://&lt;server_name&gt;/.well-known/matrix/server</code> should
return a JSON structure containing the key <code>m.server</code> like so:</p>
<pre><code class="language-json">{
    &quot;m.server&quot;: &quot;&lt;synapse.server.name&gt;[:&lt;yourport&gt;]&quot;
}
</code></pre>
<p>In our example, this would mean that URL <code>https://example.com/.well-known/matrix/server</code>
should return:</p>
<pre><code class="language-json">{
    &quot;m.server&quot;: &quot;synapse.example.com:443&quot;
}
</code></pre>
<p>Note, specifying a port is optional. If no port is specified, then it defaults
to 8448.</p>
<p>With .well-known delegation, federating servers will check for a valid TLS
certificate for the delegated hostname (in our example: <code>synapse.example.com</code>).</p>
<h2 id="srv-dns-record-delegation"><a class="header" href="#srv-dns-record-delegation">SRV DNS record delegation</a></h2>
<p>It is also possible to do delegation using a SRV DNS record. However, that is
considered an advanced topic since it's a bit complex to set up, and <code>.well-known</code>
delegation is already enough in most cases.</p>
<p>However, if you really need it, you can find some documentation on how such a
record should look like and how Synapse will use it in <a href="https://matrix.org/docs/spec/server_server/latest#resolving-server-names">the Matrix
specification</a>.</p>
<h2 id="delegation-faq"><a class="header" href="#delegation-faq">Delegation FAQ</a></h2>
<h3 id="when-do-i-need-delegation"><a class="header" href="#when-do-i-need-delegation">When do I need delegation?</a></h3>
<p>If your homeserver's APIs are accessible on the default federation port (8448)
and the domain your <code>server_name</code> points to, you do not need any delegation.</p>
<p>For instance, if you registered <code>example.com</code> and pointed its DNS A record at a
fresh server, you could install Synapse on that host, giving it a <code>server_name</code>
of <code>example.com</code>, and once a reverse proxy has been set up to proxy all requests
sent to the port <code>8448</code> and serve TLS certificates for <code>example.com</code>, you
wouldn't need any delegation set up.</p>
<p><strong>However</strong>, if your homeserver's APIs aren't accessible on port 8448 and on the
domain <code>server_name</code> points to, you will need to let other servers know how to
find it using delegation.</p>
<h3 id="do-you-still-recommend-against-using-a-reverse-proxy-on-the-federation-port"><a class="header" href="#do-you-still-recommend-against-using-a-reverse-proxy-on-the-federation-port">Do you still recommend against using a reverse proxy on the federation port?</a></h3>
<p>We no longer actively recommend against using a reverse proxy. Many admins will
find it easier to direct federation traffic to a reverse proxy and manage their
own TLS certificates, and this is a supported configuration.</p>
<p>See <a href="setup/reverse_proxy.html">reverse_proxy.md</a> for information on setting up a
reverse proxy.</p>
<h3 id="do-i-still-need-to-give-my-tls-certificates-to-synapse-if-i-am-using-a-reverse-proxy"><a class="header" href="#do-i-still-need-to-give-my-tls-certificates-to-synapse-if-i-am-using-a-reverse-proxy">Do I still need to give my TLS certificates to Synapse if I am using a reverse proxy?</a></h3>
<p>This is no longer necessary. If you are using a reverse proxy for all of your
TLS traffic, then you can set <code>no_tls: True</code> in the Synapse config.</p>
<p>In that case, the only reason Synapse needs the certificate is to populate a legacy
<code>tls_fingerprints</code> field in the federation API. This is ignored by Synapse 0.99.0
and later, and the only time pre-0.99 Synapses will check it is when attempting to
fetch the server keys - and generally this is delegated via <code>matrix.org</code>, which
is running a modern version of Synapse.</p>
<h3 id="do-i-need-the-same-certificate-for-the-client-and-federation-port"><a class="header" href="#do-i-need-the-same-certificate-for-the-client-and-federation-port">Do I need the same certificate for the client and federation port?</a></h3>
<p>No. There is nothing stopping you from using different certificates,
particularly if you are using a reverse proxy.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="upgrading"><a class="header" href="#upgrading">Upgrading</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="usage"><a class="header" href="#usage">Usage</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="setting-up-federation"><a class="header" href="#setting-up-federation">Setting up federation</a></h1>
<p>Federation is the process by which users on different servers can participate
in the same room. For this to work, those other servers must be able to contact
yours to send messages.</p>
<p>The <code>server_name</code> configured in the Synapse configuration file (often
<code>homeserver.yaml</code>) defines how resources (users, rooms, etc.) will be
identified (eg: <code>@user:example.com</code>, <code>#room:example.com</code>). By default,
it is also the domain that other servers will use to try to reach your
server (via port 8448). This is easy to set up and will work provided
you set the <code>server_name</code> to match your machine's public DNS hostname.</p>
<p>For this default configuration to work, you will need to listen for TLS
connections on port 8448. The preferred way to do that is by using a
reverse proxy: see <a href="usage/reverse_proxy.html">reverse_proxy.md</a> for instructions
on how to correctly set one up.</p>
<p>In some cases you might not want to run Synapse on the machine that has
the <code>server_name</code> as its public DNS hostname, or you might want federation
traffic to use a different port than 8448. For example, you might want to
have your user names look like <code>@user:example.com</code>, but you want to run
Synapse on <code>synapse.example.com</code> on port 443. This can be done using
delegation, which allows an admin to control where federation traffic should
be sent. See <a href="usage/../setup/delegate.html">delegate.md</a> for instructions on how to set this up.</p>
<p>Once federation has been configured, you should be able to join a room over
federation. A good place to start is <code>#synapse:matrix.org</code> - a room for
Synapse admins.</p>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<p>You can use the <a href="https://matrix.org/federationtester">federation tester</a>
to check if your homeserver is configured correctly. Alternatively try the
<a href="https://matrix.org/federationtester/api/report?server_name=DOMAIN">JSON API used by the federation tester</a>.
Note that you'll have to modify this URL to replace <code>DOMAIN</code> with your
<code>server_name</code>. Hitting the API directly provides extra detail.</p>
<p>The typical failure mode for federation is that when the server tries to join
a room, it is rejected with &quot;401: Unauthorized&quot;. Generally this means that other
servers in the room could not access yours. (Joining a room over federation is
a complicated dance which requires connections in both directions).</p>
<p>Another common problem is that people on other servers can't join rooms that
you invite them to. This can be caused by an incorrectly-configured reverse
proxy: see <a href="usage/reverse_proxy.html">reverse_proxy.md</a> for instructions on how to correctly
configure a reverse proxy.</p>
<h3 id="known-issues"><a class="header" href="#known-issues">Known issues</a></h3>
<p><strong>HTTP <code>308 Permanent Redirect</code> redirects are not followed</strong>: Due to missing features
in the HTTP library used by Synapse, 308 redirects are currently not followed by
federating servers, which can cause <code>M_UNKNOWN</code> or <code>401 Unauthorized</code> errors. This
may affect users who are redirecting apex-to-www (e.g. <code>example.com</code> -&gt; <code>www.example.com</code>),
and especially users of the Kubernetes <em>Nginx Ingress</em> module, which uses 308 redirect
codes by default. For those Kubernetes users, <a href="https://stackoverflow.com/a/52617528/5096871">this Stackoverflow post</a> 
might be helpful. For other users, switching to a <code>301 Moved Permanently</code> code may be
an option. 308 redirect codes will be supported properly in a future
release of Synapse.</p>
<h2 id="running-a-demo-federation-of-synapses"><a class="header" href="#running-a-demo-federation-of-synapses">Running a demo federation of Synapses</a></h2>
<p>If you want to get up and running quickly with a trio of homeservers in a
private federation, there is a script in the <code>demo</code> directory. This is mainly
useful just for development purposes. See <a href="usage/../demo/README">demo/README</a>.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="sample-config"><a class="header" href="#sample-config">Sample Config</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="user-authentication"><a class="header" href="#user-authentication">User Authentication</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="configuring-synapse-to-authenticate-against-an-openid-connect-provider"><a class="header" href="#configuring-synapse-to-authenticate-against-an-openid-connect-provider">Configuring Synapse to authenticate against an OpenID Connect provider</a></h1>
<p>Synapse can be configured to use an OpenID Connect Provider (OP) for
authentication, instead of its own local password database.</p>
<p>Any OP should work with Synapse, as long as it supports the authorization code
flow. There are a few options for that:</p>
<ul>
<li>
<p>start a local OP. Synapse has been tested with <a href="https://www.ory.sh/docs/hydra/">Hydra</a> and
<a href="https://github.com/dexidp/dex">Dex</a>.  Note that for an OP to work, it should be served under a
secure (HTTPS) origin.  A certificate signed with a self-signed, locally
trusted CA should work. In that case, start Synapse with a <code>SSL_CERT_FILE</code>
environment variable set to the path of the CA.</p>
</li>
<li>
<p>set up a SaaS OP, like <a href="https://developers.google.com/identity/protocols/oauth2/openid-connect">Google</a>, <a href="https://auth0.com/">Auth0</a> or
<a href="https://www.okta.com/">Okta</a>. Synapse has been tested with Auth0 and Google.</p>
</li>
</ul>
<p>It may also be possible to use other OAuth2 providers which provide the
<a href="https://tools.ietf.org/html/rfc6749#section-4.1">authorization code grant type</a>,
such as <a href="https://developer.github.com/apps/building-oauth-apps/authorizing-oauth-apps">Github</a>.</p>
<h2 id="preparing-synapse"><a class="header" href="#preparing-synapse">Preparing Synapse</a></h2>
<p>The OpenID integration in Synapse uses the
<a href="https://pypi.org/project/Authlib/"><code>authlib</code></a> library, which must be installed
as follows:</p>
<ul>
<li>
<p>The relevant libraries are included in the Docker images and Debian packages
provided by <code>matrix.org</code> so no further action is needed.</p>
</li>
<li>
<p>If you installed Synapse into a virtualenv, run <code>/path/to/env/bin/pip install matrix-synapse[oidc]</code> to install the necessary dependencies.</p>
</li>
<li>
<p>For other installation mechanisms, see the documentation provided by the
maintainer.</p>
</li>
</ul>
<p>To enable the OpenID integration, you should then add a section to the <code>oidc_providers</code>
setting in your configuration file (or uncomment one of the existing examples).
See <a href="usage/configuration/user_authentication/../../../../docs/sample_config.yaml">sample_config.yaml</a> for some sample settings, as well as
the text below for example configurations for specific providers.</p>
<h2 id="sample-configs"><a class="header" href="#sample-configs">Sample configs</a></h2>
<p>Here are a few configs for providers that should work with Synapse.</p>
<h3 id="microsoft-azure-active-directory"><a class="header" href="#microsoft-azure-active-directory">Microsoft Azure Active Directory</a></h3>
<p>Azure AD can act as an OpenID Connect Provider. Register a new application under
<em>App registrations</em> in the Azure AD management console. The RedirectURI for your
application should point to your matrix server:
<code>[synapse public baseurl]/_synapse/client/oidc/callback</code></p>
<p>Go to <em>Certificates &amp; secrets</em> and register a new client secret. Make note of your
Directory (tenant) ID as it will be used in the Azure links.
Edit your Synapse config file and change the <code>oidc_config</code> section:</p>
<pre><code class="language-yaml">oidc_providers:
  - idp_id: microsoft
    idp_name: Microsoft
    issuer: &quot;https://login.microsoftonline.com/&lt;tenant id&gt;/v2.0&quot;
    client_id: &quot;&lt;client id&gt;&quot;
    client_secret: &quot;&lt;client secret&gt;&quot;
    scopes: [&quot;openid&quot;, &quot;profile&quot;]
    authorization_endpoint: &quot;https://login.microsoftonline.com/&lt;tenant id&gt;/oauth2/v2.0/authorize&quot;
    token_endpoint: &quot;https://login.microsoftonline.com/&lt;tenant id&gt;/oauth2/v2.0/token&quot;
    userinfo_endpoint: &quot;https://graph.microsoft.com/oidc/userinfo&quot;

    user_mapping_provider:
      config:
        localpart_template: &quot;{{ user.preferred_username.split('@')[0] }}&quot;
        display_name_template: &quot;{{ user.name }}&quot;
</code></pre>
<h3 id="a-hrefhttpsgithubcomdexidpdexdexa"><a class="header" href="#a-hrefhttpsgithubcomdexidpdexdexa"><a href="https://github.com/dexidp/dex">Dex</a></a></h3>
<p><a href="https://github.com/dexidp/dex">Dex</a> is a simple, open-source, certified OpenID Connect Provider.
Although it is designed to help building a full-blown provider with an
external database, it can be configured with static passwords in a config file.</p>
<p>Follow the <a href="https://dexidp.io/docs/getting-started/">Getting Started guide</a>
to install Dex.</p>
<p>Edit <code>examples/config-dev.yaml</code> config file from the Dex repo to add a client:</p>
<pre><code class="language-yaml">staticClients:
- id: synapse
  secret: secret
  redirectURIs:
  - '[synapse public baseurl]/_synapse/client/oidc/callback'
  name: 'Synapse'
</code></pre>
<p>Run with <code>dex serve examples/config-dev.yaml</code>.</p>
<p>Synapse config:</p>
<pre><code class="language-yaml">oidc_providers:
  - idp_id: dex
    idp_name: &quot;My Dex server&quot;
    skip_verification: true # This is needed as Dex is served on an insecure endpoint
    issuer: &quot;http://127.0.0.1:5556/dex&quot;
    client_id: &quot;synapse&quot;
    client_secret: &quot;secret&quot;
    scopes: [&quot;openid&quot;, &quot;profile&quot;]
    user_mapping_provider:
      config:
        localpart_template: &quot;{{ user.name }}&quot;
        display_name_template: &quot;{{ user.name|capitalize }}&quot;
</code></pre>
<h3 id="a-hrefhttpswwwkeycloakorgdocslatestserver_adminsso-protocolskeycloaka"><a class="header" href="#a-hrefhttpswwwkeycloakorgdocslatestserver_adminsso-protocolskeycloaka"><a href="https://www.keycloak.org/docs/latest/server_admin/#sso-protocols">Keycloak</a></a></h3>
<p><a href="https://www.keycloak.org/docs/latest/server_admin/#sso-protocols">Keycloak</a> is an opensource IdP maintained by Red Hat.</p>
<p>Follow the <a href="https://www.keycloak.org/getting-started">Getting Started Guide</a> to install Keycloak and set up a realm.</p>
<ol>
<li>
<p>Click <code>Clients</code> in the sidebar and click <code>Create</code></p>
</li>
<li>
<p>Fill in the fields as below:</p>
</li>
</ol>
<table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>
<tr><td>Client ID</td><td><code>synapse</code></td></tr>
<tr><td>Client Protocol</td><td><code>openid-connect</code></td></tr>
</tbody></table>
<ol start="3">
<li>Click <code>Save</code></li>
<li>Fill in the fields as below:</li>
</ol>
<table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>
<tr><td>Client ID</td><td><code>synapse</code></td></tr>
<tr><td>Enabled</td><td><code>On</code></td></tr>
<tr><td>Client Protocol</td><td><code>openid-connect</code></td></tr>
<tr><td>Access Type</td><td><code>confidential</code></td></tr>
<tr><td>Valid Redirect URIs</td><td><code>[synapse public baseurl]/_synapse/client/oidc/callback</code></td></tr>
</tbody></table>
<ol start="5">
<li>Click <code>Save</code></li>
<li>On the Credentials tab, update the fields:</li>
</ol>
<table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>
<tr><td>Client Authenticator</td><td><code>Client ID and Secret</code></td></tr>
</tbody></table>
<ol start="7">
<li>Click <code>Regenerate Secret</code></li>
<li>Copy Secret</li>
</ol>
<pre><code class="language-yaml">oidc_providers:
  - idp_id: keycloak
    idp_name: &quot;My KeyCloak server&quot;
    issuer: &quot;https://127.0.0.1:8443/auth/realms/{realm_name}&quot;
    client_id: &quot;synapse&quot;
    client_secret: &quot;copy secret generated from above&quot;
    scopes: [&quot;openid&quot;, &quot;profile&quot;]
    user_mapping_provider:
      config:
        localpart_template: &quot;{{ user.preferred_username }}&quot;
        display_name_template: &quot;{{ user.name }}&quot;
</code></pre>
<h3 id="a-hrefhttpsauth0comauth0a"><a class="header" href="#a-hrefhttpsauth0comauth0a"><a href="https://auth0.com/">Auth0</a></a></h3>
<ol>
<li>
<p>Create a regular web application for Synapse</p>
</li>
<li>
<p>Set the Allowed Callback URLs to <code>[synapse public baseurl]/_synapse/client/oidc/callback</code></p>
</li>
<li>
<p>Add a rule to add the <code>preferred_username</code> claim.</p>
<details>
 <summary>Code sample</summary>
<pre><code class="language-js">function addPersistenceAttribute(user, context, callback) {
  user.user_metadata = user.user_metadata || {};
  user.user_metadata.preferred_username = user.user_metadata.preferred_username || user.user_id;
  context.idToken.preferred_username = user.user_metadata.preferred_username;

  auth0.users.updateUserMetadata(user.user_id, user.user_metadata)
    .then(function(){
        callback(null, user, context);
    })
    .catch(function(err){
        callback(err);
    });
}
</code></pre>
</li>
</ol>
</details>
<p>Synapse config:</p>
<pre><code class="language-yaml">oidc_providers:
  - idp_id: auth0
    idp_name: Auth0
    issuer: &quot;https://your-tier.eu.auth0.com/&quot; # TO BE FILLED
    client_id: &quot;your-client-id&quot; # TO BE FILLED
    client_secret: &quot;your-client-secret&quot; # TO BE FILLED
    scopes: [&quot;openid&quot;, &quot;profile&quot;]
    user_mapping_provider:
      config:
        localpart_template: &quot;{{ user.preferred_username }}&quot;
        display_name_template: &quot;{{ user.name }}&quot;
</code></pre>
<h3 id="github"><a class="header" href="#github">GitHub</a></h3>
<p>GitHub is a bit special as it is not an OpenID Connect compliant provider, but
just a regular OAuth2 provider.</p>
<p>The <a href="https://developer.github.com/v3/users/#get-the-authenticated-user"><code>/user</code> API endpoint</a>
can be used to retrieve information on the authenticated user. As the Synapse
login mechanism needs an attribute to uniquely identify users, and that endpoint
does not return a <code>sub</code> property, an alternative <code>subject_claim</code> has to be set.</p>
<ol>
<li>Create a new OAuth application: https://github.com/settings/applications/new.</li>
<li>Set the callback URL to <code>[synapse public baseurl]/_synapse/client/oidc/callback</code>.</li>
</ol>
<p>Synapse config:</p>
<pre><code class="language-yaml">oidc_providers:
  - idp_id: github
    idp_name: Github
    idp_brand: &quot;github&quot;  # optional: styling hint for clients
    discover: false
    issuer: &quot;https://github.com/&quot;
    client_id: &quot;your-client-id&quot; # TO BE FILLED
    client_secret: &quot;your-client-secret&quot; # TO BE FILLED
    authorization_endpoint: &quot;https://github.com/login/oauth/authorize&quot;
    token_endpoint: &quot;https://github.com/login/oauth/access_token&quot;
    userinfo_endpoint: &quot;https://api.github.com/user&quot;
    scopes: [&quot;read:user&quot;]
    user_mapping_provider:
      config:
        subject_claim: &quot;id&quot;
        localpart_template: &quot;{{ user.login }}&quot;
        display_name_template: &quot;{{ user.name }}&quot;
</code></pre>
<h3 id="a-hrefhttpsdevelopersgooglecomidentityprotocolsoauth2openid-connectgooglea"><a class="header" href="#a-hrefhttpsdevelopersgooglecomidentityprotocolsoauth2openid-connectgooglea"><a href="https://developers.google.com/identity/protocols/oauth2/openid-connect">Google</a></a></h3>
<ol>
<li>Set up a project in the Google API Console (see
https://developers.google.com/identity/protocols/oauth2/openid-connect#appsetup).</li>
<li>add an &quot;OAuth Client ID&quot; for a Web Application under &quot;Credentials&quot;.</li>
<li>Copy the Client ID and Client Secret, and add the following to your synapse config:
<pre><code class="language-yaml">oidc_providers:
  - idp_id: google
    idp_name: Google
    idp_brand: &quot;google&quot;  # optional: styling hint for clients
    issuer: &quot;https://accounts.google.com/&quot;
    client_id: &quot;your-client-id&quot; # TO BE FILLED
    client_secret: &quot;your-client-secret&quot; # TO BE FILLED
    scopes: [&quot;openid&quot;, &quot;profile&quot;]
    user_mapping_provider:
      config:
        localpart_template: &quot;{{ user.given_name|lower }}&quot;
        display_name_template: &quot;{{ user.name }}&quot;
</code></pre>
</li>
<li>Back in the Google console, add this Authorized redirect URI: <code>[synapse public baseurl]/_synapse/client/oidc/callback</code>.</li>
</ol>
<h3 id="twitch"><a class="header" href="#twitch">Twitch</a></h3>
<ol>
<li>Setup a developer account on <a href="https://dev.twitch.tv/">Twitch</a></li>
<li>Obtain the OAuth 2.0 credentials by <a href="https://dev.twitch.tv/console/apps/">creating an app</a></li>
<li>Add this OAuth Redirect URL: <code>[synapse public baseurl]/_synapse/client/oidc/callback</code></li>
</ol>
<p>Synapse config:</p>
<pre><code class="language-yaml">oidc_providers:
  - idp_id: twitch
    idp_name: Twitch
    issuer: &quot;https://id.twitch.tv/oauth2/&quot;
    client_id: &quot;your-client-id&quot; # TO BE FILLED
    client_secret: &quot;your-client-secret&quot; # TO BE FILLED
    client_auth_method: &quot;client_secret_post&quot;
    user_mapping_provider:
      config:
        localpart_template: &quot;{{ user.preferred_username }}&quot;
        display_name_template: &quot;{{ user.name }}&quot;
</code></pre>
<h3 id="gitlab"><a class="header" href="#gitlab">GitLab</a></h3>
<ol>
<li>Create a <a href="https://gitlab.com/profile/applications">new application</a>.</li>
<li>Add the <code>read_user</code> and <code>openid</code> scopes.</li>
<li>Add this Callback URL: <code>[synapse public baseurl]/_synapse/client/oidc/callback</code></li>
</ol>
<p>Synapse config:</p>
<pre><code class="language-yaml">oidc_providers:
  - idp_id: gitlab
    idp_name: Gitlab
    idp_brand: &quot;gitlab&quot;  # optional: styling hint for clients
    issuer: &quot;https://gitlab.com/&quot;
    client_id: &quot;your-client-id&quot; # TO BE FILLED
    client_secret: &quot;your-client-secret&quot; # TO BE FILLED
    client_auth_method: &quot;client_secret_post&quot;
    scopes: [&quot;openid&quot;, &quot;read_user&quot;]
    user_profile_method: &quot;userinfo_endpoint&quot;
    user_mapping_provider:
      config:
        localpart_template: '{{ user.nickname }}'
        display_name_template: '{{ user.name }}'
</code></pre>
<h3 id="facebook"><a class="header" href="#facebook">Facebook</a></h3>
<p>Like Github, Facebook provide a custom OAuth2 API rather than an OIDC-compliant
one so requires a little more configuration.</p>
<ol start="0">
<li>You will need a Facebook developer account. You can register for one
<a href="https://developers.facebook.com/async/registration/">here</a>.</li>
<li>On the <a href="https://developers.facebook.com/apps/">apps</a> page of the developer
console, &quot;Create App&quot;, and choose &quot;Build Connected Experiences&quot;.</li>
<li>Once the app is created, add &quot;Facebook Login&quot; and choose &quot;Web&quot;. You don't
need to go through the whole form here.</li>
<li>In the left-hand menu, open &quot;Products&quot;/&quot;Facebook Login&quot;/&quot;Settings&quot;.
<ul>
<li>Add <code>[synapse public baseurl]/_synapse/client/oidc/callback</code> as an OAuth Redirect
URL.</li>
</ul>
</li>
<li>In the left-hand menu, open &quot;Settings/Basic&quot;. Here you can copy the &quot;App ID&quot;
and &quot;App Secret&quot; for use below.</li>
</ol>
<p>Synapse config:</p>
<pre><code class="language-yaml">  - idp_id: facebook
    idp_name: Facebook
    idp_brand: &quot;facebook&quot;  # optional: styling hint for clients
    discover: false
    issuer: &quot;https://facebook.com&quot;
    client_id: &quot;your-client-id&quot; # TO BE FILLED
    client_secret: &quot;your-client-secret&quot; # TO BE FILLED
    scopes: [&quot;openid&quot;, &quot;email&quot;]
    authorization_endpoint: https://facebook.com/dialog/oauth
    token_endpoint: https://graph.facebook.com/v9.0/oauth/access_token
    user_profile_method: &quot;userinfo_endpoint&quot;
    userinfo_endpoint: &quot;https://graph.facebook.com/v9.0/me?fields=id,name,email,picture&quot;
    user_mapping_provider:
      config:
        subject_claim: &quot;id&quot;
        display_name_template: &quot;{{ user.name }}&quot;
</code></pre>
<p>Relevant documents:</p>
<ul>
<li>https://developers.facebook.com/docs/facebook-login/manually-build-a-login-flow</li>
<li>Using Facebook's Graph API: https://developers.facebook.com/docs/graph-api/using-graph-api/</li>
<li>Reference to the User endpoint: https://developers.facebook.com/docs/graph-api/reference/user</li>
</ul>
<h3 id="gitea"><a class="header" href="#gitea">Gitea</a></h3>
<p>Gitea is, like Github, not an OpenID provider, but just an OAuth2 provider.</p>
<p>The <a href="https://try.gitea.io/api/swagger#/user/userGetCurrent"><code>/user</code> API endpoint</a>
can be used to retrieve information on the authenticated user. As the Synapse
login mechanism needs an attribute to uniquely identify users, and that endpoint
does not return a <code>sub</code> property, an alternative <code>subject_claim</code> has to be set.</p>
<ol>
<li>Create a new application.</li>
<li>Add this Callback URL: <code>[synapse public baseurl]/_synapse/client/oidc/callback</code></li>
</ol>
<p>Synapse config:</p>
<pre><code class="language-yaml">oidc_providers:
  - idp_id: gitea
    idp_name: Gitea
    discover: false
    issuer: &quot;https://your-gitea.com/&quot;
    client_id: &quot;your-client-id&quot; # TO BE FILLED
    client_secret: &quot;your-client-secret&quot; # TO BE FILLED
    client_auth_method: client_secret_post
    scopes: [] # Gitea doesn't support Scopes
    authorization_endpoint: &quot;https://your-gitea.com/login/oauth/authorize&quot;
    token_endpoint: &quot;https://your-gitea.com/login/oauth/access_token&quot;
    userinfo_endpoint: &quot;https://your-gitea.com/api/v1/user&quot;
    user_mapping_provider:
      config:
        subject_claim: &quot;id&quot;
        localpart_template: &quot;{{ user.login }}&quot;
        display_name_template: &quot;{{ user.full_name }}&quot;
</code></pre>
<h3 id="xwiki"><a class="header" href="#xwiki">XWiki</a></h3>
<p>Install <a href="https://extensions.xwiki.org/xwiki/bin/view/Extension/OpenID%20Connect/OpenID%20Connect%20Provider/">OpenID Connect Provider</a> extension in your <a href="https://www.xwiki.org">XWiki</a> instance.</p>
<p>Synapse config:</p>
<pre><code class="language-yaml">oidc_providers:
  - idp_id: xwiki
    idp_name: &quot;XWiki&quot;
    issuer: &quot;https://myxwikihost/xwiki/oidc/&quot;
    client_id: &quot;your-client-id&quot; # TO BE FILLED
    client_auth_method: none
    scopes: [&quot;openid&quot;, &quot;profile&quot;]
    user_profile_method: &quot;userinfo_endpoint&quot;
    user_mapping_provider:
      config:
        localpart_template: &quot;{{ user.preferred_username }}&quot;
        display_name_template: &quot;{{ user.name }}&quot;
</code></pre>
<h2 id="apple"><a class="header" href="#apple">Apple</a></h2>
<p>Configuring &quot;Sign in with Apple&quot; (SiWA) requires an Apple Developer account.</p>
<p>You will need to create a new &quot;Services ID&quot; for SiWA, and create and download a
private key with &quot;SiWA&quot; enabled.</p>
<p>As well as the private key file, you will need:</p>
<ul>
<li>Client ID: the &quot;identifier&quot; you gave the &quot;Services ID&quot;</li>
<li>Team ID: a 10-character ID associated with your developer account.</li>
<li>Key ID: the 10-character identifier for the key.</li>
</ul>
<p>https://help.apple.com/developer-account/?lang=en#/dev77c875b7e has more
documentation on setting up SiWA.</p>
<p>The synapse config will look like this:</p>
<pre><code class="language-yaml">  - idp_id: apple
    idp_name: Apple
    issuer: &quot;https://appleid.apple.com&quot;
    client_id: &quot;your-client-id&quot; # Set to the &quot;identifier&quot; for your &quot;ServicesID&quot;
    client_auth_method: &quot;client_secret_post&quot;
    client_secret_jwt_key:
      key_file: &quot;/path/to/AuthKey_KEYIDCODE.p8&quot;  # point to your key file
      jwt_header:
        alg: ES256
        kid: &quot;KEYIDCODE&quot;   # Set to the 10-char Key ID
      jwt_payload:
        iss: TEAMIDCODE    # Set to the 10-char Team ID
    scopes: [&quot;name&quot;, &quot;email&quot;, &quot;openid&quot;]
    authorization_endpoint: https://appleid.apple.com/auth/authorize?response_mode=form_post
    user_mapping_provider:
      config:
        email_template: &quot;{{ user.email }}&quot;
</code></pre>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="sso-mapping-providers"><a class="header" href="#sso-mapping-providers">SSO Mapping Providers</a></h1>
<p>A mapping provider is a Python class (loaded via a Python module) that
works out how to map attributes of a SSO response to Matrix-specific
user attributes. Details such as user ID localpart, displayname, and even avatar
URLs are all things that can be mapped from talking to a SSO service.</p>
<p>As an example, a SSO service may return the email address
&quot;john.smith@example.com&quot; for a user, whereas Synapse will need to figure out how
to turn that into a displayname when creating a Matrix user for this individual.
It may choose <code>John Smith</code>, or <code>Smith, John [Example.com]</code> or any number of
variations. As each Synapse configuration may want something different, this is
where SAML mapping providers come into play.</p>
<p>SSO mapping providers are currently supported for OpenID and SAML SSO
configurations. Please see the details below for how to implement your own.</p>
<p>It is up to the mapping provider whether the user should be assigned a predefined
Matrix ID based on the SSO attributes, or if the user should be allowed to
choose their own username.</p>
<p>In the first case - where users are automatically allocated a Matrix ID - it is
the responsibility of the mapping provider to normalise the SSO attributes and
map them to a valid Matrix ID. The <a href="https://matrix.org/docs/spec/appendices#user-identifiers">specification for Matrix
IDs</a> has some
information about what is considered valid.</p>
<p>If the mapping provider does not assign a Matrix ID, then Synapse will
automatically serve an HTML page allowing the user to pick their own username.</p>
<p>External mapping providers are provided to Synapse in the form of an external
Python module. You can retrieve this module from <a href="https://pypi.org">PyPI</a> or elsewhere,
but it must be importable via Synapse (e.g. it must be in the same virtualenv
as Synapse). The Synapse config is then modified to point to the mapping provider
(and optionally provide additional configuration for it).</p>
<h2 id="openid-mapping-providers"><a class="header" href="#openid-mapping-providers">OpenID Mapping Providers</a></h2>
<p>The OpenID mapping provider can be customized by editing the
<code>oidc_config.user_mapping_provider.module</code> config option.</p>
<p><code>oidc_config.user_mapping_provider.config</code> allows you to provide custom
configuration options to the module. Check with the module's documentation for
what options it provides (if any). The options listed by default are for the
user mapping provider built in to Synapse. If using a custom module, you should
comment these options out and use those specified by the module instead.</p>
<h3 id="building-a-custom-openid-mapping-provider"><a class="header" href="#building-a-custom-openid-mapping-provider">Building a Custom OpenID Mapping Provider</a></h3>
<p>A custom mapping provider must specify the following methods:</p>
<ul>
<li><code>__init__(self, parsed_config)</code>
<ul>
<li>Arguments:
<ul>
<li><code>parsed_config</code> - A configuration object that is the return value of the
<code>parse_config</code> method. You should set any configuration options needed by
the module here.</li>
</ul>
</li>
</ul>
</li>
<li><code>parse_config(config)</code>
<ul>
<li>This method should have the <code>@staticmethod</code> decoration.</li>
<li>Arguments:
<ul>
<li><code>config</code> - A <code>dict</code> representing the parsed content of the
<code>oidc_config.user_mapping_provider.config</code> homeserver config option.
Runs on homeserver startup. Providers should extract and validate
any option values they need here.</li>
</ul>
</li>
<li>Whatever is returned will be passed back to the user mapping provider module's
<code>__init__</code> method during construction.</li>
</ul>
</li>
<li><code>get_remote_user_id(self, userinfo)</code>
<ul>
<li>Arguments:
<ul>
<li><code>userinfo</code> - A <code>authlib.oidc.core.claims.UserInfo</code> object to extract user
information from.</li>
</ul>
</li>
<li>This method must return a string, which is the unique identifier for the
user. Commonly the <code>sub</code> claim of the response.</li>
</ul>
</li>
<li><code>map_user_attributes(self, userinfo, token, failures)</code>
<ul>
<li>This method must be async.</li>
<li>Arguments:
<ul>
<li><code>userinfo</code> - A <code>authlib.oidc.core.claims.UserInfo</code> object to extract user
information from.</li>
<li><code>token</code> - A dictionary which includes information necessary to make
further requests to the OpenID provider.</li>
<li><code>failures</code> - An <code>int</code> that represents the amount of times the returned
mxid localpart mapping has failed.  This should be used
to create a deduplicated mxid localpart which should be
returned instead. For example, if this method returns
<code>john.doe</code> as the value of <code>localpart</code> in the returned
dict, and that is already taken on the homeserver, this
method will be called again with the same parameters but
with failures=1. The method should then return a different
<code>localpart</code> value, such as <code>john.doe1</code>.</li>
</ul>
</li>
<li>Returns a dictionary with two keys:
<ul>
<li><code>localpart</code>: A string, used to generate the Matrix ID. If this is
<code>None</code>, the user is prompted to pick their own username.</li>
<li><code>displayname</code>: An optional string, the display name for the user.</li>
</ul>
</li>
</ul>
</li>
<li><code>get_extra_attributes(self, userinfo, token)</code>
<ul>
<li>
<p>This method must be async.</p>
</li>
<li>
<p>Arguments:</p>
<ul>
<li><code>userinfo</code> - A <code>authlib.oidc.core.claims.UserInfo</code> object to extract user
information from.</li>
<li><code>token</code> - A dictionary which includes information necessary to make
further requests to the OpenID provider.</li>
</ul>
</li>
<li>
<p>Returns a dictionary that is suitable to be serialized to JSON. This
will be returned as part of the response during a successful login.</p>
<p>Note that care should be taken to not overwrite any of the parameters
usually returned as part of the <a href="https://matrix.org/docs/spec/client_server/latest#post-matrix-client-r0-login">login response</a>.</p>
</li>
</ul>
</li>
</ul>
<h3 id="default-openid-mapping-provider"><a class="header" href="#default-openid-mapping-provider">Default OpenID Mapping Provider</a></h3>
<p>Synapse has a built-in OpenID mapping provider if a custom provider isn't
specified in the config. It is located at
<a href="usage/configuration/user_authentication/../../../../synapse/handlers/oidc.py"><code>synapse.handlers.oidc.JinjaOidcMappingProvider</code></a>.</p>
<h2 id="saml-mapping-providers"><a class="header" href="#saml-mapping-providers">SAML Mapping Providers</a></h2>
<p>The SAML mapping provider can be customized by editing the
<code>saml2_config.user_mapping_provider.module</code> config option.</p>
<p><code>saml2_config.user_mapping_provider.config</code> allows you to provide custom
configuration options to the module. Check with the module's documentation for
what options it provides (if any). The options listed by default are for the
user mapping provider built in to Synapse. If using a custom module, you should
comment these options out and use those specified by the module instead.</p>
<h3 id="building-a-custom-saml-mapping-provider"><a class="header" href="#building-a-custom-saml-mapping-provider">Building a Custom SAML Mapping Provider</a></h3>
<p>A custom mapping provider must specify the following methods:</p>
<ul>
<li><code>__init__(self, parsed_config, module_api)</code>
<ul>
<li>Arguments:
<ul>
<li><code>parsed_config</code> - A configuration object that is the return value of the
<code>parse_config</code> method. You should set any configuration options needed by
the module here.</li>
<li><code>module_api</code> - a <code>synapse.module_api.ModuleApi</code> object which provides the
stable API available for extension modules.</li>
</ul>
</li>
</ul>
</li>
<li><code>parse_config(config)</code>
<ul>
<li>This method should have the <code>@staticmethod</code> decoration.</li>
<li>Arguments:
<ul>
<li><code>config</code> - A <code>dict</code> representing the parsed content of the
<code>saml_config.user_mapping_provider.config</code> homeserver config option.
Runs on homeserver startup. Providers should extract and validate
any option values they need here.</li>
</ul>
</li>
<li>Whatever is returned will be passed back to the user mapping provider module's
<code>__init__</code> method during construction.</li>
</ul>
</li>
<li><code>get_saml_attributes(config)</code>
<ul>
<li>This method should have the <code>@staticmethod</code> decoration.</li>
<li>Arguments:
<ul>
<li><code>config</code> - A object resulting from a call to <code>parse_config</code>.</li>
</ul>
</li>
<li>Returns a tuple of two sets. The first set equates to the SAML auth
response attributes that are required for the module to function, whereas
the second set consists of those attributes which can be used if available,
but are not necessary.</li>
</ul>
</li>
<li><code>get_remote_user_id(self, saml_response, client_redirect_url)</code>
<ul>
<li>Arguments:
<ul>
<li><code>saml_response</code> - A <code>saml2.response.AuthnResponse</code> object to extract user
information from.</li>
<li><code>client_redirect_url</code> - A string, the URL that the client will be
redirected to.</li>
</ul>
</li>
<li>This method must return a string, which is the unique identifier for the
user. Commonly the <code>uid</code> claim of the response.</li>
</ul>
</li>
<li><code>saml_response_to_user_attributes(self, saml_response, failures, client_redirect_url)</code>
<ul>
<li>
<p>Arguments:</p>
<ul>
<li><code>saml_response</code> - A <code>saml2.response.AuthnResponse</code> object to extract user
information from.</li>
<li><code>failures</code> - An <code>int</code> that represents the amount of times the returned
mxid localpart mapping has failed.  This should be used
to create a deduplicated mxid localpart which should be
returned instead. For example, if this method returns
<code>john.doe</code> as the value of <code>mxid_localpart</code> in the returned
dict, and that is already taken on the homeserver, this
method will be called again with the same parameters but
with failures=1. The method should then return a different
<code>mxid_localpart</code> value, such as <code>john.doe1</code>.</li>
<li><code>client_redirect_url</code> - A string, the URL that the client will be
redirected to.</li>
</ul>
</li>
<li>
<p>This method must return a dictionary, which will then be used by Synapse
to build a new user. The following keys are allowed:</p>
<ul>
<li><code>mxid_localpart</code> - The mxid localpart of the new user.  If this is
<code>None</code>, the user is prompted to pick their own username.</li>
<li><code>displayname</code> - The displayname of the new user. If not provided, will default to
the value of <code>mxid_localpart</code>.</li>
<li><code>emails</code> - A list of emails for the new user. If not provided, will
default to an empty list.</li>
</ul>
<p>Alternatively it can raise a <code>synapse.api.errors.RedirectException</code> to
redirect the user to another page. This is useful to prompt the user for
additional information, e.g. if you want them to provide their own username.
It is the responsibility of the mapping provider to either redirect back
to <code>client_redirect_url</code> (including any additional information) or to
complete registration using methods from the <code>ModuleApi</code>.</p>
</li>
</ul>
</li>
</ul>
<h3 id="default-saml-mapping-provider"><a class="header" href="#default-saml-mapping-provider">Default SAML Mapping Provider</a></h3>
<p>Synapse has a built-in SAML mapping provider if a custom provider isn't
specified in the config. It is located at
<a href="usage/configuration/user_authentication/../../../../synapse/handlers/saml.py"><code>synapse.handlers.saml.DefaultSamlMappingProvider</code></a>.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="password-auth-provider-modules"><a class="header" href="#password-auth-provider-modules">Password auth provider modules</a></h1>
<p>Password auth providers offer a way for server administrators to
integrate their Synapse installation with an existing authentication
system.</p>
<p>A password auth provider is a Python class which is dynamically loaded
into Synapse, and provides a number of methods by which it can integrate
with the authentication system.</p>
<p>This document serves as a reference for those looking to implement their
own password auth providers. Additionally, here is a list of known
password auth provider module implementations:</p>
<ul>
<li><a href="https://github.com/matrix-org/matrix-synapse-ldap3/">matrix-synapse-ldap3</a></li>
<li><a href="https://github.com/devture/matrix-synapse-shared-secret-auth">matrix-synapse-shared-secret-auth</a></li>
<li><a href="https://github.com/ma1uta/matrix-synapse-rest-password-provider">matrix-synapse-rest-password-provider</a></li>
</ul>
<h2 id="required-methods"><a class="header" href="#required-methods">Required methods</a></h2>
<p>Password auth provider classes must provide the following methods:</p>
<ul>
<li>
<p><code>parse_config(config)</code>
This method is passed the <code>config</code> object for this module from the
homeserver configuration file.</p>
<p>It should perform any appropriate sanity checks on the provided
configuration, and return an object which is then passed into
<code>__init__</code>.</p>
<p>This method should have the <code>@staticmethod</code> decoration.</p>
</li>
<li>
<p><code>__init__(self, config, account_handler)</code></p>
<p>The constructor is passed the config object returned by
<code>parse_config</code>, and a <code>synapse.module_api.ModuleApi</code> object which
allows the password provider to check if accounts exist and/or create
new ones.</p>
</li>
</ul>
<h2 id="optional-methods"><a class="header" href="#optional-methods">Optional methods</a></h2>
<p>Password auth provider classes may optionally provide the following methods:</p>
<ul>
<li>
<p><code>get_db_schema_files(self)</code></p>
<p>This method, if implemented, should return an Iterable of
<code>(name, stream)</code> pairs of database schema files. Each file is applied
in turn at initialisation, and a record is then made in the database
so that it is not re-applied on the next start.</p>
</li>
<li>
<p><code>get_supported_login_types(self)</code></p>
<p>This method, if implemented, should return a <code>dict</code> mapping from a
login type identifier (such as <code>m.login.password</code>) to an iterable
giving the fields which must be provided by the user in the submission
to <a href="https://matrix.org/docs/spec/client_server/latest#post-matrix-client-r0-login">the <code>/login</code> API</a>.
These fields are passed in the <code>login_dict</code> dictionary to <code>check_auth</code>.</p>
<p>For example, if a password auth provider wants to implement a custom
login type of <code>com.example.custom_login</code>, where the client is expected
to pass the fields <code>secret1</code> and <code>secret2</code>, the provider should
implement this method and return the following dict:</p>
<pre><code class="language-python">{&quot;com.example.custom_login&quot;: (&quot;secret1&quot;, &quot;secret2&quot;)}
</code></pre>
</li>
<li>
<p><code>check_auth(self, username, login_type, login_dict)</code></p>
<p>This method does the real work. If implemented, it
will be called for each login attempt where the login type matches one
of the keys returned by <code>get_supported_login_types</code>.</p>
<p>It is passed the (possibly unqualified) <code>user</code> field provided by the client,
the login type, and a dictionary of login secrets passed by the
client.</p>
<p>The method should return an <code>Awaitable</code> object, which resolves
to the canonical <code>@localpart:domain</code> user ID if authentication is
successful, and <code>None</code> if not.</p>
<p>Alternatively, the <code>Awaitable</code> can resolve to a <code>(str, func)</code> tuple, in
which case the second field is a callback which will be called with
the result from the <code>/login</code> call (including <code>access_token</code>,
<code>device_id</code>, etc.)</p>
</li>
<li>
<p><code>check_3pid_auth(self, medium, address, password)</code></p>
<p>This method, if implemented, is called when a user attempts to
register or log in with a third party identifier, such as email. It is
passed the medium (ex. &quot;email&quot;), an address (ex.
&quot;<a href="mailto:usage/configuration/user_authentication/jdoe@example.com">jdoe@example.com</a>&quot;) and the user's password.</p>
<p>The method should return an <code>Awaitable</code> object, which resolves
to a <code>str</code> containing the user's (canonical) User id if
authentication was successful, and <code>None</code> if not.</p>
<p>As with <code>check_auth</code>, the <code>Awaitable</code> may alternatively resolve to a
<code>(user_id, callback)</code> tuple.</p>
</li>
<li>
<p><code>check_password(self, user_id, password)</code></p>
<p>This method provides a simpler interface than
<code>get_supported_login_types</code> and <code>check_auth</code> for password auth
providers that just want to provide a mechanism for validating
<code>m.login.password</code> logins.</p>
<p>If implemented, it will be called to check logins with an
<code>m.login.password</code> login type. It is passed a qualified
<code>@localpart:domain</code> user id, and the password provided by the user.</p>
<p>The method should return an <code>Awaitable</code> object, which resolves
to <code>True</code> if authentication is successful, and <code>False</code> if not.</p>
</li>
<li>
<p><code>on_logged_out(self, user_id, device_id, access_token)</code></p>
<p>This method, if implemented, is called when a user logs out. It is
passed the qualified user ID, the ID of the deactivated device (if
any: access tokens are occasionally created without an associated
device ID), and the (now deactivated) access token.</p>
<p>It may return an <code>Awaitable</code> object; the logout request will
wait for the <code>Awaitable</code> to complete, but the result is ignored.</p>
</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="jwt-login-type"><a class="header" href="#jwt-login-type">JWT Login Type</a></h1>
<p>Synapse comes with a non-standard login type to support
<a href="https://en.wikipedia.org/wiki/JSON_Web_Token">JSON Web Tokens</a>. In general the
documentation for
<a href="https://matrix.org/docs/spec/client_server/r0.6.1#login">the login endpoint</a>
is still valid (and the mechanism works similarly to the
<a href="https://matrix.org/docs/spec/client_server/r0.6.1#token-based">token based login</a>).</p>
<p>To log in using a JSON Web Token, clients should submit a <code>/login</code> request as
follows:</p>
<pre><code class="language-json">{
  &quot;type&quot;: &quot;org.matrix.login.jwt&quot;,
  &quot;token&quot;: &quot;&lt;jwt&gt;&quot;
}
</code></pre>
<p>Note that the login type of <code>m.login.jwt</code> is supported, but is deprecated. This
will be removed in a future version of Synapse.</p>
<p>The <code>token</code> field should include the JSON web token with the following claims:</p>
<ul>
<li>The <code>sub</code> (subject) claim is required and should encode the local part of the
user ID.</li>
<li>The expiration time (<code>exp</code>), not before time (<code>nbf</code>), and issued at (<code>iat</code>)
claims are optional, but validated if present.</li>
<li>The issuer (<code>iss</code>) claim is optional, but required and validated if configured.</li>
<li>The audience (<code>aud</code>) claim is optional, but required and validated if configured.
Providing the audience claim when not configured will cause validation to fail.</li>
</ul>
<p>In the case that the token is not valid, the homeserver must respond with
<code>403 Forbidden</code> and an error code of <code>M_FORBIDDEN</code>.</p>
<p>As with other login types, there are additional fields (e.g. <code>device_id</code> and
<code>initial_device_display_name</code>) which can be included in the above request.</p>
<h2 id="preparing-synapse-1"><a class="header" href="#preparing-synapse-1">Preparing Synapse</a></h2>
<p>The JSON Web Token integration in Synapse uses the
<a href="https://pypi.org/project/pyjwt/"><code>PyJWT</code></a> library, which must be installed
as follows:</p>
<ul>
<li>
<p>The relevant libraries are included in the Docker images and Debian packages
provided by <code>matrix.org</code> so no further action is needed.</p>
</li>
<li>
<p>If you installed Synapse into a virtualenv, run <code>/path/to/env/bin/pip install synapse[pyjwt]</code> to install the necessary dependencies.</p>
</li>
<li>
<p>For other installation mechanisms, see the documentation provided by the
maintainer.</p>
</li>
</ul>
<p>To enable the JSON web token integration, you should then add an <code>jwt_config</code> section
to your configuration file (or uncomment the <code>enabled: true</code> line in the
existing section). See <a href="usage/configuration/user_authentication/../../../../docs/sample_config.yaml">sample_config.yaml</a> for some
sample settings.</p>
<h2 id="how-to-test-jwt-as-a-developer"><a class="header" href="#how-to-test-jwt-as-a-developer">How to test JWT as a developer</a></h2>
<p>Although JSON Web Tokens are typically generated from an external server, the
examples below use <a href="https://pyjwt.readthedocs.io/en/latest/">PyJWT</a> directly.</p>
<ol>
<li>
<p>Configure Synapse with JWT logins, note that this example uses a pre-shared
secret and an algorithm of HS256:</p>
<pre><code class="language-yaml">jwt_config:
    enabled: true
    secret: &quot;my-secret-token&quot;
    algorithm: &quot;HS256&quot;
</code></pre>
</li>
<li>
<p>Generate a JSON web token:</p>
<pre><code class="language-bash">$ pyjwt --key=my-secret-token --alg=HS256 encode sub=test-user
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0LXVzZXIifQ.Ag71GT8v01UO3w80aqRPTeuVPBIBZkYhNTJJ-_-zQIc
</code></pre>
</li>
<li>
<p>Query for the login types and ensure <code>org.matrix.login.jwt</code> is there:</p>
<pre><code class="language-bash">curl http://localhost:8080/_matrix/client/r0/login
</code></pre>
</li>
<li>
<p>Login used the generated JSON web token from above:</p>
<pre><code class="language-bash">$ curl http://localhost:8082/_matrix/client/r0/login -X POST \
    --data '{&quot;type&quot;:&quot;org.matrix.login.jwt&quot;,&quot;token&quot;:&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0LXVzZXIifQ.Ag71GT8v01UO3w80aqRPTeuVPBIBZkYhNTJJ-_-zQIc&quot;}'
{
    &quot;access_token&quot;: &quot;&lt;access token&gt;&quot;,
    &quot;device_id&quot;: &quot;ACBDEFGHI&quot;,
    &quot;home_server&quot;: &quot;localhost:8080&quot;,
    &quot;user_id&quot;: &quot;@test-user:localhost:8480&quot;
}
</code></pre>
</li>
</ol>
<p>You should now be able to use the returned access token to query the client API.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="overview-1"><a class="header" href="#overview-1">Overview</a></h1>
<p>Captcha can be enabled for this home server. This file explains how to do that.
The captcha mechanism used is Google's ReCaptcha. This requires API keys from Google.</p>
<h2 id="getting-keys"><a class="header" href="#getting-keys">Getting keys</a></h2>
<p>Requires a site/secret key pair from:</p>
<p><a href="https://developers.google.com/recaptcha/">https://developers.google.com/recaptcha/</a></p>
<p>Must be a reCAPTCHA v2 key using the &quot;I'm not a robot&quot; Checkbox option</p>
<h2 id="setting-recaptcha-keys"><a class="header" href="#setting-recaptcha-keys">Setting ReCaptcha Keys</a></h2>
<p>The keys are a config option on the home server config. If they are not
visible, you can generate them via <code>--generate-config</code>. Set the following value:</p>
<pre><code>recaptcha_public_key: YOUR_SITE_KEY
recaptcha_private_key: YOUR_SECRET_KEY
</code></pre>
<p>In addition, you MUST enable captchas via:</p>
<pre><code>enable_registration_captcha: true
</code></pre>
<h2 id="configuring-ip-used-for-auth"><a class="header" href="#configuring-ip-used-for-auth">Configuring IP used for auth</a></h2>
<p>The ReCaptcha API requires that the IP address of the user who solved the
captcha is sent. If the client is connecting through a proxy or load balancer,
it may be required to use the <code>X-Forwarded-For</code> (XFF) header instead of the origin
IP address. This can be configured using the <code>x_forwarded</code> directive in the
listeners section of the homeserver.yaml configuration file.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="registering-an-application-service"><a class="header" href="#registering-an-application-service">Registering an Application Service</a></h1>
<p>The registration of new application services depends on the homeserver used. 
In synapse, you need to create a new configuration file for your AS and add it
to the list specified under the <code>app_service_config_files</code> config
option in your synapse config.</p>
<p>For example:</p>
<pre><code class="language-yaml">app_service_config_files:
- /home/matrix/.synapse/&lt;your-AS&gt;.yaml
</code></pre>
<p>The format of the AS configuration file is as follows:</p>
<pre><code class="language-yaml">url: &lt;base url of AS&gt;
as_token: &lt;token AS will add to requests to HS&gt;
hs_token: &lt;token HS will add to requests to AS&gt;
sender_localpart: &lt;localpart of AS user&gt;
namespaces:
  users:  # List of users we're interested in
    - exclusive: &lt;bool&gt;
      regex: &lt;regex&gt;
      group_id: &lt;group&gt;
    - ...
  aliases: []  # List of aliases we're interested in
  rooms: [] # List of room ids we're interested in
</code></pre>
<p><code>exclusive</code>: If enabled, only this application service is allowed to register users in its namespace(s).
<code>group_id</code>: All users of this application service are dynamically joined to this group. This is useful for e.g user organisation or flairs.</p>
<p>See the <a href="https://matrix.org/docs/spec/application_service/unstable.html">spec</a> for further details on how application services work.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="server-notices"><a class="header" href="#server-notices">Server Notices</a></h1>
<p>'Server Notices' are a new feature introduced in Synapse 0.30. They provide a
channel whereby server administrators can send messages to users on the server.</p>
<p>They are used as part of communication of the server polices(see
<a href="usage/configuration/consent_tracking.html">consent_tracking.md</a>), however the intention is that
they may also find a use for features such as &quot;Message of the day&quot;.</p>
<p>This is a feature specific to Synapse, but it uses standard Matrix
communication mechanisms, so should work with any Matrix client.</p>
<h2 id="user-experience"><a class="header" href="#user-experience">User experience</a></h2>
<p>When the user is first sent a server notice, they will get an invitation to a
room (typically called 'Server Notices', though this is configurable in
<code>homeserver.yaml</code>). They will be <strong>unable to reject</strong> this invitation -
attempts to do so will receive an error.</p>
<p>Once they accept the invitation, they will see the notice message in the room
history; it will appear to have come from the 'server notices user' (see
below).</p>
<p>The user is prevented from sending any messages in this room by the power
levels.</p>
<p>Having joined the room, the user can leave the room if they want. Subsequent
server notices will then cause a new room to be created.</p>
<h2 id="synapse-configuration"><a class="header" href="#synapse-configuration">Synapse configuration</a></h2>
<p>Server notices come from a specific user id on the server. Server
administrators are free to choose the user id - something like <code>server</code> is
suggested, meaning the notices will come from
<code>@server:&lt;your_server_name&gt;</code>. Once the Server Notices user is configured, that
user id becomes a special, privileged user, so administrators should ensure
that <strong>it is not already allocated</strong>.</p>
<p>In order to support server notices, it is necessary to add some configuration
to the <code>homeserver.yaml</code> file. In particular, you should add a <code>server_notices</code>
section, which should look like this:</p>
<pre><code class="language-yaml">server_notices:
   system_mxid_localpart: server
   system_mxid_display_name: &quot;Server Notices&quot;
   system_mxid_avatar_url: &quot;mxc://server.com/oumMVlgDnLYFaPVkExemNVVZ&quot;
   room_name: &quot;Server Notices&quot;
</code></pre>
<p>The only compulsory setting is <code>system_mxid_localpart</code>, which defines the user
id of the Server Notices user, as above. <code>room_name</code> defines the name of the
room which will be created.</p>
<p><code>system_mxid_display_name</code> and <code>system_mxid_avatar_url</code> can be used to set the
displayname and avatar of the Server Notices user.</p>
<h2 id="sending-notices"><a class="header" href="#sending-notices">Sending notices</a></h2>
<p>To send server notices to users you can use the
<a href="usage/configuration/../administration/admin_api/server_notices.html">admin_api</a>.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="support-in-synapse-for-tracking-agreement-to-server-terms-and-conditions"><a class="header" href="#support-in-synapse-for-tracking-agreement-to-server-terms-and-conditions">Support in Synapse for tracking agreement to server terms and conditions</a></h1>
<p>Synapse 0.30 introduces support for tracking whether users have agreed to the
terms and conditions set by the administrator of a server - and blocking access
to the server until they have.</p>
<p>There are several parts to this functionality; each requires some specific
configuration in <code>homeserver.yaml</code> to be enabled.</p>
<p>Note that various parts of the configuation and this document refer to the
&quot;privacy policy&quot;: agreement with a privacy policy is one particular use of this
feature, but of course adminstrators can specify other terms and conditions
unrelated to &quot;privacy&quot; per se.</p>
<h2 id="collecting-policy-agreement-from-a-user"><a class="header" href="#collecting-policy-agreement-from-a-user">Collecting policy agreement from a user</a></h2>
<p>Synapse can be configured to serve the user a simple policy form with an
&quot;accept&quot; button. Clicking &quot;Accept&quot; records the user's acceptance in the
database and shows a success page.</p>
<p>To enable this, first create templates for the policy and success pages.
These should be stored on the local filesystem.</p>
<p>These templates use the <a href="http://jinja.pocoo.org">Jinja2</a> templating language,
and <a href="usage/configuration/../../../docs/privacy_policy_templates">docs/privacy_policy_templates</a> gives
examples of the sort of thing that can be done.</p>
<p>Note that the templates must be stored under a name giving the language of the
template - currently this must always be <code>en</code> (for &quot;English&quot;);
internationalisation support is intended for the future.</p>
<p>The template for the policy itself should be versioned and named according to
the version: for example <code>1.0.html</code>. The version of the policy which the user
has agreed to is stored in the database.</p>
<p>Once the templates are in place, make the following changes to <code>homeserver.yaml</code>:</p>
<ol>
<li>
<p>Add a <code>user_consent</code> section, which should look like:</p>
<pre><code class="language-yaml">user_consent:
  template_dir: privacy_policy_templates
  version: 1.0
</code></pre>
<p><code>template_dir</code> points to the directory containing the policy
templates. <code>version</code> defines the version of the policy which will be served
to the user. In the example above, Synapse will serve
<code>privacy_policy_templates/en/1.0.html</code>.</p>
</li>
<li>
<p>Add a <code>form_secret</code> setting at the top level:</p>
<pre><code class="language-yaml">form_secret: &quot;&lt;unique secret&gt;&quot;
</code></pre>
<p>This should be set to an arbitrary secret string (try <code>pwgen -y 30</code> to
generate suitable secrets).</p>
<p>More on what this is used for below.</p>
</li>
<li>
<p>Add <code>consent</code> wherever the <code>client</code> resource is currently enabled in the
<code>listeners</code> configuration. For example:</p>
<pre><code class="language-yaml">listeners:
  - port: 8008
    resources:
      - names:
        - client
        - consent
</code></pre>
</li>
</ol>
<p>Finally, ensure that <code>jinja2</code> is installed. If you are using a virtualenv, this
should be a matter of <code>pip install Jinja2</code>. On debian, try <code>apt-get install python-jinja2</code>.</p>
<p>Once this is complete, and the server has been restarted, try visiting
<code>https://&lt;server&gt;/_matrix/consent</code>. If correctly configured, this should give
an error &quot;Missing string query parameter 'u'&quot;. It is now possible to manually
construct URIs where users can give their consent.</p>
<h3 id="enabling-consent-tracking-at-registration"><a class="header" href="#enabling-consent-tracking-at-registration">Enabling consent tracking at registration</a></h3>
<ol>
<li>
<p>Add the following to your configuration:</p>
<pre><code class="language-yaml">user_consent:
  require_at_registration: true
  policy_name: &quot;Privacy Policy&quot; # or whatever you'd like to call the policy
</code></pre>
</li>
<li>
<p>In your consent templates, make use of the <code>public_version</code> variable to
see if an unauthenticated user is viewing the page. This is typically
wrapped around the form that would be used to actually agree to the document:</p>
<pre><code>{% if not public_version %}
  &lt;!-- The variables used here are only provided when the 'u' param is given to the homeserver --&gt;
  &lt;form method=&quot;post&quot; action=&quot;consent&quot;&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;v&quot; value=&quot;{{version}}&quot;/&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;u&quot; value=&quot;{{user}}&quot;/&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;h&quot; value=&quot;{{userhmac}}&quot;/&gt;
    &lt;input type=&quot;submit&quot; value=&quot;Sure thing!&quot;/&gt;
  &lt;/form&gt;
{% endif %}
</code></pre>
</li>
<li>
<p>Restart Synapse to apply the changes.</p>
</li>
</ol>
<p>Visiting <code>https://&lt;server&gt;/_matrix/consent</code> should now give you a view of the privacy
document. This is what users will be able to see when registering for accounts.</p>
<h3 id="constructing-the-consent-uri"><a class="header" href="#constructing-the-consent-uri">Constructing the consent URI</a></h3>
<p>It may be useful to manually construct the &quot;consent URI&quot; for a given user - for
instance, in order to send them an email asking them to consent. To do this,
take the base <code>https://&lt;server&gt;/_matrix/consent</code> URL and add the following
query parameters:</p>
<ul>
<li>
<p><code>u</code>: the user id of the user. This can either be a full MXID
(<code>@user:server.com</code>) or just the localpart (<code>user</code>).</p>
</li>
<li>
<p><code>h</code>: hex-encoded HMAC-SHA256 of <code>u</code> using the <code>form_secret</code> as a key. It is
possible to calculate this on the commandline with something like:</p>
<pre><code class="language-bash">echo -n '&lt;user&gt;' | openssl sha256 -hmac '&lt;form_secret&gt;'
</code></pre>
<p>This should result in a URI which looks something like:
<code>https://&lt;server&gt;/_matrix/consent?u=&lt;user&gt;&amp;h=68a152465a4d...</code>.</p>
</li>
</ul>
<p>Note that not providing a <code>u</code> parameter will be interpreted as wanting to view
the document from an unauthenticated perspective, such as prior to registration.
Therefore, the <code>h</code> parameter is not required in this scenario. To enable this
behaviour, set <code>require_at_registration</code> to <code>true</code> in your <code>user_consent</code> config.</p>
<h2 id="sending-users-a-server-notice-asking-them-to-agree-to-the-policy"><a class="header" href="#sending-users-a-server-notice-asking-them-to-agree-to-the-policy">Sending users a server notice asking them to agree to the policy</a></h2>
<p>It is possible to configure Synapse to send a <a href="usage/configuration/server_notices.html">server
notice</a> to anybody who has not yet agreed to the current
version of the policy. To do so:</p>
<ul>
<li>
<p>ensure that the consent resource is configured, as in the previous section</p>
</li>
<li>
<p>ensure that server notices are configured, as in <a href="usage/configuration/server_notices.html">server_notices.md</a>.</p>
</li>
<li>
<p>Add <code>server_notice_content</code> under <code>user_consent</code> in <code>homeserver.yaml</code>. For
example:</p>
<pre><code class="language-yaml">user_consent:
  server_notice_content:
    msgtype: m.text
    body: &gt;-
      Please give your consent to the privacy policy at %(consent_uri)s.
</code></pre>
<p>Synapse automatically replaces the placeholder <code>%(consent_uri)s</code> with the
consent uri for that user.</p>
</li>
<li>
<p>ensure that <code>public_baseurl</code> is set in <code>homeserver.yaml</code>, and gives the base
URI that clients use to connect to the server. (It is used to construct
<code>consent_uri</code> in the server notice.)</p>
</li>
</ul>
<h2 id="blocking-users-from-using-the-server-until-they-agree-to-the-policy"><a class="header" href="#blocking-users-from-using-the-server-until-they-agree-to-the-policy">Blocking users from using the server until they agree to the policy</a></h2>
<p>Synapse can be configured to block any attempts to join rooms or send messages
until the user has given their agreement to the policy. (Joining the server
notices room is exempted from this).</p>
<p>To enable this, add <code>block_events_error</code> under <code>user_consent</code>. For example:</p>
<pre><code class="language-yaml">user_consent:
  block_events_error: &gt;-
    You can't send any messages until you consent to the privacy policy at
    %(consent_uri)s.
</code></pre>
<p>Synapse automatically replaces the placeholder <code>%(consent_uri)s</code> with the
consent uri for that user.</p>
<p>ensure that <code>public_baseurl</code> is set in <code>homeserver.yaml</code>, and gives the base
URI that clients use to connect to the server. (It is used to construct
<code>consent_uri</code> in the error.)</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="url-previews-1"><a class="header" href="#url-previews-1">URL Previews</a></h1>
<p>Design notes on a URL previewing service for Matrix:</p>
<p>Options are:</p>
<ol>
<li>Have an AS which listens for URLs, downloads them, and inserts an event that describes their metadata.</li>
</ol>
<ul>
<li>Pros:
<ul>
<li>Decouples the implementation entirely from Synapse.</li>
<li>Uses existing Matrix events &amp; content repo to store the metadata.</li>
</ul>
</li>
<li>Cons:
<ul>
<li>Which AS should provide this service for a room, and why should you trust it?</li>
<li>Doesn't work well with E2E; you'd have to cut the AS into every room</li>
<li>the AS would end up subscribing to every room anyway.</li>
</ul>
</li>
</ul>
<ol start="2">
<li>Have a generic preview API (nothing to do with Matrix) that provides a previewing service:</li>
</ol>
<ul>
<li>Pros:
<ul>
<li>Simple and flexible; can be used by any clients at any point</li>
</ul>
</li>
<li>Cons:
<ul>
<li>If each HS provides one of these independently, all the HSes in a room may needlessly DoS the target URI</li>
<li>We need somewhere to store the URL metadata rather than just using Matrix itself</li>
<li>We can't piggyback on matrix to distribute the metadata between HSes.</li>
</ul>
</li>
</ul>
<ol start="3">
<li>Make the synapse of the sending user responsible for spidering the URL and inserting an event asynchronously which describes the metadata.</li>
</ol>
<ul>
<li>Pros:
<ul>
<li>Works transparently for all clients</li>
<li>Piggy-backs nicely on using Matrix for distributing the metadata.</li>
<li>No confusion as to which AS</li>
</ul>
</li>
<li>Cons:
<ul>
<li>Doesn't work with E2E</li>
<li>We might want to decouple the implementation of the spider from the HS, given spider behaviour can be quite complicated and evolve much more rapidly than the HS.  It's more like a bot than a core part of the server.</li>
</ul>
</li>
</ul>
<ol start="4">
<li>Make the sending client use the preview API and insert the event itself when successful.</li>
</ol>
<ul>
<li>Pros:
<ul>
<li>Works well with E2E</li>
<li>No custom server functionality</li>
<li>Lets the client customise the preview that they send (like on FB)</li>
</ul>
</li>
<li>Cons:
<ul>
<li>Entirely specific to the sending client, whereas it'd be nice if /any/ URL was correctly previewed if clients support it.</li>
</ul>
</li>
</ul>
<ol start="5">
<li>Have the option of specifying a shared (centralised) previewing service used by a room, to avoid all the different HSes in the room DoSing the target.</li>
</ol>
<p>Best solution is probably a combination of both 2 and 4.</p>
<ul>
<li>Sending clients do their best to create and send a preview at the point of sending the message, perhaps delaying the message until the preview is computed?  (This also lets the user validate the preview before sending)</li>
<li>Receiving clients have the option of going and creating their own preview if one doesn't arrive soon enough (or if the original sender didn't create one)</li>
</ul>
<p>This is a bit magical though in that the preview could come from two entirely different sources - the sending HS or your local one.  However, this can always be exposed to users: &quot;Generate your own URL previews if none are available?&quot;</p>
<p>This is tantamount also to senders calculating their own thumbnails for sending in advance of the main content - we are trusting the sender not to lie about the content in the thumbnail.  Whereas currently thumbnails are calculated by the receiving homeserver to avoid this attack.</p>
<p>However, this kind of phishing attack does exist whether we let senders pick their thumbnails or not, in that a malicious sender can send normal text messages around the attachment claiming it to be legitimate.  We could rely on (future) reputation/abuse management to punish users who phish (be it with bogus metadata or bogus descriptions).   Bogus metadata is particularly bad though, especially if it's avoidable.</p>
<p>As a first cut, let's do #2 and have the receiver hit the API to calculate its own previews (as it does currently for image thumbnails).  We can then extend/optimise this to option 4 as a special extra if needed.</p>
<h2 id="api"><a class="header" href="#api">API</a></h2>
<pre><code>GET /_matrix/media/r0/preview_url?url=http://wherever.com
200 OK
{
    &quot;og:type&quot;        : &quot;article&quot;
    &quot;og:url&quot;         : &quot;https://twitter.com/matrixdotorg/status/684074366691356672&quot;
    &quot;og:title&quot;       : &quot;Matrix on Twitter&quot;
    &quot;og:image&quot;       : &quot;https://pbs.twimg.com/profile_images/500400952029888512/yI0qtFi7_400x400.png&quot;
    &quot;og:description&quot; : &quot;â€œSynapse 0.12 is out! Lots of polishing, performance &amp;amp;amp; bugfixes: /sync API, /r0 prefix, fulltext search, 3PID invites https://t.co/5alhXLLEGPâ€&quot;
    &quot;og:site_name&quot;   : &quot;Twitter&quot;
}
</code></pre>
<ul>
<li>Downloads the URL
<ul>
<li>If HTML, just stores it in RAM and parses it for OG meta tags
<ul>
<li>Download any media OG meta tags to the media repo, and refer to them in the OG via mxc:// URIs.</li>
</ul>
</li>
<li>If a media filetype we know we can thumbnail: store it on disk, and hand it to the thumbnailer. Generate OG meta tags from the thumbnailer contents.</li>
<li>Otherwise, don't bother downloading further.</li>
</ul>
</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="user-directory-api-implementation"><a class="header" href="#user-directory-api-implementation">User Directory API Implementation</a></h1>
<p>The user directory is currently maintained based on the 'visible' users
on this particular server - i.e. ones which your account shares a room with, or
who are present in a publicly viewable room present on the server.</p>
<p>The directory info is stored in various tables, which can (typically after
DB corruption) get stale or out of sync.  If this happens, for now the
solution to fix it is to execute the SQL <a href="usage/configuration/../synapse/storage/databases/main/schema/delta/53/user_dir_populate.sql">here</a>
and then restart synapse. This should then start a background task to
flush the current tables and regenerate the directory.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="message-retention-policies"><a class="header" href="#message-retention-policies">Message retention policies</a></h1>
<p>Synapse admins can enable support for message retention policies on
their homeserver. Message retention policies exist at a room level,
follow the semantics described in
<a href="https://github.com/matrix-org/matrix-doc/blob/matthew/msc1763/proposals/1763-configurable-retention-periods.md">MSC1763</a>,
and allow server and room admins to configure how long messages should
be kept in a homeserver's database before being purged from it.
<strong>Please note that, as this feature isn't part of the Matrix
specification yet, this implementation is to be considered as
experimental.</strong> </p>
<p>A message retention policy is mainly defined by its <code>max_lifetime</code>
parameter, which defines how long a message can be kept around after
it was sent to the room. If a room doesn't have a message retention
policy, and there's no default one for a given server, then no message
sent in that room is ever purged on that server.</p>
<p>MSC1763 also specifies semantics for a <code>min_lifetime</code> parameter which
defines the amount of time after which an event <em>can</em> get purged (after
it was sent to the room), but Synapse doesn't currently support it
beyond registering it.</p>
<p>Both <code>max_lifetime</code> and <code>min_lifetime</code> are optional parameters.</p>
<p>Note that message retention policies don't apply to state events.</p>
<p>Once an event reaches its expiry date (defined as the time it was sent
plus the value for <code>max_lifetime</code> in the room), two things happen:</p>
<ul>
<li>Synapse stops serving the event to clients via any endpoint.</li>
<li>The message gets picked up by the next purge job (see the &quot;Purge jobs&quot;
section) and is removed from Synapse's database.</li>
</ul>
<p>Since purge jobs don't run continuously, this means that an event might
stay in a server's database for longer than the value for <code>max_lifetime</code>
in the room would allow, though hidden from clients.</p>
<p>Similarly, if a server (with support for message retention policies
enabled) receives from another server an event that should have been
purged according to its room's policy, then the receiving server will
process and store that event until it's picked up by the next purge job,
though it will always hide it from clients.</p>
<p>Synapse requires at least one message in each room, so it will never
delete the last message in a room. It will, however, hide it from
clients.</p>
<h2 id="server-configuration"><a class="header" href="#server-configuration">Server configuration</a></h2>
<p>Support for this feature can be enabled and configured in the
<code>retention</code> section of the Synapse configuration file (see the
<a href="https://github.com/matrix-org/synapse/blob/v1.7.3/docs/sample_config.yaml#L332-L393">sample file</a>).</p>
<p>To enable support for message retention policies, set the setting
<code>enabled</code> in this section to <code>true</code>.</p>
<h3 id="default-policy"><a class="header" href="#default-policy">Default policy</a></h3>
<p>A default message retention policy is a policy defined in Synapse's
configuration that is used by Synapse for every room that doesn't have a
message retention policy configured in its state. This allows server
admins to ensure that messages are never kept indefinitely in a server's
database. </p>
<p>A default policy can be defined as such, in the <code>retention</code> section of
the configuration file:</p>
<pre><code class="language-yaml">  default_policy:
    min_lifetime: 1d
    max_lifetime: 1y
</code></pre>
<p>Here, <code>min_lifetime</code> and <code>max_lifetime</code> have the same meaning and level
of support as previously described. They can be expressed either as a
duration (using the units <code>s</code> (seconds), <code>m</code> (minutes), <code>h</code> (hours),
<code>d</code> (days), <code>w</code> (weeks) and <code>y</code> (years)) or as a number of milliseconds.</p>
<h3 id="purge-jobs"><a class="header" href="#purge-jobs">Purge jobs</a></h3>
<p>Purge jobs are the jobs that Synapse runs in the background to purge
expired events from the database. They are only run if support for
message retention policies is enabled in the server's configuration. If
no configuration for purge jobs is configured by the server admin,
Synapse will use a default configuration, which is described in the
<a href="https://github.com/matrix-org/synapse/blob/master/docs/sample_config.yaml#L332-L393">sample configuration file</a>.</p>
<p>Some server admins might want a finer control on when events are removed
depending on an event's room's policy. This can be done by setting the
<code>purge_jobs</code> sub-section in the <code>retention</code> section of the configuration
file. An example of such configuration could be:</p>
<pre><code class="language-yaml">  purge_jobs:
    - longest_max_lifetime: 3d
      interval: 12h
    - shortest_max_lifetime: 3d
      longest_max_lifetime: 1w
      interval: 1d
    - shortest_max_lifetime: 1w
      interval: 2d
</code></pre>
<p>In this example, we define three jobs:</p>
<ul>
<li>one that runs twice a day (every 12 hours) and purges events in rooms
which policy's <code>max_lifetime</code> is lower or equal to 3 days.</li>
<li>one that runs once a day and purges events in rooms which policy's
<code>max_lifetime</code> is between 3 days and a week.</li>
<li>one that runs once every 2 days and purges events in rooms which
policy's <code>max_lifetime</code> is greater than a week.</li>
</ul>
<p>Note that this example is tailored to show different configurations and
features slightly more jobs than it's probably necessary (in practice, a
server admin would probably consider it better to replace the two last
jobs with one that runs once a day and handles rooms which which
policy's <code>max_lifetime</code> is greater than 3 days).</p>
<p>Keep in mind, when configuring these jobs, that a purge job can become
quite heavy on the server if it targets many rooms, therefore prefer
having jobs with a low interval that target a limited set of rooms. Also
make sure to include a job with no minimum and one with no maximum to
make sure your configuration handles every policy.</p>
<p>As previously mentioned in this documentation, while a purge job that
runs e.g. every day means that an expired event might stay in the
database for up to a day after its expiry, Synapse hides expired events
from clients as soon as they expire, so the event is not visible to
local users between its expiry date and the moment it gets purged from
the server's database.</p>
<h3 id="lifetime-limits"><a class="header" href="#lifetime-limits">Lifetime limits</a></h3>
<p>Server admins can set limits on the values of <code>max_lifetime</code> to use when
purging old events in a room. These limits can be defined as such in the
<code>retention</code> section of the configuration file:</p>
<pre><code class="language-yaml">  allowed_lifetime_min: 1d
  allowed_lifetime_max: 1y
</code></pre>
<p>The limits are considered when running purge jobs. If necessary, the
effective value of <code>max_lifetime</code> will be brought between
<code>allowed_lifetime_min</code> and <code>allowed_lifetime_max</code> (inclusive).
This means that, if the value of <code>max_lifetime</code> defined in the room's state
is lower than <code>allowed_lifetime_min</code>, the value of <code>allowed_lifetime_min</code>
will be used instead. Likewise, if the value of <code>max_lifetime</code> is higher
than <code>allowed_lifetime_max</code>, the value of <code>allowed_lifetime_max</code> will be
used instead.</p>
<p>In the example above, we ensure Synapse never deletes events that are less
than one day old, and that it always deletes events that are over a year
old.</p>
<p>If a default policy is set, and its <code>max_lifetime</code> value is lower than
<code>allowed_lifetime_min</code> or higher than <code>allowed_lifetime_max</code>, the same
process applies.</p>
<p>Both parameters are optional; if one is omitted Synapse won't use it to
adjust the effective value of <code>max_lifetime</code>.</p>
<p>Like other settings in this section, these parameters can be expressed
either as a duration or as a number of milliseconds.</p>
<h2 id="room-configuration"><a class="header" href="#room-configuration">Room configuration</a></h2>
<p>To configure a room's message retention policy, a room's admin or
moderator needs to send a state event in that room with the type
<code>m.room.retention</code> and the following content:</p>
<pre><code class="language-json">{
    &quot;max_lifetime&quot;: ...
}
</code></pre>
<p>In this event's content, the <code>max_lifetime</code> parameter has the same
meaning as previously described, and needs to be expressed in
milliseconds. The event's content can also include a <code>min_lifetime</code>
parameter, which has the same meaning and limited support as previously
described.</p>
<p>Note that over every server in the room, only the ones with support for
message retention policies will actually remove expired events. This
support is currently not enabled by default in Synapse.</p>
<h2 id="note-on-reclaiming-disk-space"><a class="header" href="#note-on-reclaiming-disk-space">Note on reclaiming disk space</a></h2>
<p>While purge jobs actually delete data from the database, the disk space
used by the database might not decrease immediately on the database's
host. However, even though the database engine won't free up the disk
space, it will start writing new data into where the purged data was.</p>
<p>If you want to reclaim the freed disk space anyway and return it to the
operating system, the server admin needs to run <code>VACUUM FULL;</code> (or
<code>VACUUM;</code> for SQLite databases) on Synapse's database (see the related
<a href="https://www.postgresql.org/docs/current/sql-vacuum.html">PostgreSQL documentation</a>).</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="pluggable-modules"><a class="header" href="#pluggable-modules">Pluggable Modules</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="third-party-rules"><a class="header" href="#third-party-rules">Third Party Rules</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="handling-spam-in-synapse"><a class="header" href="#handling-spam-in-synapse">Handling spam in Synapse</a></h1>
<p>Synapse has support to customize spam checking behavior. It can plug into a
variety of events and affect how they are presented to users on your homeserver.</p>
<p>The spam checking behavior is implemented as a Python class, which must be
able to be imported by the running Synapse.</p>
<h2 id="python-spam-checker-class"><a class="header" href="#python-spam-checker-class">Python spam checker class</a></h2>
<p>The Python class is instantiated with two objects:</p>
<ul>
<li>Any configuration (see below).</li>
<li>An instance of <code>synapse.module_api.ModuleApi</code>.</li>
</ul>
<p>It then implements methods which return a boolean to alter behavior in Synapse.
All the methods must be defined.</p>
<p>There's a generic method for checking every event (<code>check_event_for_spam</code>), as
well as some specific methods:</p>
<ul>
<li><code>user_may_invite</code></li>
<li><code>user_may_create_room</code></li>
<li><code>user_may_create_room_alias</code></li>
<li><code>user_may_publish_room</code></li>
<li><code>check_username_for_spam</code></li>
<li><code>check_registration_for_spam</code></li>
<li><code>check_media_file_for_spam</code></li>
</ul>
<p>The details of each of these methods (as well as their inputs and outputs)
are documented in the <code>synapse.events.spamcheck.SpamChecker</code> class.</p>
<p>The <code>ModuleApi</code> class provides a way for the custom spam checker class to
call back into the homeserver internals.</p>
<p>Additionally, a <code>parse_config</code> method is mandatory and receives the plugin config
dictionary. After parsing, It must return an object which will be
passed to <code>__init__</code> later.</p>
<h3 id="example"><a class="header" href="#example">Example</a></h3>
<pre><code class="language-python">from synapse.spam_checker_api import RegistrationBehaviour

class ExampleSpamChecker:
    def __init__(self, config, api):
        self.config = config
        self.api = api

    @staticmethod
    def parse_config(config):
        return config
        
    async def check_event_for_spam(self, foo):
        return False  # allow all events

    async def user_may_invite(self, inviter_userid, invitee_userid, room_id):
        return True  # allow all invites

    async def user_may_create_room(self, userid):
        return True  # allow all room creations

    async def user_may_create_room_alias(self, userid, room_alias):
        return True  # allow all room aliases

    async def user_may_publish_room(self, userid, room_id):
        return True  # allow publishing of all rooms

    async def check_username_for_spam(self, user_profile):
        return False  # allow all usernames

    async def check_registration_for_spam(
        self,
        email_threepid,
        username,
        request_info,
        auth_provider_id,
    ):
        return RegistrationBehaviour.ALLOW  # allow all registrations

    async def check_media_file_for_spam(self, file_wrapper, file_info):
        return False  # allow all media
</code></pre>
<h2 id="configuration-1"><a class="header" href="#configuration-1">Configuration</a></h2>
<p>Modify the <code>spam_checker</code> section of your <code>homeserver.yaml</code> in the following
manner:</p>
<p>Create a list entry with the keys <code>module</code> and <code>config</code>.</p>
<ul>
<li>
<p><code>module</code> should point to the fully qualified Python class that implements your
custom logic, e.g. <code>my_module.ExampleSpamChecker</code>.</p>
</li>
<li>
<p><code>config</code> is a dictionary that gets passed to the spam checker class.</p>
</li>
</ul>
<h3 id="example-1"><a class="header" href="#example-1">Example</a></h3>
<p>This section might look like:</p>
<pre><code class="language-yaml">spam_checker:
  - module: my_module.ExampleSpamChecker
    config:
      # Enable or disable a specific option in ExampleSpamChecker.
      my_custom_option: true
</code></pre>
<p>More spam checkers can be added in tandem by appending more items to the list. An
action is blocked when at least one of the configured spam checkers flags it.</p>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<p>The <a href="https://github.com/matrix-org/mjolnir">Mjolnir</a> project is a full fledged
example using the Synapse spam checking API, including a bot for dynamic
configuration.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="presence-router-module"><a class="header" href="#presence-router-module">Presence Router Module</a></h1>
<p>Synapse supports configuring a module that can specify additional users
(local or remote) to should receive certain presence updates from local
users.</p>
<p>Note that routing presence via Application Service transactions is not
currently supported.</p>
<p>The presence routing module is implemented as a Python class, which will
be imported by the running Synapse.</p>
<h2 id="python-presence-router-class"><a class="header" href="#python-presence-router-class">Python Presence Router Class</a></h2>
<p>The Python class is instantiated with two objects:</p>
<ul>
<li>A configuration object of some type (see below).</li>
<li>An instance of <code>synapse.module_api.ModuleApi</code>.</li>
</ul>
<p>It then implements methods related to presence routing.</p>
<p>Note that one method of <code>ModuleApi</code> that may be useful is:</p>
<pre><code class="language-python">async def ModuleApi.send_local_online_presence_to(users: Iterable[str]) -&gt; None
</code></pre>
<p>which can be given a list of local or remote MXIDs to broadcast known, online user
presence to (for those users that the receiving user is considered interested in). 
It does not include state for users who are currently offline, and it can only be
called on workers that support sending federation.</p>
<h3 id="module-structure"><a class="header" href="#module-structure">Module structure</a></h3>
<p>Below is a list of possible methods that can be implemented, and whether they are
required.</p>
<h4 id="parse_config"><a class="header" href="#parse_config"><code>parse_config</code></a></h4>
<pre><code class="language-python">def parse_config(config_dict: dict) -&gt; Any
</code></pre>
<p><strong>Required.</strong> A static method that is passed a dictionary of config options, and
should return a validated config object. This method is described further in
<a href="usage/configuration/pluggable_modules/presence_router_module.html#configuration">Configuration</a>.</p>
<h4 id="get_users_for_states"><a class="header" href="#get_users_for_states"><code>get_users_for_states</code></a></h4>
<pre><code class="language-python">async def get_users_for_states(
    self,
    state_updates: Iterable[UserPresenceState],
) -&gt; Dict[str, Set[UserPresenceState]]:
</code></pre>
<p><strong>Required.</strong> An asynchronous method that is passed an iterable of user presence
state. This method can determine whether a given presence update should be sent to certain
users. It does this by returning a dictionary with keys representing local or remote
Matrix User IDs, and values being a python set
of <code>synapse.handlers.presence.UserPresenceState</code> instances.</p>
<p>Synapse will then attempt to send the specified presence updates to each user when
possible.</p>
<h4 id="get_interested_users"><a class="header" href="#get_interested_users"><code>get_interested_users</code></a></h4>
<pre><code class="language-python">async def get_interested_users(self, user_id: str) -&gt; Union[Set[str], str]
</code></pre>
<p><strong>Required.</strong> An asynchronous method that is passed a single Matrix User ID. This
method is expected to return the users that the passed in user may be interested in the
presence of. Returned users may be local or remote. The presence routed as a result of
what this method returns is sent in addition to the updates already sent between users
that share a room together. Presence updates are deduplicated.</p>
<p>This method should return a python set of Matrix User IDs, or the object
<code>synapse.events.presence_router.PresenceRouter.ALL_USERS</code> to indicate that the passed
user should receive presence information for <em>all</em> known users.</p>
<p>For clarity, if the user <code>@alice:example.org</code> is passed to this method, and the Set
<code>{&quot;@bob:example.com&quot;, &quot;@charlie:somewhere.org&quot;}</code> is returned, this signifies that Alice
should receive presence updates sent by Bob and Charlie, regardless of whether these
users share a room.</p>
<h3 id="example-2"><a class="header" href="#example-2">Example</a></h3>
<p>Below is an example implementation of a presence router class.</p>
<pre><code class="language-python">from typing import Dict, Iterable, Set, Union
from synapse.events.presence_router import PresenceRouter
from synapse.handlers.presence import UserPresenceState
from synapse.module_api import ModuleApi

class PresenceRouterConfig:
    def __init__(self):
        # Config options with their defaults
        # A list of users to always send all user presence updates to
        self.always_send_to_users = []  # type: List[str]
        
        # A list of users to ignore presence updates for. Does not affect
        # shared-room presence relationships
        self.blacklisted_users = []  # type: List[str]

class ExamplePresenceRouter:
    &quot;&quot;&quot;An example implementation of synapse.presence_router.PresenceRouter.
    Supports routing all presence to a configured set of users, or a subset
    of presence from certain users to members of certain rooms.

    Args:
        config: A configuration object.
        module_api: An instance of Synapse's ModuleApi.
    &quot;&quot;&quot;
    def __init__(self, config: PresenceRouterConfig, module_api: ModuleApi):
        self._config = config
        self._module_api = module_api

    @staticmethod
    def parse_config(config_dict: dict) -&gt; PresenceRouterConfig:
        &quot;&quot;&quot;Parse a configuration dictionary from the homeserver config, do
        some validation and return a typed PresenceRouterConfig.

        Args:
            config_dict: The configuration dictionary.

        Returns:
            A validated config object.
        &quot;&quot;&quot;
        # Initialise a typed config object
        config = PresenceRouterConfig()
        always_send_to_users = config_dict.get(&quot;always_send_to_users&quot;)
        blacklisted_users = config_dict.get(&quot;blacklisted_users&quot;)

        # Do some validation of config options... otherwise raise a
        # synapse.config.ConfigError.
        config.always_send_to_users = always_send_to_users
        config.blacklisted_users = blacklisted_users

        return config

    async def get_users_for_states(
        self,
        state_updates: Iterable[UserPresenceState],
    ) -&gt; Dict[str, Set[UserPresenceState]]:
        &quot;&quot;&quot;Given an iterable of user presence updates, determine where each one
        needs to go. Returned results will not affect presence updates that are
        sent between users who share a room.

        Args:
            state_updates: An iterable of user presence state updates.

        Returns:
          A dictionary of user_id -&gt; set of UserPresenceState that the user should 
          receive.
        &quot;&quot;&quot;
        destination_users = {}  # type: Dict[str, Set[UserPresenceState]

        # Ignore any updates for blacklisted users
        desired_updates = set()
        for update in state_updates:
            if update.state_key not in self._config.blacklisted_users:
                desired_updates.add(update)

        # Send all presence updates to specific users
        for user_id in self._config.always_send_to_users:
            destination_users[user_id] = desired_updates

        return destination_users

    async def get_interested_users(
        self,
        user_id: str,
    ) -&gt; Union[Set[str], PresenceRouter.ALL_USERS]:
        &quot;&quot;&quot;
        Retrieve a list of users that `user_id` is interested in receiving the
        presence of. This will be in addition to those they share a room with.
        Optionally, the object PresenceRouter.ALL_USERS can be returned to indicate
        that this user should receive all incoming local and remote presence updates.

        Note that this method will only be called for local users.

        Args:
          user_id: A user requesting presence updates.

        Returns:
          A set of user IDs to return additional presence updates for, or
          PresenceRouter.ALL_USERS to return presence updates for all other users.
        &quot;&quot;&quot;
        if user_id in self._config.always_send_to_users:
            return PresenceRouter.ALL_USERS

        return set()
</code></pre>
<h4 id="a-note-on-get_users_for_states-and-get_interested_users"><a class="header" href="#a-note-on-get_users_for_states-and-get_interested_users">A note on <code>get_users_for_states</code> and <code>get_interested_users</code></a></h4>
<p>Both of these methods are effectively two different sides of the same coin. The logic
regarding which users should receive updates for other users should be the same 
between them.</p>
<p><code>get_users_for_states</code> is called when presence updates come in from either federation 
or local users, and is used to either direct local presence to remote users, or to
wake up the sync streams of local users to collect remote presence.</p>
<p>In contrast, <code>get_interested_users</code> is used to determine the users that presence should
be fetched for when a local user is syncing. This presence is then retrieved, before
being fed through <code>get_users_for_states</code> once again, with only the syncing user's
routing information pulled from the resulting dictionary.</p>
<p>Their routing logic should thus line up, else you may run into unintended behaviour.</p>
<h2 id="configuration-2"><a class="header" href="#configuration-2">Configuration</a></h2>
<p>Once you've crafted your module and installed it into the same Python environment as
Synapse, amend your homeserver config file with the following.</p>
<pre><code class="language-yaml">presence:
  routing_module:
    module: my_module.ExamplePresenceRouter
    config:
      # Any configuration options for your module. The below is an example.
      # of setting options for ExamplePresenceRouter.
      always_send_to_users: [&quot;@presence_gobbler:example.org&quot;]
      blacklisted_users:
        - &quot;@alice:example.com&quot;
        - &quot;@bob:example.com&quot;
      ...
</code></pre>
<p>The contents of <code>config</code> will be passed as a Python dictionary to the static
<code>parse_config</code> method of your class. The object returned by this method will
then be passed to the <code>__init__</code> method of your module as <code>config</code>.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="workers"><a class="header" href="#workers">Workers</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="administration"><a class="header" href="#administration">Administration</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="admin-apis"><a class="header" href="#admin-apis">Admin APIs</a></h1>
<p>This directory includes documentation for the various synapse specific admin
APIs available.</p>
<h2 id="authenticating-as-a-server-admin"><a class="header" href="#authenticating-as-a-server-admin">Authenticating as a server admin</a></h2>
<p>Many of the API calls in the admin api will require an <code>access_token</code> for a
server admin. (Note that a server admin is distinct from a room admin.)</p>
<p>A user can be marked as a server admin by updating the database directly, e.g.:</p>
<p>.. code-block:: sql</p>
<pre><code>UPDATE users SET admin = 1 WHERE name = '@foo:bar.com';
</code></pre>
<p>A new server admin user can also be created using the
<code>register_new_matrix_user</code> script.</p>
<p>Finding your user's <code>access_token</code> is client-dependent, but will usually be shown in the client's settings.</p>
<p>Once you have your <code>access_token</code>, to include it in a request, the best option is to add the token to a request header:</p>
<p><code>curl --header &quot;Authorization: Bearer &lt;access_token&gt;&quot; &lt;the_rest_of_your_API_request&gt;</code></p>
<p>Fore more details, please refer to the complete <code>matrix spec documentation &lt;https://matrix.org/docs/spec/client_server/r0.5.0#using-access-tokens&gt;</code>_.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="account-validity-api"><a class="header" href="#account-validity-api">Account validity API</a></h1>
<p>This API allows a server administrator to manage the validity of an account. To
use it, you must enable the account validity feature (under
<code>account_validity</code>) in Synapse's configuration.</p>
<h2 id="renew-account"><a class="header" href="#renew-account">Renew account</a></h2>
<p>This API extends the validity of an account by as much time as configured in the
<code>period</code> parameter from the <code>account_validity</code> configuration.</p>
<p>The API is::</p>
<pre><code>POST /_synapse/admin/v1/account_validity/validity
</code></pre>
<p>with the following body:</p>
<p>.. code:: json</p>
<pre><code>{
    &quot;user_id&quot;: &quot;&lt;user ID for the account to renew&gt;&quot;,
    &quot;expiration_ts&quot;: 0,
    &quot;enable_renewal_emails&quot;: true
}
</code></pre>
<p><code>expiration_ts</code> is an optional parameter and overrides the expiration date,
which otherwise defaults to now + validity period.</p>
<p><code>enable_renewal_emails</code> is also an optional parameter and enables/disables
sending renewal emails to the user. Defaults to true.</p>
<p>The API returns with the new expiration date for this account, as a timestamp in
milliseconds since epoch:</p>
<p>.. code:: json</p>
<pre><code>{
    &quot;expiration_ts&quot;: 0
}
</code></pre>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="delete-a-local-group"><a class="header" href="#delete-a-local-group">Delete a local group</a></h1>
<p>This API lets a server admin delete a local group. Doing so will kick all
users out of the group so that their clients will correctly handle the group
being deleted.</p>
<p>The API is:</p>
<pre><code>POST /_synapse/admin/v1/delete_group/&lt;group_id&gt;
</code></pre>
<p>To use it, you will need to authenticate by providing an <code>access_token</code> for a
server admin: see <a href="usage/administration/admin_api/README.rst">README.rst</a>.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="show-reported-events"><a class="header" href="#show-reported-events">Show reported events</a></h1>
<p>This API returns information about reported events.</p>
<p>The api is:</p>
<pre><code>GET /_synapse/admin/v1/event_reports?from=0&amp;limit=10
</code></pre>
<p>To use it, you will need to authenticate by providing an <code>access_token</code> for a
server admin: see <a href="usage/administration/admin_api/README.rst">README.rst</a>.</p>
<p>It returns a JSON body like the following:</p>
<pre><code class="language-json">{
    &quot;event_reports&quot;: [
        {
            &quot;event_id&quot;: &quot;$bNUFCwGzWca1meCGkjp-zwslF-GfVcXukvRLI1_FaVY&quot;,
            &quot;id&quot;: 2,
            &quot;reason&quot;: &quot;foo&quot;,
            &quot;score&quot;: -100,
            &quot;received_ts&quot;: 1570897107409,
            &quot;canonical_alias&quot;: &quot;#alias1:matrix.org&quot;,
            &quot;room_id&quot;: &quot;!ERAgBpSOcCCuTJqQPk:matrix.org&quot;,
            &quot;name&quot;: &quot;Matrix HQ&quot;,
            &quot;sender&quot;: &quot;@foobar:matrix.org&quot;,
            &quot;user_id&quot;: &quot;@foo:matrix.org&quot;
        },
        {
            &quot;event_id&quot;: &quot;$3IcdZsDaN_En-S1DF4EMCy3v4gNRKeOJs8W5qTOKj4I&quot;,
            &quot;id&quot;: 3,
            &quot;reason&quot;: &quot;bar&quot;,
            &quot;score&quot;: -100,
            &quot;received_ts&quot;: 1598889612059,
            &quot;canonical_alias&quot;: &quot;#alias2:matrix.org&quot;,
            &quot;room_id&quot;: &quot;!eGvUQuTCkHGVwNMOjv:matrix.org&quot;,
            &quot;name&quot;: &quot;Your room name here&quot;,
            &quot;sender&quot;: &quot;@foobar:matrix.org&quot;,
            &quot;user_id&quot;: &quot;@bar:matrix.org&quot;
        }
    ],
    &quot;next_token&quot;: 2,
    &quot;total&quot;: 4
}
</code></pre>
<p>To paginate, check for <code>next_token</code> and if present, call the endpoint again with <code>from</code>
set to the value of <code>next_token</code>. This will return a new page.</p>
<p>If the endpoint does not return a <code>next_token</code> then there are no more reports to
paginate through.</p>
<p><strong>URL parameters:</strong></p>
<ul>
<li><code>limit</code>: integer - Is optional but is used for pagination, denoting the maximum number
of items to return in this call. Defaults to <code>100</code>.</li>
<li><code>from</code>: integer - Is optional but used for pagination, denoting the offset in the
returned results. This should be treated as an opaque value and not explicitly set to
anything other than the return value of <code>next_token</code> from a previous call. Defaults to <code>0</code>.</li>
<li><code>dir</code>: string - Direction of event report order. Whether to fetch the most recent
first (<code>b</code>) or the oldest first (<code>f</code>). Defaults to <code>b</code>.</li>
<li><code>user_id</code>: string - Is optional and filters to only return users with user IDs that
contain this value. This is the user who reported the event and wrote the reason.</li>
<li><code>room_id</code>: string - Is optional and filters to only return rooms with room IDs that
contain this value.</li>
</ul>
<p><strong>Response</strong></p>
<p>The following fields are returned in the JSON response body:</p>
<ul>
<li><code>id</code>: integer - ID of event report.</li>
<li><code>received_ts</code>: integer - The timestamp (in milliseconds since the unix epoch) when this
report was sent.</li>
<li><code>room_id</code>: string - The ID of the room in which the event being reported is located.</li>
<li><code>name</code>: string - The name of the room.</li>
<li><code>event_id</code>: string - The ID of the reported event.</li>
<li><code>user_id</code>: string - This is the user who reported the event and wrote the reason.</li>
<li><code>reason</code>: string - Comment made by the <code>user_id</code> in this report. May be blank.</li>
<li><code>score</code>: integer - Content is reported based upon a negative score, where -100 is
&quot;most offensive&quot; and 0 is &quot;inoffensive&quot;.</li>
<li><code>sender</code>: string - This is the ID of the user who sent the original message/event that
was reported.</li>
<li><code>canonical_alias</code>: string - The canonical alias of the room. <code>null</code> if the room does not
have a canonical alias set.</li>
<li><code>next_token</code>: integer - Indication for pagination. See above.</li>
<li><code>total</code>: integer - Total number of event reports related to the query
(<code>user_id</code> and <code>room_id</code>).</li>
</ul>
<h1 id="show-details-of-a-specific-event-report"><a class="header" href="#show-details-of-a-specific-event-report">Show details of a specific event report</a></h1>
<p>This API returns information about a specific event report.</p>
<p>The api is:</p>
<pre><code>GET /_synapse/admin/v1/event_reports/&lt;report_id&gt;
</code></pre>
<p>To use it, you will need to authenticate by providing an <code>access_token</code> for a
server admin: see <a href="usage/administration/admin_api/README.rst">README.rst</a>.</p>
<p>It returns a JSON body like the following:</p>
<pre><code class="language-jsonc">{
    &quot;event_id&quot;: &quot;$bNUFCwGzWca1meCGkjp-zwslF-GfVcXukvRLI1_FaVY&quot;,
    &quot;event_json&quot;: {
        &quot;auth_events&quot;: [
            &quot;$YK4arsKKcc0LRoe700pS8DSjOvUT4NDv0HfInlMFw2M&quot;,
            &quot;$oggsNXxzPFRE3y53SUNd7nsj69-QzKv03a1RucHu-ws&quot;
        ],
        &quot;content&quot;: {
            &quot;body&quot;: &quot;matrix.org: This Week in Matrix&quot;,
            &quot;format&quot;: &quot;org.matrix.custom.html&quot;,
            &quot;formatted_body&quot;: &quot;&lt;strong&gt;matrix.org&lt;/strong&gt;:&lt;br&gt;&lt;a href=\&quot;https://matrix.org/blog/\&quot;&gt;&lt;strong&gt;This Week in Matrix&lt;/strong&gt;&lt;/a&gt;&quot;,
            &quot;msgtype&quot;: &quot;m.notice&quot;
        },
        &quot;depth&quot;: 546,
        &quot;hashes&quot;: {
            &quot;sha256&quot;: &quot;xK1//xnmvHJIOvbgXlkI8eEqdvoMmihVDJ9J4SNlsAw&quot;
        },
        &quot;origin&quot;: &quot;matrix.org&quot;,
        &quot;origin_server_ts&quot;: 1592291711430,
        &quot;prev_events&quot;: [
            &quot;$YK4arsKKcc0LRoe700pS8DSjOvUT4NDv0HfInlMFw2M&quot;
        ],
        &quot;prev_state&quot;: [],
        &quot;room_id&quot;: &quot;!ERAgBpSOcCCuTJqQPk:matrix.org&quot;,
        &quot;sender&quot;: &quot;@foobar:matrix.org&quot;,
        &quot;signatures&quot;: {
            &quot;matrix.org&quot;: {
                &quot;ed25519:a_JaEG&quot;: &quot;cs+OUKW/iHx5pEidbWxh0UiNNHwe46Ai9LwNz+Ah16aWDNszVIe2gaAcVZfvNsBhakQTew51tlKmL2kspXk/Dg&quot;
            }
        },
        &quot;type&quot;: &quot;m.room.message&quot;,
        &quot;unsigned&quot;: {
            &quot;age_ts&quot;: 1592291711430,
        }
    },
    &quot;id&quot;: &lt;report_id&gt;,
    &quot;reason&quot;: &quot;foo&quot;,
    &quot;score&quot;: -100,
    &quot;received_ts&quot;: 1570897107409,
    &quot;canonical_alias&quot;: &quot;#alias1:matrix.org&quot;,
    &quot;room_id&quot;: &quot;!ERAgBpSOcCCuTJqQPk:matrix.org&quot;,
    &quot;name&quot;: &quot;Matrix HQ&quot;,
    &quot;sender&quot;: &quot;@foobar:matrix.org&quot;,
    &quot;user_id&quot;: &quot;@foo:matrix.org&quot;
}
</code></pre>
<p><strong>URL parameters:</strong></p>
<ul>
<li><code>report_id</code>: string - The ID of the event report.</li>
</ul>
<p><strong>Response</strong></p>
<p>The following fields are returned in the JSON response body:</p>
<ul>
<li><code>id</code>: integer - ID of event report.</li>
<li><code>received_ts</code>: integer - The timestamp (in milliseconds since the unix epoch) when this
report was sent.</li>
<li><code>room_id</code>: string - The ID of the room in which the event being reported is located.</li>
<li><code>name</code>: string - The name of the room.</li>
<li><code>event_id</code>: string - The ID of the reported event.</li>
<li><code>user_id</code>: string - This is the user who reported the event and wrote the reason.</li>
<li><code>reason</code>: string - Comment made by the <code>user_id</code> in this report. May be blank.</li>
<li><code>score</code>: integer - Content is reported based upon a negative score, where -100 is
&quot;most offensive&quot; and 0 is &quot;inoffensive&quot;.</li>
<li><code>sender</code>: string - This is the ID of the user who sent the original message/event that
was reported.</li>
<li><code>canonical_alias</code>: string - The canonical alias of the room. <code>null</code> if the room does not
have a canonical alias set.</li>
<li><code>event_json</code>: object - Details of the original event that was reported.</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="contents"><a class="header" href="#contents">Contents</a></h1>
<ul>
<li><a href="usage/administration/admin_api/media_admin_api.html#querying-media">Querying media</a>
<ul>
<li><a href="usage/administration/admin_api/media_admin_api.html#list-all-media-in-a-room">List all media in a room</a></li>
<li><a href="usage/administration/admin_api/media_admin_api.html#list-all-media-uploaded-by-a-user">List all media uploaded by a user</a></li>
</ul>
</li>
<li><a href="usage/administration/admin_api/media_admin_api.html#quarantine-media">Quarantine media</a>
<ul>
<li><a href="usage/administration/admin_api/media_admin_api.html#quarantining-media-by-id">Quarantining media by ID</a></li>
<li><a href="usage/administration/admin_api/media_admin_api.html#quarantining-media-in-a-room">Quarantining media in a room</a></li>
<li><a href="usage/administration/admin_api/media_admin_api.html#quarantining-all-media-of-a-user">Quarantining all media of a user</a></li>
<li><a href="usage/administration/admin_api/media_admin_api.html#protecting-media-from-being-quarantined">Protecting media from being quarantined</a></li>
</ul>
</li>
<li><a href="usage/administration/admin_api/media_admin_api.html#delete-local-media">Delete local media</a>
<ul>
<li><a href="usage/administration/admin_api/media_admin_api.html#delete-a-specific-local-media">Delete a specific local media</a></li>
<li><a href="usage/administration/admin_api/media_admin_api.html#delete-local-media-by-date-or-size">Delete local media by date or size</a></li>
</ul>
</li>
<li><a href="usage/administration/admin_api/media_admin_api.html#purge-remote-media-api">Purge Remote Media API</a></li>
</ul>
<h1 id="querying-media"><a class="header" href="#querying-media">Querying media</a></h1>
<p>These APIs allow extracting media information from the homeserver.</p>
<h2 id="list-all-media-in-a-room"><a class="header" href="#list-all-media-in-a-room">List all media in a room</a></h2>
<p>This API gets a list of known media in a room.
However, it only shows media from unencrypted events or rooms.</p>
<p>The API is:</p>
<pre><code>GET /_synapse/admin/v1/room/&lt;room_id&gt;/media
</code></pre>
<p>To use it, you will need to authenticate by providing an <code>access_token</code> for a
server admin: see <a href="usage/administration/admin_api/README.rst">README.rst</a>.</p>
<p>The API returns a JSON body like the following:</p>
<pre><code class="language-json">{
  &quot;local&quot;: [
    &quot;mxc://localhost/xwvutsrqponmlkjihgfedcba&quot;,
    &quot;mxc://localhost/abcdefghijklmnopqrstuvwx&quot;
  ],
  &quot;remote&quot;: [
    &quot;mxc://matrix.org/xwvutsrqponmlkjihgfedcba&quot;,
    &quot;mxc://matrix.org/abcdefghijklmnopqrstuvwx&quot;
  ]
}
</code></pre>
<h2 id="list-all-media-uploaded-by-a-user"><a class="header" href="#list-all-media-uploaded-by-a-user">List all media uploaded by a user</a></h2>
<p>Listing all media that has been uploaded by a local user can be achieved through
the use of the <a href="usage/administration/admin_api/user_admin_api.rst#list-media-of-a-user">List media of a user</a>
Admin API.</p>
<h1 id="quarantine-media"><a class="header" href="#quarantine-media">Quarantine media</a></h1>
<p>Quarantining media means that it is marked as inaccessible by users. It applies
to any local media, and any locally-cached copies of remote media.</p>
<p>The media file itself (and any thumbnails) is not deleted from the server.</p>
<h2 id="quarantining-media-by-id"><a class="header" href="#quarantining-media-by-id">Quarantining media by ID</a></h2>
<p>This API quarantines a single piece of local or remote media.</p>
<p>Request:</p>
<pre><code>POST /_synapse/admin/v1/media/quarantine/&lt;server_name&gt;/&lt;media_id&gt;

{}
</code></pre>
<p>Where <code>server_name</code> is in the form of <code>example.org</code>, and <code>media_id</code> is in the
form of <code>abcdefg12345...</code>.</p>
<p>Response:</p>
<pre><code class="language-json">{}
</code></pre>
<h2 id="quarantining-media-in-a-room"><a class="header" href="#quarantining-media-in-a-room">Quarantining media in a room</a></h2>
<p>This API quarantines all local and remote media in a room.</p>
<p>Request:</p>
<pre><code>POST /_synapse/admin/v1/room/&lt;room_id&gt;/media/quarantine

{}
</code></pre>
<p>Where <code>room_id</code> is in the form of <code>!roomid12345:example.org</code>.</p>
<p>Response:</p>
<pre><code class="language-json">{
  &quot;num_quarantined&quot;: 10
}
</code></pre>
<p>The following fields are returned in the JSON response body:</p>
<ul>
<li><code>num_quarantined</code>: integer - The number of media items successfully quarantined</li>
</ul>
<p>Note that there is a legacy endpoint, <code>POST /_synapse/admin/v1/quarantine_media/&lt;room_id&gt;</code>, that operates the same.
However, it is deprecated and may be removed in a future release.</p>
<h2 id="quarantining-all-media-of-a-user"><a class="header" href="#quarantining-all-media-of-a-user">Quarantining all media of a user</a></h2>
<p>This API quarantines all <em>local</em> media that a <em>local</em> user has uploaded. That is to say, if
you would like to quarantine media uploaded by a user on a remote homeserver, you should
instead use one of the other APIs.</p>
<p>Request:</p>
<pre><code>POST /_synapse/admin/v1/user/&lt;user_id&gt;/media/quarantine

{}
</code></pre>
<p>URL Parameters</p>
<ul>
<li><code>user_id</code>: string - User ID in the form of <code>@bob:example.org</code></li>
</ul>
<p>Response:</p>
<pre><code class="language-json">{
  &quot;num_quarantined&quot;: 10
}
</code></pre>
<p>The following fields are returned in the JSON response body:</p>
<ul>
<li><code>num_quarantined</code>: integer - The number of media items successfully quarantined</li>
</ul>
<h2 id="protecting-media-from-being-quarantined"><a class="header" href="#protecting-media-from-being-quarantined">Protecting media from being quarantined</a></h2>
<p>This API protects a single piece of local media from being quarantined using the
above APIs. This is useful for sticker packs and other shared media which you do
not want to get quarantined, especially when
<a href="usage/administration/admin_api/media_admin_api.html#quarantining-media-in-a-room">quarantining media in a room</a>.</p>
<p>Request:</p>
<pre><code>POST /_synapse/admin/v1/media/protect/&lt;media_id&gt;

{}
</code></pre>
<p>Where <code>media_id</code> is in the  form of <code>abcdefg12345...</code>.</p>
<p>Response:</p>
<pre><code class="language-json">{}
</code></pre>
<h1 id="delete-local-media"><a class="header" href="#delete-local-media">Delete local media</a></h1>
<p>This API deletes the <em>local</em> media from the disk of your own server.
This includes any local thumbnails and copies of media downloaded from
remote homeservers.
This API will not affect media that has been uploaded to external
media repositories (e.g https://github.com/turt2live/matrix-media-repo/).
See also <a href="usage/administration/admin_api/media_admin_api.html#purge-remote-media-api">Purge Remote Media API</a>.</p>
<h2 id="delete-a-specific-local-media"><a class="header" href="#delete-a-specific-local-media">Delete a specific local media</a></h2>
<p>Delete a specific <code>media_id</code>.</p>
<p>Request:</p>
<pre><code>DELETE /_synapse/admin/v1/media/&lt;server_name&gt;/&lt;media_id&gt;

{}
</code></pre>
<p>URL Parameters</p>
<ul>
<li><code>server_name</code>: string - The name of your local server (e.g <code>matrix.org</code>)</li>
<li><code>media_id</code>: string - The ID of the media (e.g <code>abcdefghijklmnopqrstuvwx</code>)</li>
</ul>
<p>Response:</p>
<pre><code class="language-json">{
  &quot;deleted_media&quot;: [
    &quot;abcdefghijklmnopqrstuvwx&quot;
  ],
  &quot;total&quot;: 1
}
</code></pre>
<p>The following fields are returned in the JSON response body:</p>
<ul>
<li><code>deleted_media</code>: an array of strings - List of deleted <code>media_id</code></li>
<li><code>total</code>: integer - Total number of deleted <code>media_id</code></li>
</ul>
<h2 id="delete-local-media-by-date-or-size"><a class="header" href="#delete-local-media-by-date-or-size">Delete local media by date or size</a></h2>
<p>Request:</p>
<pre><code>POST /_synapse/admin/v1/media/&lt;server_name&gt;/delete?before_ts=&lt;before_ts&gt;

{}
</code></pre>
<p>URL Parameters</p>
<ul>
<li><code>server_name</code>: string - The name of your local server (e.g <code>matrix.org</code>).</li>
<li><code>before_ts</code>: string representing a positive integer - Unix timestamp in ms.
Files that were last used before this timestamp will be deleted. It is the timestamp of
last access and not the timestamp creation. </li>
<li><code>size_gt</code>: Optional - string representing a positive integer - Size of the media in bytes.
Files that are larger will be deleted. Defaults to <code>0</code>.</li>
<li><code>keep_profiles</code>: Optional - string representing a boolean - Switch to also delete files
that are still used in image data (e.g user profile, room avatar).
If <code>false</code> these files will be deleted. Defaults to <code>true</code>.</li>
</ul>
<p>Response:</p>
<pre><code class="language-json">{
  &quot;deleted_media&quot;: [
    &quot;abcdefghijklmnopqrstuvwx&quot;,
    &quot;abcdefghijklmnopqrstuvwz&quot;
  ],
  &quot;total&quot;: 2
}
</code></pre>
<p>The following fields are returned in the JSON response body:</p>
<ul>
<li><code>deleted_media</code>: an array of strings - List of deleted <code>media_id</code></li>
<li><code>total</code>: integer - Total number of deleted <code>media_id</code></li>
</ul>
<h1 id="purge-remote-media-api"><a class="header" href="#purge-remote-media-api">Purge Remote Media API</a></h1>
<p>The purge remote media API allows server admins to purge old cached remote media.</p>
<p>The API is:</p>
<pre><code>POST /_synapse/admin/v1/purge_media_cache?before_ts=&lt;unix_timestamp_in_ms&gt;

{}
</code></pre>
<p>URL Parameters</p>
<ul>
<li><code>unix_timestamp_in_ms</code>: string representing a positive integer - Unix timestamp in ms.
All cached media that was last accessed before this timestamp will be removed.</li>
</ul>
<p>Response:</p>
<pre><code class="language-json">{
  &quot;deleted&quot;: 10
}
</code></pre>
<p>The following fields are returned in the JSON response body:</p>
<ul>
<li><code>deleted</code>: integer - The number of media items successfully deleted</li>
</ul>
<p>To use it, you will need to authenticate by providing an <code>access_token</code> for a
server admin: see <a href="usage/administration/admin_api/README.rst">README.rst</a>.</p>
<p>If the user re-requests purged remote media, synapse will re-request the media
from the originating server.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="purge-history"><a class="header" href="#purge-history">Purge History</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="deprecated-purge-room-api"><a class="header" href="#deprecated-purge-room-api">Deprecated: Purge room API</a></h1>
<p><strong>The old Purge room API is deprecated and will be removed in a future release.
See the new <a href="usage/administration/admin_api/rooms.html#delete-room-api">Delete Room API</a> for more details.</strong></p>
<p>This API will remove all trace of a room from your database.</p>
<p>All local users must have left the room before it can be removed.</p>
<p>The API is:</p>
<pre><code>POST /_synapse/admin/v1/purge_room

{
    &quot;room_id&quot;: &quot;!room:id&quot;
}
</code></pre>
<p>You must authenticate using the access token of an admin user.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="shared-secret-registration"><a class="header" href="#shared-secret-registration">Shared-Secret Registration</a></h1>
<p>This API allows for the creation of users in an administrative and
non-interactive way. This is generally used for bootstrapping a Synapse
instance with administrator accounts.</p>
<p>To authenticate yourself to the server, you will need both the shared secret
(<code>registration_shared_secret</code> in the homeserver configuration), and a
one-time nonce. If the registration shared secret is not configured, this API
is not enabled.</p>
<p>To fetch the nonce, you need to request one from the API::</p>
<blockquote>
<p>GET /_synapse/admin/v1/register</p>
</blockquote>
<p>&lt; {&quot;nonce&quot;: &quot;thisisanonce&quot;}</p>
<p>Once you have the nonce, you can make a <code>POST</code> to the same URL with a JSON
body containing the nonce, username, password, whether they are an admin
(optional, False by default), and a HMAC digest of the content. Also you can
set the displayname (optional, <code>username</code> by default).</p>
<p>As an example::</p>
<blockquote>
<p>POST /_synapse/admin/v1/register
{
&quot;nonce&quot;: &quot;thisisanonce&quot;,
&quot;username&quot;: &quot;pepper_roni&quot;,
&quot;displayname&quot;: &quot;Pepper Roni&quot;,
&quot;password&quot;: &quot;pizza&quot;,
&quot;admin&quot;: true,
&quot;mac&quot;: &quot;mac_digest_here&quot;
}</p>
</blockquote>
<p>&lt; {
&quot;access_token&quot;: &quot;token_here&quot;,
&quot;user_id&quot;: &quot;@pepper_roni:localhost&quot;,
&quot;home_server&quot;: &quot;test&quot;,
&quot;device_id&quot;: &quot;device_id_here&quot;
}</p>
<p>The MAC is the hex digest output of the HMAC-SHA1 algorithm, with the key being
the shared secret and the content being the nonce, user, password, either the
string &quot;admin&quot; or &quot;notadmin&quot;, and optionally the user_type
each separated by NULs. For an example of generation in Python::</p>
<p>import hmac, hashlib</p>
<p>def generate_mac(nonce, user, password, admin=False, user_type=None):</p>
<pre><code>  mac = hmac.new(
    key=shared_secret,
    digestmod=hashlib.sha1,
  )

  mac.update(nonce.encode('utf8'))
  mac.update(b&quot;\x00&quot;)
  mac.update(user.encode('utf8'))
  mac.update(b&quot;\x00&quot;)
  mac.update(password.encode('utf8'))
  mac.update(b&quot;\x00&quot;)
  mac.update(b&quot;admin&quot; if admin else b&quot;notadmin&quot;)
  if user_type:
      mac.update(b&quot;\x00&quot;)
      mac.update(user_type.encode('utf8'))

  return mac.hexdigest()
</code></pre>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="edit-room-membership-api"><a class="header" href="#edit-room-membership-api">Edit Room Membership API</a></h1>
<p>This API allows an administrator to join an user account with a given <code>user_id</code>
to a room with a given <code>room_id_or_alias</code>. You can only modify the membership of
local users. The server administrator must be in the room and have permission to
invite users.</p>
<h2 id="parameters"><a class="header" href="#parameters">Parameters</a></h2>
<p>The following parameters are available:</p>
<ul>
<li><code>user_id</code> - Fully qualified user: for example, <code>@user:server.com</code>.</li>
<li><code>room_id_or_alias</code> - The room identifier or alias to join: for example,
<code>!636q39766251:server.com</code>.</li>
</ul>
<h2 id="usage-1"><a class="header" href="#usage-1">Usage</a></h2>
<pre><code>POST /_synapse/admin/v1/join/&lt;room_id_or_alias&gt;

{
  &quot;user_id&quot;: &quot;@user:server.com&quot;
}
</code></pre>
<p>To use it, you will need to authenticate by providing an <code>access_token</code> for a
server admin: see <a href="usage/administration/admin_api/README.rst">README.rst</a>.</p>
<p>Response:</p>
<pre><code>{
  &quot;room_id&quot;: &quot;!636q39766251:server.com&quot;
}
</code></pre>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="contents-1"><a class="header" href="#contents-1">Contents</a></h1>
<ul>
<li><a href="usage/administration/admin_api/rooms.html#list-room-api">List Room API</a>
<ul>
<li><a href="usage/administration/admin_api/rooms.html#parameters">Parameters</a></li>
<li><a href="usage/administration/admin_api/rooms.html#usage">Usage</a></li>
</ul>
</li>
<li><a href="usage/administration/admin_api/rooms.html#room-details-api">Room Details API</a></li>
<li><a href="usage/administration/admin_api/rooms.html#room-members-api">Room Members API</a></li>
<li><a href="usage/administration/admin_api/rooms.html#delete-room-api">Delete Room API</a>
<ul>
<li><a href="usage/administration/admin_api/rooms.html#parameters-1">Parameters</a></li>
<li><a href="usage/administration/admin_api/rooms.html#response">Response</a></li>
<li><a href="usage/administration/admin_api/rooms.html#undoing-room-shutdowns">Undoing room shutdowns</a></li>
</ul>
</li>
<li><a href="usage/administration/admin_api/rooms.html#make-room-admin-api">Make Room Admin API</a></li>
<li><a href="usage/administration/admin_api/rooms.html#forward-extremities-admin-api">Forward Extremities Admin API</a></li>
<li><a href="usage/administration/admin_api/rooms.html#event-context-api">Event Context API</a></li>
</ul>
<h1 id="list-room-api"><a class="header" href="#list-room-api">List Room API</a></h1>
<p>The List Room admin API allows server admins to get a list of rooms on their
server. There are various parameters available that allow for filtering and
sorting the returned list. This API supports pagination.</p>
<h2 id="parameters-1"><a class="header" href="#parameters-1">Parameters</a></h2>
<p>The following query parameters are available:</p>
<ul>
<li><code>from</code> - Offset in the returned list. Defaults to <code>0</code>.</li>
<li><code>limit</code> - Maximum amount of rooms to return. Defaults to <code>100</code>.</li>
<li><code>order_by</code> - The method in which to sort the returned list of rooms. Valid values are:
<ul>
<li><code>alphabetical</code> - Same as <code>name</code>. This is deprecated.</li>
<li><code>size</code> - Same as <code>joined_members</code>. This is deprecated.</li>
<li><code>name</code> - Rooms are ordered alphabetically by room name. This is the default.</li>
<li><code>canonical_alias</code> - Rooms are ordered alphabetically by main alias address of the room.</li>
<li><code>joined_members</code> - Rooms are ordered by the number of members. Largest to smallest.</li>
<li><code>joined_local_members</code> - Rooms are ordered by the number of local members. Largest to smallest.</li>
<li><code>version</code> - Rooms are ordered by room version. Largest to smallest.</li>
<li><code>creator</code> - Rooms are ordered alphabetically by creator of the room.</li>
<li><code>encryption</code> - Rooms are ordered alphabetically by the end-to-end encryption algorithm.</li>
<li><code>federatable</code> - Rooms are ordered by whether the room is federatable.</li>
<li><code>public</code> - Rooms are ordered by visibility in room list.</li>
<li><code>join_rules</code> - Rooms are ordered alphabetically by join rules of the room.</li>
<li><code>guest_access</code> - Rooms are ordered alphabetically by guest access option of the room.</li>
<li><code>history_visibility</code> - Rooms are ordered alphabetically by visibility of history of the room.</li>
<li><code>state_events</code> - Rooms are ordered by number of state events. Largest to smallest.</li>
</ul>
</li>
<li><code>dir</code> - Direction of room order. Either <code>f</code> for forwards or <code>b</code> for backwards. Setting
this value to <code>b</code> will reverse the above sort order. Defaults to <code>f</code>.</li>
<li><code>search_term</code> - Filter rooms by their room name. Search term can be contained in any
part of the room name. Defaults to no filtering.</li>
</ul>
<p>The following fields are possible in the JSON response body:</p>
<ul>
<li><code>rooms</code> - An array of objects, each containing information about a room.
<ul>
<li>Room objects contain the following fields:
<ul>
<li><code>room_id</code> - The ID of the room.</li>
<li><code>name</code> - The name of the room.</li>
<li><code>canonical_alias</code> - The canonical (main) alias address of the room.</li>
<li><code>joined_members</code> - How many users are currently in the room.</li>
<li><code>joined_local_members</code> - How many local users are currently in the room.</li>
<li><code>version</code> - The version of the room as a string.</li>
<li><code>creator</code> - The <code>user_id</code> of the room creator.</li>
<li><code>encryption</code> - Algorithm of end-to-end encryption of messages. Is <code>null</code> if encryption is not active.</li>
<li><code>federatable</code> - Whether users on other servers can join this room.</li>
<li><code>public</code> - Whether the room is visible in room directory.</li>
<li><code>join_rules</code> - The type of rules used for users wishing to join this room. One of: [&quot;public&quot;, &quot;knock&quot;, &quot;invite&quot;, &quot;private&quot;].</li>
<li><code>guest_access</code> - Whether guests can join the room. One of: [&quot;can_join&quot;, &quot;forbidden&quot;].</li>
<li><code>history_visibility</code> - Who can see the room history. One of: [&quot;invited&quot;, &quot;joined&quot;, &quot;shared&quot;, &quot;world_readable&quot;].</li>
<li><code>state_events</code> - Total number of state_events of a room. Complexity of the room.</li>
</ul>
</li>
</ul>
</li>
<li><code>offset</code> - The current pagination offset in rooms. This parameter should be
used instead of <code>next_token</code> for room offset as <code>next_token</code> is
not intended to be parsed.</li>
<li><code>total_rooms</code> - The total number of rooms this query can return. Using this
and <code>offset</code>, you have enough information to know the current
progression through the list.</li>
<li><code>next_batch</code> - If this field is present, we know that there are potentially
more rooms on the server that did not all fit into this response.
We can use <code>next_batch</code> to get the &quot;next page&quot; of results. To do
so, simply repeat your request, setting the <code>from</code> parameter to
the value of <code>next_batch</code>.</li>
<li><code>prev_batch</code> - If this field is present, it is possible to paginate backwards.
Use <code>prev_batch</code> for the <code>from</code> value in the next request to
get the &quot;previous page&quot; of results.</li>
</ul>
<h2 id="usage-2"><a class="header" href="#usage-2">Usage</a></h2>
<p>A standard request with no filtering:</p>
<pre><code>GET /_synapse/admin/v1/rooms

{}
</code></pre>
<p>Response:</p>
<pre><code class="language-jsonc">{
  &quot;rooms&quot;: [
    {
      &quot;room_id&quot;: &quot;!OGEhHVWSdvArJzumhm:matrix.org&quot;,
      &quot;name&quot;: &quot;Matrix HQ&quot;,
      &quot;canonical_alias&quot;: &quot;#matrix:matrix.org&quot;,
      &quot;joined_members&quot;: 8326,
      &quot;joined_local_members&quot;: 2,
      &quot;version&quot;: &quot;1&quot;,
      &quot;creator&quot;: &quot;@foo:matrix.org&quot;,
      &quot;encryption&quot;: null,
      &quot;federatable&quot;: true,
      &quot;public&quot;: true,
      &quot;join_rules&quot;: &quot;invite&quot;,
      &quot;guest_access&quot;: null,
      &quot;history_visibility&quot;: &quot;shared&quot;,
      &quot;state_events&quot;: 93534
    },
    ... (8 hidden items) ...
    {
      &quot;room_id&quot;: &quot;!xYvNcQPhnkrdUmYczI:matrix.org&quot;,
      &quot;name&quot;: &quot;This Week In Matrix (TWIM)&quot;,
      &quot;canonical_alias&quot;: &quot;#twim:matrix.org&quot;,
      &quot;joined_members&quot;: 314,
      &quot;joined_local_members&quot;: 20,
      &quot;version&quot;: &quot;4&quot;,
      &quot;creator&quot;: &quot;@foo:matrix.org&quot;,
      &quot;encryption&quot;: &quot;m.megolm.v1.aes-sha2&quot;,
      &quot;federatable&quot;: true,
      &quot;public&quot;: false,
      &quot;join_rules&quot;: &quot;invite&quot;,
      &quot;guest_access&quot;: null,
      &quot;history_visibility&quot;: &quot;shared&quot;,
      &quot;state_events&quot;: 8345
    }
  ],
  &quot;offset&quot;: 0,
  &quot;total_rooms&quot;: 10
}
</code></pre>
<p>Filtering by room name:</p>
<pre><code>GET /_synapse/admin/v1/rooms?search_term=TWIM

{}
</code></pre>
<p>Response:</p>
<pre><code class="language-json">{
  &quot;rooms&quot;: [
    {
      &quot;room_id&quot;: &quot;!xYvNcQPhnkrdUmYczI:matrix.org&quot;,
      &quot;name&quot;: &quot;This Week In Matrix (TWIM)&quot;,
      &quot;canonical_alias&quot;: &quot;#twim:matrix.org&quot;,
      &quot;joined_members&quot;: 314,
      &quot;joined_local_members&quot;: 20,
      &quot;version&quot;: &quot;4&quot;,
      &quot;creator&quot;: &quot;@foo:matrix.org&quot;,
      &quot;encryption&quot;: &quot;m.megolm.v1.aes-sha2&quot;,
      &quot;federatable&quot;: true,
      &quot;public&quot;: false,
      &quot;join_rules&quot;: &quot;invite&quot;,
      &quot;guest_access&quot;: null,
      &quot;history_visibility&quot;: &quot;shared&quot;,
      &quot;state_events&quot;: 8
    }
  ],
  &quot;offset&quot;: 0,
  &quot;total_rooms&quot;: 1
}
</code></pre>
<p>Paginating through a list of rooms:</p>
<pre><code>GET /_synapse/admin/v1/rooms?order_by=size

{}
</code></pre>
<p>Response:</p>
<pre><code class="language-jsonc">{
  &quot;rooms&quot;: [
    {
      &quot;room_id&quot;: &quot;!OGEhHVWSdvArJzumhm:matrix.org&quot;,
      &quot;name&quot;: &quot;Matrix HQ&quot;,
      &quot;canonical_alias&quot;: &quot;#matrix:matrix.org&quot;,
      &quot;joined_members&quot;: 8326,
      &quot;joined_local_members&quot;: 2,
      &quot;version&quot;: &quot;1&quot;,
      &quot;creator&quot;: &quot;@foo:matrix.org&quot;,
      &quot;encryption&quot;: null,
      &quot;federatable&quot;: true,
      &quot;public&quot;: true,
      &quot;join_rules&quot;: &quot;invite&quot;,
      &quot;guest_access&quot;: null,
      &quot;history_visibility&quot;: &quot;shared&quot;,
      &quot;state_events&quot;: 93534
    },
    ... (98 hidden items) ...
    {
      &quot;room_id&quot;: &quot;!xYvNcQPhnkrdUmYczI:matrix.org&quot;,
      &quot;name&quot;: &quot;This Week In Matrix (TWIM)&quot;,
      &quot;canonical_alias&quot;: &quot;#twim:matrix.org&quot;,
      &quot;joined_members&quot;: 314,
      &quot;joined_local_members&quot;: 20,
      &quot;version&quot;: &quot;4&quot;,
      &quot;creator&quot;: &quot;@foo:matrix.org&quot;,
      &quot;encryption&quot;: &quot;m.megolm.v1.aes-sha2&quot;,
      &quot;federatable&quot;: true,
      &quot;public&quot;: false,
      &quot;join_rules&quot;: &quot;invite&quot;,
      &quot;guest_access&quot;: null,
      &quot;history_visibility&quot;: &quot;shared&quot;,
      &quot;state_events&quot;: 8345
    }
  ],
  &quot;offset&quot;: 0,
  &quot;total_rooms&quot;: 150
  &quot;next_token&quot;: 100
}
</code></pre>
<p>The presence of the <code>next_token</code> parameter tells us that there are more rooms
than returned in this request, and we need to make another request to get them.
To get the next batch of room results, we repeat our request, setting the <code>from</code>
parameter to the value of <code>next_token</code>.</p>
<pre><code>GET /_synapse/admin/v1/rooms?order_by=size&amp;from=100

{}
</code></pre>
<p>Response:</p>
<pre><code class="language-jsonc">{
  &quot;rooms&quot;: [
    {
      &quot;room_id&quot;: &quot;!mscvqgqpHYjBGDxNym:matrix.org&quot;,
      &quot;name&quot;: &quot;Music Theory&quot;,
      &quot;canonical_alias&quot;: &quot;#musictheory:matrix.org&quot;,
      &quot;joined_members&quot;: 127,
      &quot;joined_local_members&quot;: 2,
      &quot;version&quot;: &quot;1&quot;,
      &quot;creator&quot;: &quot;@foo:matrix.org&quot;,
      &quot;encryption&quot;: null,
      &quot;federatable&quot;: true,
      &quot;public&quot;: true,
      &quot;join_rules&quot;: &quot;invite&quot;,
      &quot;guest_access&quot;: null,
      &quot;history_visibility&quot;: &quot;shared&quot;,
      &quot;state_events&quot;: 93534
    },
    ... (48 hidden items) ...
    {
      &quot;room_id&quot;: &quot;!twcBhHVdZlQWuuxBhN:termina.org.uk&quot;,
      &quot;name&quot;: &quot;weechat-matrix&quot;,
      &quot;canonical_alias&quot;: &quot;#weechat-matrix:termina.org.uk&quot;,
      &quot;joined_members&quot;: 137,
      &quot;joined_local_members&quot;: 20,
      &quot;version&quot;: &quot;4&quot;,
      &quot;creator&quot;: &quot;@foo:termina.org.uk&quot;,
      &quot;encryption&quot;: null,
      &quot;federatable&quot;: true,
      &quot;public&quot;: true,
      &quot;join_rules&quot;: &quot;invite&quot;,
      &quot;guest_access&quot;: null,
      &quot;history_visibility&quot;: &quot;shared&quot;,
      &quot;state_events&quot;: 8345
    }
  ],
  &quot;offset&quot;: 100,
  &quot;prev_batch&quot;: 0,
  &quot;total_rooms&quot;: 150
}
</code></pre>
<p>Once the <code>next_token</code> parameter is no longer present, we know we've reached the
end of the list.</p>
<h1 id="room-details-api"><a class="header" href="#room-details-api">Room Details API</a></h1>
<p>The Room Details admin API allows server admins to get all details of a room.</p>
<p>The following fields are possible in the JSON response body:</p>
<ul>
<li><code>room_id</code> - The ID of the room.</li>
<li><code>name</code> - The name of the room.</li>
<li><code>topic</code> - The topic of the room.</li>
<li><code>avatar</code> - The <code>mxc</code> URI to the avatar of the room.</li>
<li><code>canonical_alias</code> - The canonical (main) alias address of the room.</li>
<li><code>joined_members</code> - How many users are currently in the room.</li>
<li><code>joined_local_members</code> - How many local users are currently in the room.</li>
<li><code>joined_local_devices</code> - How many local devices are currently in the room.</li>
<li><code>version</code> - The version of the room as a string.</li>
<li><code>creator</code> - The <code>user_id</code> of the room creator.</li>
<li><code>encryption</code> - Algorithm of end-to-end encryption of messages. Is <code>null</code> if encryption is not active.</li>
<li><code>federatable</code> - Whether users on other servers can join this room.</li>
<li><code>public</code> - Whether the room is visible in room directory.</li>
<li><code>join_rules</code> - The type of rules used for users wishing to join this room. One of: [&quot;public&quot;, &quot;knock&quot;, &quot;invite&quot;, &quot;private&quot;].</li>
<li><code>guest_access</code> - Whether guests can join the room. One of: [&quot;can_join&quot;, &quot;forbidden&quot;].</li>
<li><code>history_visibility</code> - Who can see the room history. One of: [&quot;invited&quot;, &quot;joined&quot;, &quot;shared&quot;, &quot;world_readable&quot;].</li>
<li><code>state_events</code> - Total number of state_events of a room. Complexity of the room.</li>
</ul>
<h2 id="usage-3"><a class="header" href="#usage-3">Usage</a></h2>
<p>A standard request:</p>
<pre><code>GET /_synapse/admin/v1/rooms/&lt;room_id&gt;

{}
</code></pre>
<p>Response:</p>
<pre><code class="language-json">{
  &quot;room_id&quot;: &quot;!mscvqgqpHYjBGDxNym:matrix.org&quot;,
  &quot;name&quot;: &quot;Music Theory&quot;,
  &quot;avatar&quot;: &quot;mxc://matrix.org/AQDaVFlbkQoErdOgqWRgiGSV&quot;,
  &quot;topic&quot;: &quot;Theory, Composition, Notation, Analysis&quot;,
  &quot;canonical_alias&quot;: &quot;#musictheory:matrix.org&quot;,
  &quot;joined_members&quot;: 127,
  &quot;joined_local_members&quot;: 2,
  &quot;joined_local_devices&quot;: 2,
  &quot;version&quot;: &quot;1&quot;,
  &quot;creator&quot;: &quot;@foo:matrix.org&quot;,
  &quot;encryption&quot;: null,
  &quot;federatable&quot;: true,
  &quot;public&quot;: true,
  &quot;join_rules&quot;: &quot;invite&quot;,
  &quot;guest_access&quot;: null,
  &quot;history_visibility&quot;: &quot;shared&quot;,
  &quot;state_events&quot;: 93534
}
</code></pre>
<h1 id="room-members-api"><a class="header" href="#room-members-api">Room Members API</a></h1>
<p>The Room Members admin API allows server admins to get a list of all members of a room.</p>
<p>The response includes the following fields:</p>
<ul>
<li><code>members</code> - A list of all the members that are present in the room, represented by their ids.</li>
<li><code>total</code> - Total number of members in the room.</li>
</ul>
<h2 id="usage-4"><a class="header" href="#usage-4">Usage</a></h2>
<p>A standard request:</p>
<pre><code>GET /_synapse/admin/v1/rooms/&lt;room_id&gt;/members

{}
</code></pre>
<p>Response:</p>
<pre><code class="language-json">{
  &quot;members&quot;: [
    &quot;@foo:matrix.org&quot;,
    &quot;@bar:matrix.org&quot;,
    &quot;@foobar:matrix.org&quot;
  ],
  &quot;total&quot;: 3
}
</code></pre>
<h1 id="room-state-api"><a class="header" href="#room-state-api">Room State API</a></h1>
<p>The Room State admin API allows server admins to get a list of all state events in a room.</p>
<p>The response includes the following fields:</p>
<ul>
<li><code>state</code> - The current state of the room at the time of request.</li>
</ul>
<h2 id="usage-5"><a class="header" href="#usage-5">Usage</a></h2>
<p>A standard request:</p>
<pre><code>GET /_synapse/admin/v1/rooms/&lt;room_id&gt;/state

{}
</code></pre>
<p>Response:</p>
<pre><code class="language-json">{
  &quot;state&quot;: [
    {&quot;type&quot;: &quot;m.room.create&quot;, &quot;state_key&quot;: &quot;&quot;, &quot;etc&quot;: true},
    {&quot;type&quot;: &quot;m.room.power_levels&quot;, &quot;state_key&quot;: &quot;&quot;, &quot;etc&quot;: true},
    {&quot;type&quot;: &quot;m.room.name&quot;, &quot;state_key&quot;: &quot;&quot;, &quot;etc&quot;: true}
  ]
}
</code></pre>
<h1 id="delete-room-api"><a class="header" href="#delete-room-api">Delete Room API</a></h1>
<p>The Delete Room admin API allows server admins to remove rooms from server
and block these rooms.</p>
<p>Shuts down a room. Moves all local users and room aliases automatically to a
new room if <code>new_room_user_id</code> is set. Otherwise local users only
leave the room without any information.</p>
<p>The new room will be created with the user specified by the <code>new_room_user_id</code> parameter
as room administrator and will contain a message explaining what happened. Users invited
to the new room will have power level <code>-10</code> by default, and thus be unable to speak.</p>
<p>If <code>block</code> is <code>True</code> it prevents new joins to the old room.</p>
<p>This API will remove all trace of the old room from your database after removing
all local users. If <code>purge</code> is <code>true</code> (the default), all traces of the old room will
be removed from your database after removing all local users. If you do not want
this to happen, set <code>purge</code> to <code>false</code>.
Depending on the amount of history being purged a call to the API may take
several minutes or longer.</p>
<p>The local server will only have the power to move local user and room aliases to
the new room. Users on other servers will be unaffected.</p>
<p>The API is:</p>
<pre><code>DELETE /_synapse/admin/v1/rooms/&lt;room_id&gt;
</code></pre>
<p>with a body of:</p>
<pre><code class="language-json">{
    &quot;new_room_user_id&quot;: &quot;@someuser:example.com&quot;,
    &quot;room_name&quot;: &quot;Content Violation Notification&quot;,
    &quot;message&quot;: &quot;Bad Room has been shutdown due to content violations on this server. Please review our Terms of Service.&quot;,
    &quot;block&quot;: true,
    &quot;purge&quot;: true
}
</code></pre>
<p>To use it, you will need to authenticate by providing an <code>access_token</code> for a
server admin: see <a href="usage/administration/admin_api/README.rst">README.rst</a>.</p>
<p>A response body like the following is returned:</p>
<pre><code class="language-json">{
    &quot;kicked_users&quot;: [
        &quot;@foobar:example.com&quot;
    ],
    &quot;failed_to_kick_users&quot;: [],
    &quot;local_aliases&quot;: [
        &quot;#badroom:example.com&quot;,
        &quot;#evilsaloon:example.com&quot;
    ],
    &quot;new_room_id&quot;: &quot;!newroomid:example.com&quot;
}
</code></pre>
<h2 id="parameters-2"><a class="header" href="#parameters-2">Parameters</a></h2>
<p>The following parameters should be set in the URL:</p>
<ul>
<li><code>room_id</code> - The ID of the room.</li>
</ul>
<p>The following JSON body parameters are available:</p>
<ul>
<li><code>new_room_user_id</code> - Optional. If set, a new room will be created with this user ID
as the creator and admin, and all users in the old room will be moved into that
room. If not set, no new room will be created and the users will just be removed
from the old room. The user ID must be on the local server, but does not necessarily
have to belong to a registered user.</li>
<li><code>room_name</code> - Optional. A string representing the name of the room that new users will be
invited to. Defaults to <code>Content Violation Notification</code></li>
<li><code>message</code> - Optional. A string containing the first message that will be sent as
<code>new_room_user_id</code> in the new room. Ideally this will clearly convey why the
original room was shut down. Defaults to <code>Sharing illegal content on this server is not permitted and rooms in violation will be blocked.</code></li>
<li><code>block</code> - Optional. If set to <code>true</code>, this room will be added to a blocking list, preventing
future attempts to join the room. Defaults to <code>false</code>.</li>
<li><code>purge</code> - Optional. If set to <code>true</code>, it will remove all traces of the room from your database.
Defaults to <code>true</code>.</li>
<li><code>force_purge</code> - Optional, and ignored unless <code>purge</code> is <code>true</code>. If set to <code>true</code>, it
will force a purge to go ahead even if there are local users still in the room. Do not
use this unless a regular <code>purge</code> operation fails, as it could leave those users'
clients in a confused state.</li>
</ul>
<p>The JSON body must not be empty. The body must be at least <code>{}</code>.</p>
<h2 id="response"><a class="header" href="#response">Response</a></h2>
<p>The following fields are returned in the JSON response body:</p>
<ul>
<li><code>kicked_users</code> - An array of users (<code>user_id</code>) that were kicked.</li>
<li><code>failed_to_kick_users</code> - An array of users (<code>user_id</code>) that that were not kicked.</li>
<li><code>local_aliases</code> - An array of strings representing the local aliases that were migrated from
the old room to the new.</li>
<li><code>new_room_id</code> - A string representing the room ID of the new room.</li>
</ul>
<h2 id="undoing-room-shutdowns"><a class="header" href="#undoing-room-shutdowns">Undoing room shutdowns</a></h2>
<p><em>Note</em>: This guide may be outdated by the time you read it. By nature of room shutdowns being performed at the database level,
the structure can and does change without notice.</p>
<p>First, it's important to understand that a room shutdown is very destructive. Undoing a shutdown is not as simple as pretending it
never happened - work has to be done to move forward instead of resetting the past. In fact, in some cases it might not be possible
to recover at all:</p>
<ul>
<li>If the room was invite-only, your users will need to be re-invited.</li>
<li>If the room no longer has any members at all, it'll be impossible to rejoin.</li>
<li>The first user to rejoin will have to do so via an alias on a different server.</li>
</ul>
<p>With all that being said, if you still want to try and recover the room:</p>
<ol>
<li>For safety reasons, shut down Synapse.</li>
<li>In the database, run <code>DELETE FROM blocked_rooms WHERE room_id = '!example:example.org';</code>
<ul>
<li>For caution: it's recommended to run this in a transaction: <code>BEGIN; DELETE ...;</code>, verify you got 1 result, then <code>COMMIT;</code>.</li>
<li>The room ID is the same one supplied to the shutdown room API, not the Content Violation room.</li>
</ul>
</li>
<li>Restart Synapse.</li>
</ol>
<p>You will have to manually handle, if you so choose, the following:</p>
<ul>
<li>Aliases that would have been redirected to the Content Violation room.</li>
<li>Users that would have been booted from the room (and will have been force-joined to the Content Violation room).</li>
<li>Removal of the Content Violation room if desired.</li>
</ul>
<h2 id="deprecated-endpoint"><a class="header" href="#deprecated-endpoint">Deprecated endpoint</a></h2>
<p>The previous deprecated API will be removed in a future release, it was:</p>
<pre><code>POST /_synapse/admin/v1/rooms/&lt;room_id&gt;/delete
</code></pre>
<p>It behaves the same way than the current endpoint except the path and the method.</p>
<h1 id="make-room-admin-api"><a class="header" href="#make-room-admin-api">Make Room Admin API</a></h1>
<p>Grants another user the highest power available to a local user who is in the room.
If the user is not in the room, and it is not publicly joinable, then invite the user.</p>
<p>By default the server admin (the caller) is granted power, but another user can
optionally be specified, e.g.:</p>
<pre><code>    POST /_synapse/admin/v1/rooms/&lt;room_id_or_alias&gt;/make_room_admin
    {
        &quot;user_id&quot;: &quot;@foo:example.com&quot;
    }
</code></pre>
<h1 id="forward-extremities-admin-api"><a class="header" href="#forward-extremities-admin-api">Forward Extremities Admin API</a></h1>
<p>Enables querying and deleting forward extremities from rooms. When a lot of forward
extremities accumulate in a room, performance can become degraded. For details, see 
<a href="https://github.com/matrix-org/synapse/issues/1760">#1760</a>.</p>
<h2 id="check-for-forward-extremities"><a class="header" href="#check-for-forward-extremities">Check for forward extremities</a></h2>
<p>To check the status of forward extremities for a room:</p>
<pre><code>    GET /_synapse/admin/v1/rooms/&lt;room_id_or_alias&gt;/forward_extremities
</code></pre>
<p>A response as follows will be returned:</p>
<pre><code class="language-json">{
  &quot;count&quot;: 1,
  &quot;results&quot;: [
    {
      &quot;event_id&quot;: &quot;$M5SP266vsnxctfwFgFLNceaCo3ujhRtg_NiiHabcdefgh&quot;,
      &quot;state_group&quot;: 439,
      &quot;depth&quot;: 123,
      &quot;received_ts&quot;: 1611263016761
    }
  ]
}    
</code></pre>
<h2 id="deleting-forward-extremities"><a class="header" href="#deleting-forward-extremities">Deleting forward extremities</a></h2>
<p><strong>WARNING</strong>: Please ensure you know what you're doing and have read 
the related issue <a href="https://github.com/matrix-org/synapse/issues/1760">#1760</a>.
Under no situations should this API be executed as an automated maintenance task!</p>
<p>If a room has lots of forward extremities, the extra can be
deleted as follows:</p>
<pre><code>    DELETE /_synapse/admin/v1/rooms/&lt;room_id_or_alias&gt;/forward_extremities
</code></pre>
<p>A response as follows will be returned, indicating the amount of forward extremities
that were deleted.</p>
<pre><code class="language-json">{
  &quot;deleted&quot;: 1
}
</code></pre>
<h1 id="event-context-api"><a class="header" href="#event-context-api">Event Context API</a></h1>
<p>This API lets a client find the context of an event. This is designed primarily to investigate abuse reports.</p>
<pre><code>GET /_synapse/admin/v1/rooms/&lt;room_id&gt;/context/&lt;event_id&gt;
</code></pre>
<p>This API mimmicks <a href="https://matrix.org/docs/spec/client_server/r0.6.1#get-matrix-client-r0-rooms-roomid-context-eventid">GET /_matrix/client/r0/rooms/{roomId}/context/{eventId}</a>. Please refer to the link for all details on parameters and reseponse.</p>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;end&quot;: &quot;t29-57_2_0_2&quot;,
  &quot;events_after&quot;: [
    {
      &quot;content&quot;: {
        &quot;body&quot;: &quot;This is an example text message&quot;,
        &quot;msgtype&quot;: &quot;m.text&quot;,
        &quot;format&quot;: &quot;org.matrix.custom.html&quot;,
        &quot;formatted_body&quot;: &quot;&lt;b&gt;This is an example text message&lt;/b&gt;&quot;
      },
      &quot;type&quot;: &quot;m.room.message&quot;,
      &quot;event_id&quot;: &quot;$143273582443PhrSn:example.org&quot;,
      &quot;room_id&quot;: &quot;!636q39766251:example.com&quot;,
      &quot;sender&quot;: &quot;@example:example.org&quot;,
      &quot;origin_server_ts&quot;: 1432735824653,
      &quot;unsigned&quot;: {
        &quot;age&quot;: 1234
      }
    }
  ],
  &quot;event&quot;: {
    &quot;content&quot;: {
      &quot;body&quot;: &quot;filename.jpg&quot;,
      &quot;info&quot;: {
        &quot;h&quot;: 398,
        &quot;w&quot;: 394,
        &quot;mimetype&quot;: &quot;image/jpeg&quot;,
        &quot;size&quot;: 31037
      },
      &quot;url&quot;: &quot;mxc://example.org/JWEIFJgwEIhweiWJE&quot;,
      &quot;msgtype&quot;: &quot;m.image&quot;
    },
    &quot;type&quot;: &quot;m.room.message&quot;,
    &quot;event_id&quot;: &quot;$f3h4d129462ha:example.com&quot;,
    &quot;room_id&quot;: &quot;!636q39766251:example.com&quot;,
    &quot;sender&quot;: &quot;@example:example.org&quot;,
    &quot;origin_server_ts&quot;: 1432735824653,
    &quot;unsigned&quot;: {
      &quot;age&quot;: 1234
    }
  },
  &quot;events_before&quot;: [
    {
      &quot;content&quot;: {
        &quot;body&quot;: &quot;something-important.doc&quot;,
        &quot;filename&quot;: &quot;something-important.doc&quot;,
        &quot;info&quot;: {
          &quot;mimetype&quot;: &quot;application/msword&quot;,
          &quot;size&quot;: 46144
        },
        &quot;msgtype&quot;: &quot;m.file&quot;,
        &quot;url&quot;: &quot;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&quot;
      },
      &quot;type&quot;: &quot;m.room.message&quot;,
      &quot;event_id&quot;: &quot;$143273582443PhrSn:example.org&quot;,
      &quot;room_id&quot;: &quot;!636q39766251:example.com&quot;,
      &quot;sender&quot;: &quot;@example:example.org&quot;,
      &quot;origin_server_ts&quot;: 1432735824653,
      &quot;unsigned&quot;: {
        &quot;age&quot;: 1234
      }
    }
  ],
  &quot;start&quot;: &quot;t27-54_2_0_2&quot;,
  &quot;state&quot;: [
    {
      &quot;content&quot;: {
        &quot;creator&quot;: &quot;@example:example.org&quot;,
        &quot;room_version&quot;: &quot;1&quot;,
        &quot;m.federate&quot;: true,
        &quot;predecessor&quot;: {
          &quot;event_id&quot;: &quot;$something:example.org&quot;,
          &quot;room_id&quot;: &quot;!oldroom:example.org&quot;
        }
      },
      &quot;type&quot;: &quot;m.room.create&quot;,
      &quot;event_id&quot;: &quot;$143273582443PhrSn:example.org&quot;,
      &quot;room_id&quot;: &quot;!636q39766251:example.com&quot;,
      &quot;sender&quot;: &quot;@example:example.org&quot;,
      &quot;origin_server_ts&quot;: 1432735824653,
      &quot;unsigned&quot;: {
        &quot;age&quot;: 1234
      },
      &quot;state_key&quot;: &quot;&quot;
    },
    {
      &quot;content&quot;: {
        &quot;membership&quot;: &quot;join&quot;,
        &quot;avatar_url&quot;: &quot;mxc://example.org/SEsfnsuifSDFSSEF&quot;,
        &quot;displayname&quot;: &quot;Alice Margatroid&quot;
      },
      &quot;type&quot;: &quot;m.room.member&quot;,
      &quot;event_id&quot;: &quot;$143273582443PhrSn:example.org&quot;,
      &quot;room_id&quot;: &quot;!636q39766251:example.com&quot;,
      &quot;sender&quot;: &quot;@example:example.org&quot;,
      &quot;origin_server_ts&quot;: 1432735824653,
      &quot;unsigned&quot;: {
        &quot;age&quot;: 1234
      },
      &quot;state_key&quot;: &quot;@alice:example.org&quot;
    }
  ]
}
</code></pre>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="server-notices-1"><a class="header" href="#server-notices-1">Server Notices</a></h1>
<p>The API to send notices is as follows:</p>
<pre><code>POST /_synapse/admin/v1/send_server_notice
</code></pre>
<p>or:</p>
<pre><code>PUT /_synapse/admin/v1/send_server_notice/{txnId}
</code></pre>
<p>You will need to authenticate with an access token for an admin user.</p>
<p>When using the <code>PUT</code> form, retransmissions with the same transaction ID will be
ignored in the same way as with <code>PUT /_matrix/client/r0/rooms/{roomId}/send/{eventType}/{txnId}</code>.</p>
<p>The request body should look something like the following:</p>
<pre><code class="language-json">{
    &quot;user_id&quot;: &quot;@target_user:server_name&quot;,
    &quot;content&quot;: {
        &quot;msgtype&quot;: &quot;m.text&quot;,
        &quot;body&quot;: &quot;This is my message&quot;
    }
}
</code></pre>
<p>You can optionally include the following additional parameters:</p>
<ul>
<li><code>type</code>: the type of event. Defaults to <code>m.room.message</code>.</li>
<li><code>state_key</code>: Setting this will result in a state event being sent.</li>
</ul>
<p>Once the notice has been sent, the API will return the following response:</p>
<pre><code class="language-json">{
    &quot;event_id&quot;: &quot;&lt;event_id&gt;&quot;
}
</code></pre>
<p>Note that server notices must be enabled in <code>homeserver.yaml</code> before this API
can be used. See <a href="usage/administration/admin_api/../../configuration/server_notices.html">server_notices.md</a> for more information.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="deprecated-shutdown-room-api"><a class="header" href="#deprecated-shutdown-room-api">Deprecated: Shutdown room API</a></h1>
<p><strong>The old Shutdown room API is deprecated and will be removed in a future release.
See the new <a href="usage/administration/admin_api/rooms.html#delete-room-api">Delete Room API</a> for more details.</strong></p>
<p>Shuts down a room, preventing new joins and moves local users and room aliases automatically
to a new room. The new room will be created with the user specified by the
<code>new_room_user_id</code> parameter as room administrator and will contain a message
explaining what happened. Users invited to the new room will have power level
-10 by default, and thus be unable to speak. The old room's power levels will be changed to
disallow any further invites or joins.</p>
<p>The local server will only have the power to move local user and room aliases to
the new room. Users on other servers will be unaffected.</p>
<h2 id="api-1"><a class="header" href="#api-1">API</a></h2>
<p>You will need to authenticate with an access token for an admin user.</p>
<h3 id="url"><a class="header" href="#url">URL</a></h3>
<p><code>POST /_synapse/admin/v1/shutdown_room/{room_id}</code></p>
<h3 id="url-parameters"><a class="header" href="#url-parameters">URL Parameters</a></h3>
<ul>
<li><code>room_id</code> - The ID of the room (e.g <code>!someroom:example.com</code>)</li>
</ul>
<h3 id="json-body-parameters"><a class="header" href="#json-body-parameters">JSON Body Parameters</a></h3>
<ul>
<li><code>new_room_user_id</code> - Required. A string representing the user ID of the user that will admin
the new room that all users in the old room will be moved to.</li>
<li><code>room_name</code> - Optional. A string representing the name of the room that new users will be
invited to.</li>
<li><code>message</code> - Optional. A string containing the first message that will be sent as
<code>new_room_user_id</code> in the new room. Ideally this will clearly convey why the
original room was shut down.</li>
</ul>
<p>If not specified, the default value of <code>room_name</code> is &quot;Content Violation
Notification&quot;. The default value of <code>message</code> is &quot;Sharing illegal content on
othis server is not permitted and rooms in violation will be blocked.&quot;</p>
<h3 id="response-parameters"><a class="header" href="#response-parameters">Response Parameters</a></h3>
<ul>
<li><code>kicked_users</code> - An integer number representing the number of users that
were kicked.</li>
<li><code>failed_to_kick_users</code> - An integer number representing the number of users
that were not kicked.</li>
<li><code>local_aliases</code> - An array of strings representing the local aliases that were migrated from
the old room to the new.</li>
<li><code>new_room_id</code> - A string representing the room ID of the new room.</li>
</ul>
<h2 id="example-3"><a class="header" href="#example-3">Example</a></h2>
<p>Request:</p>
<pre><code>POST /_synapse/admin/v1/shutdown_room/!somebadroom%3Aexample.com

{
    &quot;new_room_user_id&quot;: &quot;@someuser:example.com&quot;,
    &quot;room_name&quot;: &quot;Content Violation Notification&quot;,
    &quot;message&quot;: &quot;Bad Room has been shutdown due to content violations on this server. Please review our Terms of Service.&quot;
}
</code></pre>
<p>Response:</p>
<pre><code>{
    &quot;kicked_users&quot;: 5,
    &quot;failed_to_kick_users&quot;: 0,
    &quot;local_aliases&quot;: [&quot;#badroom:example.com&quot;, &quot;#evilsaloon:example.com],
    &quot;new_room_id&quot;: &quot;!newroomid:example.com&quot;,
},
</code></pre>
<h2 id="undoing-room-shutdowns-1"><a class="header" href="#undoing-room-shutdowns-1">Undoing room shutdowns</a></h2>
<p><em>Note</em>: This guide may be outdated by the time you read it. By nature of room shutdowns being performed at the database level,
the structure can and does change without notice.</p>
<p>First, it's important to understand that a room shutdown is very destructive. Undoing a shutdown is not as simple as pretending it
never happened - work has to be done to move forward instead of resetting the past. In fact, in some cases it might not be possible
to recover at all:</p>
<ul>
<li>If the room was invite-only, your users will need to be re-invited.</li>
<li>If the room no longer has any members at all, it'll be impossible to rejoin.</li>
<li>The first user to rejoin will have to do so via an alias on a different server.</li>
</ul>
<p>With all that being said, if you still want to try and recover the room:</p>
<ol>
<li>For safety reasons, shut down Synapse.</li>
<li>In the database, run <code>DELETE FROM blocked_rooms WHERE room_id = '!example:example.org';</code>
<ul>
<li>For caution: it's recommended to run this in a transaction: <code>BEGIN; DELETE ...;</code>, verify you got 1 result, then <code>COMMIT;</code>.</li>
<li>The room ID is the same one supplied to the shutdown room API, not the Content Violation room.</li>
</ul>
</li>
<li>Restart Synapse.</li>
</ol>
<p>You will have to manually handle, if you so choose, the following:</p>
<ul>
<li>Aliases that would have been redirected to the Content Violation room.</li>
<li>Users that would have been booted from the room (and will have been force-joined to the Content Violation room).</li>
<li>Removal of the Content Violation room if desired.</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="users-media-usage-statistics"><a class="header" href="#users-media-usage-statistics">Users' media usage statistics</a></h1>
<p>Returns information about all local media usage of users. Gives the
possibility to filter them by time and user.</p>
<p>The API is:</p>
<pre><code>GET /_synapse/admin/v1/statistics/users/media
</code></pre>
<p>To use it, you will need to authenticate by providing an <code>access_token</code>
for a server admin: see <a href="usage/administration/admin_api/README.rst">README.rst</a>.</p>
<p>A response body like the following is returned:</p>
<pre><code class="language-json">{
  &quot;users&quot;: [
    {
      &quot;displayname&quot;: &quot;foo_user_0&quot;,
      &quot;media_count&quot;: 2,
      &quot;media_length&quot;: 134,
      &quot;user_id&quot;: &quot;@foo_user_0:test&quot;
    },
    {
      &quot;displayname&quot;: &quot;foo_user_1&quot;,
      &quot;media_count&quot;: 2,
      &quot;media_length&quot;: 134,
      &quot;user_id&quot;: &quot;@foo_user_1:test&quot;
    }
  ],
  &quot;next_token&quot;: 3,
  &quot;total&quot;: 10
}
</code></pre>
<p>To paginate, check for <code>next_token</code> and if present, call the endpoint
again with <code>from</code> set to the value of <code>next_token</code>. This will return a new page.</p>
<p>If the endpoint does not return a <code>next_token</code> then there are no more
reports to paginate through.</p>
<p><strong>Parameters</strong></p>
<p>The following parameters should be set in the URL:</p>
<ul>
<li><code>limit</code>: string representing a positive integer - Is optional but is
used for pagination, denoting the maximum number of items to return
in this call. Defaults to <code>100</code>.</li>
<li><code>from</code>: string representing a positive integer - Is optional but used for pagination,
denoting the offset in the returned results. This should be treated as an opaque value
and not explicitly set to anything other than the return value of <code>next_token</code> from a
previous call. Defaults to <code>0</code>.</li>
<li><code>order_by</code> - string - The method in which to sort the returned list of users. Valid values are:
<ul>
<li><code>user_id</code> - Users are ordered alphabetically by <code>user_id</code>. This is the default.</li>
<li><code>displayname</code> - Users are ordered alphabetically by <code>displayname</code>.</li>
<li><code>media_length</code> - Users are ordered by the total size of uploaded media in bytes.
Smallest to largest.</li>
<li><code>media_count</code> - Users are ordered by number of uploaded media. Smallest to largest.</li>
</ul>
</li>
<li><code>from_ts</code> - string representing a positive integer - Considers only
files created at this timestamp or later. Unix timestamp in ms.</li>
<li><code>until_ts</code> - string representing a positive integer - Considers only
files created at this timestamp or earlier. Unix timestamp in ms.</li>
<li><code>search_term</code> - string - Filter users by their user ID localpart <strong>or</strong> displayname.
The search term can be found in any part of the string.
Defaults to no filtering.</li>
<li><code>dir</code> - string - Direction of order. Either <code>f</code> for forwards or <code>b</code> for backwards.
Setting this value to <code>b</code> will reverse the above sort order. Defaults to <code>f</code>.</li>
</ul>
<p><strong>Response</strong></p>
<p>The following fields are returned in the JSON response body:</p>
<ul>
<li><code>users</code> - An array of objects, each containing information
about the user and their local media. Objects contain the following fields:
<ul>
<li><code>displayname</code> - string - Displayname of this user.</li>
<li><code>media_count</code> - integer - Number of uploaded media by this user.</li>
<li><code>media_length</code> - integer - Size of uploaded media in bytes by this user.</li>
<li><code>user_id</code> - string - Fully-qualified user ID (ex. <code>@user:server.com</code>).</li>
</ul>
</li>
<li><code>next_token</code> - integer - Opaque value used for pagination. See above.</li>
<li><code>total</code> - integer - Total number of users after filtering.</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="users"><a class="header" href="#users">Users</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="version-api"><a class="header" href="#version-api">Version API</a></h1>
<p>This API returns the running Synapse version and the Python version
on which Synapse is being run. This is useful when a Synapse instance
is behind a proxy that does not forward the 'Server' header (which also
contains Synapse version information).</p>
<p>The api is::</p>
<pre><code>GET /_synapse/admin/v1/server_version
</code></pre>
<p>It returns a JSON body like the following:</p>
<p>.. code:: json</p>
<pre><code>{
    &quot;server_version&quot;: &quot;0.99.2rc1 (b=develop, abcdef123)&quot;,
    &quot;python_version&quot;: &quot;3.6.8&quot;
}
</code></pre>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="using-the-synapse-manhole"><a class="header" href="#using-the-synapse-manhole">Using the synapse manhole</a></h1>
<p>The &quot;manhole&quot; allows server administrators to access a Python shell on a running
Synapse installation. This is a very powerful mechanism for administration and
debugging.</p>
<p><strong><em>Security Warning</em></strong></p>
<p>Note that this will give administrative access to synapse to <strong>all users</strong> with
shell access to the server. It should therefore <strong>not</strong> be enabled in
environments where untrusted users have shell access.</p>
<hr />
<p>To enable it, first uncomment the <code>manhole</code> listener configuration in
<code>homeserver.yaml</code>. The configuration is slightly different if you're using docker.</p>
<h4 id="docker-config"><a class="header" href="#docker-config">Docker config</a></h4>
<p>If you are using Docker, set <code>bind_addresses</code> to <code>['0.0.0.0']</code> as shown:</p>
<pre><code class="language-yaml">listeners:
  - port: 9000
    bind_addresses: ['0.0.0.0']
    type: manhole
</code></pre>
<p>When using <code>docker run</code> to start the server, you will then need to change the command to the following to include the
<code>manhole</code> port forwarding. The <code>-p 127.0.0.1:9000:9000</code> below is important: it 
ensures that access to the <code>manhole</code> is only possible for local users.</p>
<pre><code class="language-bash">docker run -d --name synapse \
    --mount type=volume,src=synapse-data,dst=/data \
    -p 8008:8008 \
    -p 127.0.0.1:9000:9000 \
    matrixdotorg/synapse:latest
</code></pre>
<h4 id="native-config"><a class="header" href="#native-config">Native config</a></h4>
<p>If you are not using docker, set <code>bind_addresses</code> to <code>['::1', '127.0.0.1']</code> as shown.
The <code>bind_addresses</code> in the example below is important: it ensures that access to the
<code>manhole</code> is only possible for local users).</p>
<pre><code class="language-yaml">listeners:
  - port: 9000
    bind_addresses: ['::1', '127.0.0.1']
    type: manhole
</code></pre>
<h4 id="accessing-synapse-manhole"><a class="header" href="#accessing-synapse-manhole">Accessing synapse manhole</a></h4>
<p>Then restart synapse, and point an ssh client at port 9000 on localhost, using
the username <code>matrix</code>:</p>
<pre><code class="language-bash">ssh -p9000 matrix@localhost
</code></pre>
<p>The password is <code>rabbithole</code>.</p>
<p>This gives a Python REPL in which <code>hs</code> gives access to the
<code>synapse.server.HomeServer</code> object - which in turn gives access to many other
parts of the process.</p>
<p>Note that any call which returns a coroutine will need to be wrapped in <code>ensureDeferred</code>.</p>
<p>As a simple example, retrieving an event from the database:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; from twisted.internet import defer
&gt;&gt;&gt; defer.ensureDeferred(hs.get_datastore().get_event('$1416420717069yeQaw:matrix.org'))
&lt;Deferred at 0x7ff253fc6998 current result: &lt;FrozenEvent event_id='$1416420717069yeQaw:matrix.org', type='m.room.create', state_key=''&gt;&gt;
</code></pre>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="how-to-monitor-synapse-metrics-using-prometheus"><a class="header" href="#how-to-monitor-synapse-metrics-using-prometheus">How to monitor Synapse metrics using Prometheus</a></h1>
<ol>
<li>
<p>Install Prometheus:</p>
<p>Follow instructions at
<a href="http://prometheus.io/docs/introduction/install/">http://prometheus.io/docs/introduction/install/</a></p>
</li>
<li>
<p>Enable Synapse metrics:</p>
<p>There are two methods of enabling metrics in Synapse.</p>
<p>The first serves the metrics as a part of the usual web server and
can be enabled by adding the &quot;metrics&quot; resource to the existing
listener as such:</p>
<pre><code class="language-yaml">  resources:
    - names:
      - client
      - metrics
</code></pre>
<p>This provides a simple way of adding metrics to your Synapse
installation, and serves under <code>/_synapse/metrics</code>. If you do not
wish your metrics be publicly exposed, you will need to either
filter it out at your load balancer, or use the second method.</p>
<p>The second method runs the metrics server on a different port, in a
different thread to Synapse. This can make it more resilient to
heavy load meaning metrics cannot be retrieved, and can be exposed
to just internal networks easier. The served metrics are available
over HTTP only, and will be available at <code>/_synapse/metrics</code>.</p>
<p>Add a new listener to homeserver.yaml:</p>
<pre><code class="language-yaml">  listeners:
    - type: metrics
      port: 9000
      bind_addresses:
        - '0.0.0.0'
</code></pre>
<p>For both options, you will need to ensure that <code>enable_metrics</code> is
set to <code>True</code>.</p>
</li>
<li>
<p>Restart Synapse.</p>
</li>
<li>
<p>Add a Prometheus target for Synapse.</p>
<p>It needs to set the <code>metrics_path</code> to a non-default value (under
<code>scrape_configs</code>):</p>
<pre><code class="language-yaml">  - job_name: &quot;synapse&quot;
    scrape_interval: 15s
    metrics_path: &quot;/_synapse/metrics&quot;
    static_configs:
      - targets: [&quot;my.server.here:port&quot;]
</code></pre>
<p>where <code>my.server.here</code> is the IP address of Synapse, and <code>port</code> is
the listener port configured with the <code>metrics</code> resource.</p>
<p>If your prometheus is older than 1.5.2, you will need to replace
<code>static_configs</code> in the above with <code>target_groups</code>.</p>
</li>
<li>
<p>Restart Prometheus.</p>
</li>
<li>
<p>Consider using the <a href="https://github.com/matrix-org/synapse/tree/master/contrib/grafana/">grafana dashboard</a>
and required <a href="https://github.com/matrix-org/synapse/tree/master/contrib/prometheus/">recording rules</a> </p>
</li>
</ol>
<h2 id="monitoring-workers"><a class="header" href="#monitoring-workers">Monitoring workers</a></h2>
<p>To monitor a Synapse installation using
<a href="https://github.com/matrix-org/synapse/blob/master/docs/workers.md">workers</a>,
every worker needs to be monitored independently, in addition to
the main homeserver process. This is because workers don't send
their metrics to the main homeserver process, but expose them
directly (if they are configured to do so).</p>
<p>To allow collecting metrics from a worker, you need to add a
<code>metrics</code> listener to its configuration, by adding the following
under <code>worker_listeners</code>:</p>
<pre><code class="language-yaml">  - type: metrics
    bind_address: ''
    port: 9101
</code></pre>
<p>The <code>bind_address</code> and <code>port</code> parameters should be set so that
the resulting listener can be reached by prometheus, and they
don't clash with an existing worker.
With this example, the worker's metrics would then be available
on <code>http://127.0.0.1:9101</code>.</p>
<p>Example Prometheus target for Synapse with workers:</p>
<pre><code class="language-yaml">  - job_name: &quot;synapse&quot;
    scrape_interval: 15s
    metrics_path: &quot;/_synapse/metrics&quot;
    static_configs:
      - targets: [&quot;my.server.here:port&quot;]
        labels:
          instance: &quot;my.server&quot;
          job: &quot;master&quot;
          index: 1
      - targets: [&quot;my.workerserver.here:port&quot;]
        labels:
          instance: &quot;my.server&quot;
          job: &quot;generic_worker&quot;
          index: 1
      - targets: [&quot;my.workerserver.here:port&quot;]
        labels:
          instance: &quot;my.server&quot;
          job: &quot;generic_worker&quot;
          index: 2
      - targets: [&quot;my.workerserver.here:port&quot;]
        labels:
          instance: &quot;my.server&quot;
          job: &quot;media_repository&quot;
          index: 1
</code></pre>
<p>Labels (<code>instance</code>, <code>job</code>, <code>index</code>) can be defined as anything.
The labels are used to group graphs in grafana.</p>
<h2 id="renaming-of-metrics--deprecation-of-old-names-in-12"><a class="header" href="#renaming-of-metrics--deprecation-of-old-names-in-12">Renaming of metrics &amp; deprecation of old names in 1.2</a></h2>
<p>Synapse 1.2 updates the Prometheus metrics to match the naming
convention of the upstream <code>prometheus_client</code>. The old names are
considered deprecated and will be removed in a future version of
Synapse.</p>
<table><thead><tr><th>New Name</th><th>Old Name</th></tr></thead><tbody>
<tr><td>python_gc_objects_collected_total</td><td>python_gc_objects_collected</td></tr>
<tr><td>python_gc_objects_uncollectable_total</td><td>python_gc_objects_uncollectable</td></tr>
<tr><td>python_gc_collections_total</td><td>python_gc_collections</td></tr>
<tr><td>process_cpu_seconds_total</td><td>process_cpu_seconds</td></tr>
<tr><td>synapse_federation_client_sent_transactions_total</td><td>synapse_federation_client_sent_transactions</td></tr>
<tr><td>synapse_federation_client_events_processed_total</td><td>synapse_federation_client_events_processed</td></tr>
<tr><td>synapse_event_processing_loop_count_total</td><td>synapse_event_processing_loop_count</td></tr>
<tr><td>synapse_event_processing_loop_room_count_total</td><td>synapse_event_processing_loop_room_count</td></tr>
<tr><td>synapse_util_metrics_block_count_total</td><td>synapse_util_metrics_block_count</td></tr>
<tr><td>synapse_util_metrics_block_time_seconds_total</td><td>synapse_util_metrics_block_time_seconds</td></tr>
<tr><td>synapse_util_metrics_block_ru_utime_seconds_total</td><td>synapse_util_metrics_block_ru_utime_seconds</td></tr>
<tr><td>synapse_util_metrics_block_ru_stime_seconds_total</td><td>synapse_util_metrics_block_ru_stime_seconds</td></tr>
<tr><td>synapse_util_metrics_block_db_txn_count_total</td><td>synapse_util_metrics_block_db_txn_count</td></tr>
<tr><td>synapse_util_metrics_block_db_txn_duration_seconds_total</td><td>synapse_util_metrics_block_db_txn_duration_seconds</td></tr>
<tr><td>synapse_util_metrics_block_db_sched_duration_seconds_total</td><td>synapse_util_metrics_block_db_sched_duration_seconds</td></tr>
<tr><td>synapse_background_process_start_count_total</td><td>synapse_background_process_start_count</td></tr>
<tr><td>synapse_background_process_ru_utime_seconds_total</td><td>synapse_background_process_ru_utime_seconds</td></tr>
<tr><td>synapse_background_process_ru_stime_seconds_total</td><td>synapse_background_process_ru_stime_seconds</td></tr>
<tr><td>synapse_background_process_db_txn_count_total</td><td>synapse_background_process_db_txn_count</td></tr>
<tr><td>synapse_background_process_db_txn_duration_seconds_total</td><td>synapse_background_process_db_txn_duration_seconds</td></tr>
<tr><td>synapse_background_process_db_sched_duration_seconds_total</td><td>synapse_background_process_db_sched_duration_seconds</td></tr>
<tr><td>synapse_storage_events_persisted_events_total</td><td>synapse_storage_events_persisted_events</td></tr>
<tr><td>synapse_storage_events_persisted_events_sep_total</td><td>synapse_storage_events_persisted_events_sep</td></tr>
<tr><td>synapse_storage_events_state_delta_total</td><td>synapse_storage_events_state_delta</td></tr>
<tr><td>synapse_storage_events_state_delta_single_event_total</td><td>synapse_storage_events_state_delta_single_event</td></tr>
<tr><td>synapse_storage_events_state_delta_reuse_delta_total</td><td>synapse_storage_events_state_delta_reuse_delta</td></tr>
<tr><td>synapse_federation_server_received_pdus_total</td><td>synapse_federation_server_received_pdus</td></tr>
<tr><td>synapse_federation_server_received_edus_total</td><td>synapse_federation_server_received_edus</td></tr>
<tr><td>synapse_handler_presence_notified_presence_total</td><td>synapse_handler_presence_notified_presence</td></tr>
<tr><td>synapse_handler_presence_federation_presence_out_total</td><td>synapse_handler_presence_federation_presence_out</td></tr>
<tr><td>synapse_handler_presence_presence_updates_total</td><td>synapse_handler_presence_presence_updates</td></tr>
<tr><td>synapse_handler_presence_timers_fired_total</td><td>synapse_handler_presence_timers_fired</td></tr>
<tr><td>synapse_handler_presence_federation_presence_total</td><td>synapse_handler_presence_federation_presence</td></tr>
<tr><td>synapse_handler_presence_bump_active_time_total</td><td>synapse_handler_presence_bump_active_time</td></tr>
<tr><td>synapse_federation_client_sent_edus_total</td><td>synapse_federation_client_sent_edus</td></tr>
<tr><td>synapse_federation_client_sent_pdu_destinations_count_total</td><td>synapse_federation_client_sent_pdu_destinations:count</td></tr>
<tr><td>synapse_federation_client_sent_pdu_destinations_total</td><td>synapse_federation_client_sent_pdu_destinations:total</td></tr>
<tr><td>synapse_handlers_appservice_events_processed_total</td><td>synapse_handlers_appservice_events_processed</td></tr>
<tr><td>synapse_notifier_notified_events_total</td><td>synapse_notifier_notified_events</td></tr>
<tr><td>synapse_push_bulk_push_rule_evaluator_push_rules_invalidation_counter_total</td><td>synapse_push_bulk_push_rule_evaluator_push_rules_invalidation_counter</td></tr>
<tr><td>synapse_push_bulk_push_rule_evaluator_push_rules_state_size_counter_total</td><td>synapse_push_bulk_push_rule_evaluator_push_rules_state_size_counter</td></tr>
<tr><td>synapse_http_httppusher_http_pushes_processed_total</td><td>synapse_http_httppusher_http_pushes_processed</td></tr>
<tr><td>synapse_http_httppusher_http_pushes_failed_total</td><td>synapse_http_httppusher_http_pushes_failed</td></tr>
<tr><td>synapse_http_httppusher_badge_updates_processed_total</td><td>synapse_http_httppusher_badge_updates_processed</td></tr>
<tr><td>synapse_http_httppusher_badge_updates_failed_total</td><td>synapse_http_httppusher_badge_updates_failed</td></tr>
</tbody></table>
<h2 id="removal-of-deprecated-metrics--time-based-counters-becoming-histograms-in-0310"><a class="header" href="#removal-of-deprecated-metrics--time-based-counters-becoming-histograms-in-0310">Removal of deprecated metrics &amp; time based counters becoming histograms in 0.31.0</a></h2>
<p>The duplicated metrics deprecated in Synapse 0.27.0 have been removed.</p>
<p>All time duration-based metrics have been changed to be seconds. This
affects:</p>
<table><thead><tr><th>msec -&gt; sec metrics</th></tr></thead><tbody>
<tr><td>python_gc_time</td></tr>
<tr><td>python_twisted_reactor_tick_time</td></tr>
<tr><td>synapse_storage_query_time</td></tr>
<tr><td>synapse_storage_schedule_time</td></tr>
<tr><td>synapse_storage_transaction_time</td></tr>
</tbody></table>
<p>Several metrics have been changed to be histograms, which sort entries
into buckets and allow better analysis. The following metrics are now
histograms:</p>
<table><thead><tr><th>Altered metrics</th></tr></thead><tbody>
<tr><td>python_gc_time</td></tr>
<tr><td>python_twisted_reactor_pending_calls</td></tr>
<tr><td>python_twisted_reactor_tick_time</td></tr>
<tr><td>synapse_http_server_response_time_seconds</td></tr>
<tr><td>synapse_storage_query_time</td></tr>
<tr><td>synapse_storage_schedule_time</td></tr>
<tr><td>synapse_storage_transaction_time</td></tr>
</tbody></table>
<h2 id="block-and-response-metrics-renamed-for-0270"><a class="header" href="#block-and-response-metrics-renamed-for-0270">Block and response metrics renamed for 0.27.0</a></h2>
<p>Synapse 0.27.0 begins the process of rationalising the duplicate
<code>*:count</code> metrics reported for the resource tracking for code blocks and
HTTP requests.</p>
<p>At the same time, the corresponding <code>*:total</code> metrics are being renamed,
as the <code>:total</code> suffix no longer makes sense in the absence of a
corresponding <code>:count</code> metric.</p>
<p>To enable a graceful migration path, this release just adds new names
for the metrics being renamed. A future release will remove the old
ones.</p>
<p>The following table shows the new metrics, and the old metrics which
they are replacing.</p>
<table><thead><tr><th>New name</th><th>Old name</th></tr></thead><tbody>
<tr><td>synapse_util_metrics_block_count</td><td>synapse_util_metrics_block_timer:count</td></tr>
<tr><td>synapse_util_metrics_block_count</td><td>synapse_util_metrics_block_ru_utime:count</td></tr>
<tr><td>synapse_util_metrics_block_count</td><td>synapse_util_metrics_block_ru_stime:count</td></tr>
<tr><td>synapse_util_metrics_block_count</td><td>synapse_util_metrics_block_db_txn_count:count</td></tr>
<tr><td>synapse_util_metrics_block_count</td><td>synapse_util_metrics_block_db_txn_duration:count</td></tr>
<tr><td>synapse_util_metrics_block_time_seconds</td><td>synapse_util_metrics_block_timer:total</td></tr>
<tr><td>synapse_util_metrics_block_ru_utime_seconds</td><td>synapse_util_metrics_block_ru_utime:total</td></tr>
<tr><td>synapse_util_metrics_block_ru_stime_seconds</td><td>synapse_util_metrics_block_ru_stime:total</td></tr>
<tr><td>synapse_util_metrics_block_db_txn_count</td><td>synapse_util_metrics_block_db_txn_count:total</td></tr>
<tr><td>synapse_util_metrics_block_db_txn_duration_seconds</td><td>synapse_util_metrics_block_db_txn_duration:total</td></tr>
<tr><td>synapse_http_server_response_count</td><td>synapse_http_server_requests</td></tr>
<tr><td>synapse_http_server_response_count</td><td>synapse_http_server_response_time:count</td></tr>
<tr><td>synapse_http_server_response_count</td><td>synapse_http_server_response_ru_utime:count</td></tr>
<tr><td>synapse_http_server_response_count</td><td>synapse_http_server_response_ru_stime:count</td></tr>
<tr><td>synapse_http_server_response_count</td><td>synapse_http_server_response_db_txn_count:count</td></tr>
<tr><td>synapse_http_server_response_count</td><td>synapse_http_server_response_db_txn_duration:count</td></tr>
<tr><td>synapse_http_server_response_time_seconds</td><td>synapse_http_server_response_time:total</td></tr>
<tr><td>synapse_http_server_response_ru_utime_seconds</td><td>synapse_http_server_response_ru_utime:total</td></tr>
<tr><td>synapse_http_server_response_ru_stime_seconds</td><td>synapse_http_server_response_ru_stime:total</td></tr>
<tr><td>synapse_http_server_response_db_txn_count</td><td>synapse_http_server_response_db_txn_count:total</td></tr>
<tr><td>synapse_http_server_response_db_txn_duration_seconds</td><td>synapse_http_server_response_db_txn_duration:total</td></tr>
</tbody></table>
<h2 id="standard-metric-names"><a class="header" href="#standard-metric-names">Standard Metric Names</a></h2>
<p>As of synapse version 0.18.2, the format of the process-wide metrics has
been changed to fit prometheus standard naming conventions. Additionally
the units have been changed to seconds, from miliseconds.</p>
<table><thead><tr><th>New name</th><th>Old name</th></tr></thead><tbody>
<tr><td>process_cpu_user_seconds_total</td><td>process_resource_utime / 1000</td></tr>
<tr><td>process_cpu_system_seconds_total</td><td>process_resource_stime / 1000</td></tr>
<tr><td>process_open_fds (no 'type' label)</td><td>process_fds</td></tr>
</tbody></table>
<p>The python-specific counts of garbage collector performance have been
renamed.</p>
<table><thead><tr><th>New name</th><th>Old name</th></tr></thead><tbody>
<tr><td>python_gc_time</td><td>reactor_gc_time</td></tr>
<tr><td>python_gc_unreachable_total</td><td>reactor_gc_unreachable</td></tr>
<tr><td>python_gc_counts</td><td>reactor_gc_counts</td></tr>
</tbody></table>
<p>The twisted-specific reactor metrics have been renamed.</p>
<table><thead><tr><th>New name</th><th>Old name</th></tr></thead><tbody>
<tr><td>python_twisted_reactor_pending_calls</td><td>reactor_pending_calls</td></tr>
<tr><td>python_twisted_reactor_tick_time</td><td>reactor_tick_time</td></tr>
</tbody></table>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="structured-logging"><a class="header" href="#structured-logging">Structured Logging</a></h1>
<p>A structured logging system can be useful when your logs are destined for a
machine to parse and process. By maintaining its machine-readable characteristics,
it enables more efficient searching and aggregations when consumed by software
such as the &quot;ELK stack&quot;.</p>
<p>Synapse's structured logging system is configured via the file that Synapse's
<code>log_config</code> config option points to. The file should include a formatter which
uses the <code>synapse.logging.TerseJsonFormatter</code> class included with Synapse and a
handler which uses the above formatter.</p>
<p>There is also a <code>synapse.logging.JsonFormatter</code> option which does not include
a timestamp in the resulting JSON. This is useful if the log ingester adds its
own timestamp.</p>
<p>A structured logging configuration looks similar to the following:</p>
<pre><code class="language-yaml">version: 1

formatters:
    structured:
        class: synapse.logging.TerseJsonFormatter

handlers:
    file:
        class: logging.handlers.TimedRotatingFileHandler
        formatter: structured
        filename: /path/to/my/logs/homeserver.log
        when: midnight
        backupCount: 3  # Does not include the current log file.
        encoding: utf8

loggers:
    synapse:
        level: INFO
        handlers: [remote]
    synapse.storage.SQL:
        level: WARNING
</code></pre>
<p>The above logging config will set Synapse as 'INFO' logging level by default,
with the SQL layer at 'WARNING', and will log to a file, stored as JSON.</p>
<p>It is also possible to figure Synapse to log to a remote endpoint by using the
<code>synapse.logging.RemoteHandler</code> class included with Synapse. It takes the
following arguments:</p>
<ul>
<li><code>host</code>: Hostname or IP address of the log aggregator.</li>
<li><code>port</code>: Numerical port to contact on the host.</li>
<li><code>maximum_buffer</code>: (Optional, defaults to 1000) The maximum buffer size to allow.</li>
</ul>
<p>A remote structured logging configuration looks similar to the following:</p>
<pre><code class="language-yaml">version: 1

formatters:
    structured:
        class: synapse.logging.TerseJsonFormatter

handlers:
    remote:
        class: synapse.logging.RemoteHandler
        formatter: structured
        host: 10.1.2.3
        port: 9999

loggers:
    synapse:
        level: INFO
        handlers: [remote]
    synapse.storage.SQL:
        level: WARNING
</code></pre>
<p>The above logging config will set Synapse as 'INFO' logging level by default,
with the SQL layer at 'WARNING', and will log JSON formatted messages to a
remote endpoint at 10.1.2.3:9999.</p>
<h2 id="upgrading-from-legacy-structured-logging-configuration"><a class="header" href="#upgrading-from-legacy-structured-logging-configuration">Upgrading from legacy structured logging configuration</a></h2>
<p>Versions of Synapse prior to v1.23.0 included a custom structured logging
configuration which is deprecated. It used a <code>structured: true</code> flag and
configured <code>drains</code> instead of <code>handlers</code> and <code>formatters</code>.</p>
<p>Synapse currently automatically converts the old configuration to the new
configuration, but this will be removed in a future version of Synapse. The
following reference can be used to update your configuration. Based on the drain
<code>type</code>, we can pick a new handler:</p>
<ol>
<li>For a type of <code>console</code>, <code>console_json</code>, or <code>console_json_terse</code>: a handler
with a class of <code>logging.StreamHandler</code> and a <code>stream</code> of <code>ext://sys.stdout</code>
or <code>ext://sys.stderr</code> should be used.</li>
<li>For a type of <code>file</code> or <code>file_json</code>: a handler of <code>logging.FileHandler</code> with
a location of the file path should be used.</li>
<li>For a type of <code>network_json_terse</code>: a handler of <code>synapse.logging.RemoteHandler</code>
with the host and port should be used.</li>
</ol>
<p>Then based on the drain <code>type</code> we can pick a new formatter:</p>
<ol>
<li>For a type of <code>console</code> or <code>file</code> no formatter is necessary.</li>
<li>For a type of <code>console_json</code> or <code>file_json</code>: a formatter of
<code>synapse.logging.JsonFormatter</code> should be used.</li>
<li>For a type of <code>console_json_terse</code> or <code>network_json_terse</code>: a formatter of
<code>synapse.logging.TerseJsonFormatter</code> should be used.</li>
</ol>
<p>For each new handler and formatter they should be added to the logging configuration
and then assigned to either a logger or the root logger.</p>
<p>An example legacy configuration:</p>
<pre><code class="language-yaml">structured: true

loggers:
    synapse:
        level: INFO
    synapse.storage.SQL:
        level: WARNING

drains:
    console:
        type: console
        location: stdout
    file:
        type: file_json
        location: homeserver.log
</code></pre>
<p>Would be converted into a new configuration:</p>
<pre><code class="language-yaml">version: 1

formatters:
    json:
        class: synapse.logging.JsonFormatter

handlers:
    console:
        class: logging.StreamHandler
        location: ext://sys.stdout
    file:
        class: logging.FileHandler
        formatter: json
        filename: homeserver.log

loggers:
    synapse:
        level: INFO
        handlers: [console, file]
    synapse.storage.SQL:
        level: WARNING
</code></pre>
<p>The new logging configuration is a bit more verbose, but significantly more
flexible. It allows for configuration that were not previously possible, such as
sending plain logs over the network, or using different handlers for different
modules.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="scripts"><a class="header" href="#scripts">Scripts</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="development"><a class="header" href="#development">Development</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><p>Welcome to Synapse</p>
<p>This document aims to get you started with contributing to this repo! </p>
<ul>
<li><a href="../CONTRIBUTING.html#1-who-can-contribute-to-synapse">1. Who can contribute to Synapse?</a></li>
<li><a href="../CONTRIBUTING.html#2-what-do-i-need">2. What do I need?</a></li>
<li><a href="../CONTRIBUTING.html#3-get-the-source">3. Get the source.</a></li>
<li><a href="../CONTRIBUTING.html#4-install-the-dependencies">4. Install the dependencies</a>
<ul>
<li><a href="../CONTRIBUTING.html#under-unix-macos-linux-bsd-">Under Unix (macOS, Linux, BSD, ...)</a></li>
<li><a href="../CONTRIBUTING.html#under-windows">Under Windows</a></li>
</ul>
</li>
<li><a href="../CONTRIBUTING.html#5-get-in-touch">5. Get in touch.</a></li>
<li><a href="../CONTRIBUTING.html#6-pick-an-issue">6. Pick an issue.</a></li>
<li><a href="../CONTRIBUTING.html#7-turn-coffee-and-documentation-into-code-and-documentation">7. Turn coffee and documentation into code and documentation!</a></li>
<li><a href="../CONTRIBUTING.html#8-test-test-test">8. Test, test, test!</a>
<ul>
<li><a href="../CONTRIBUTING.html#run-the-linters">Run the linters.</a></li>
<li><a href="../CONTRIBUTING.html#run-the-unit-tests">Run the unit tests.</a></li>
<li><a href="../CONTRIBUTING.html#run-the-integration-tests">Run the integration tests.</a></li>
</ul>
</li>
<li><a href="../CONTRIBUTING.html#9-submit-your-patch">9. Submit your patch.</a>
<ul>
<li><a href="../CONTRIBUTING.html#changelog">Changelog</a>
<ul>
<li><a href="../CONTRIBUTING.html#how-do-i-know-what-to-call-the-changelog-file-before-i-create-the-pr">How do I know what to call the changelog file before I create the PR?</a></li>
<li><a href="../CONTRIBUTING.html#debian-changelog">Debian changelog</a></li>
</ul>
</li>
<li><a href="../CONTRIBUTING.html#sign-off">Sign off</a></li>
</ul>
</li>
<li><a href="../CONTRIBUTING.html#10-turn-feedback-into-better-code">10. Turn feedback into better code.</a></li>
<li><a href="../CONTRIBUTING.html#11-find-a-new-issue">11. Find a new issue.</a></li>
<li><a href="../CONTRIBUTING.html#notes-for-maintainers-on-merging-prs-etc">Notes for maintainers on merging PRs etc</a></li>
<li><a href="../CONTRIBUTING.html#conclusion">Conclusion</a></li>
</ul>
<h1 id="1-who-can-contribute-to-synapse"><a class="header" href="#1-who-can-contribute-to-synapse">1. Who can contribute to Synapse?</a></h1>
<p>Everyone is welcome to contribute code to <a href="https://github.com/matrix-org">matrix.org
projects</a>, provided that they are willing to
license their contributions under the same license as the project itself. We
follow a simple 'inbound=outbound' model for contributions: the act of
submitting an 'inbound' contribution means that the contributor agrees to
license the code under the same terms as the project's overall 'outbound'
license - in our case, this is almost always Apache Software License v2 (see
<a href="../LICENSE">LICENSE</a>).</p>
<h1 id="2-what-do-i-need"><a class="header" href="#2-what-do-i-need">2. What do I need?</a></h1>
<p>The code of Synapse is written in Python 3. To do pretty much anything, you'll need <a href="https://wiki.python.org/moin/BeginnersGuide/Download">a recent version of Python 3</a>.</p>
<p>The source code of Synapse is hosted on GitHub. You will also need <a href="https://github.com/git-guides/install-git">a recent version of git</a>.</p>
<p>For some tests, you will need <a href="https://docs.docker.com/get-docker/">a recent version of Docker</a>.</p>
<h1 id="3-get-the-source"><a class="header" href="#3-get-the-source">3. Get the source.</a></h1>
<p>The preferred and easiest way to contribute changes is to fork the relevant
project on GitHub, and then <a href="https://help.github.com/articles/using-pull-requests/">create a pull request</a> to ask us to pull your
changes into our repo.</p>
<p>Please base your changes on the <code>develop</code> branch.</p>
<pre><code class="language-sh">git clone git@github.com:YOUR_GITHUB_USER_NAME/synapse.git
git checkout develop
</code></pre>
<p>If you need help getting started with git, this is beyond the scope of the document, but you
can find many good git tutorials on the web.</p>
<h1 id="4-install-the-dependencies"><a class="header" href="#4-install-the-dependencies">4. Install the dependencies</a></h1>
<h2 id="under-unix-macos-linux-bsd-"><a class="header" href="#under-unix-macos-linux-bsd-">Under Unix (macOS, Linux, BSD, ...)</a></h2>
<p>Once you have installed Python 3 and added the source, please open a terminal and
setup a <em>virtualenv</em>, as follows:</p>
<pre><code class="language-sh">cd path/where/you/have/cloned/the/repository
python3 -m venv ./env
source ./env/bin/activate
pip install -e &quot;.[all,lint,mypy,test]&quot;
pip install tox
</code></pre>
<p>This will install the developer dependencies for the project.</p>
<h2 id="under-windows"><a class="header" href="#under-windows">Under Windows</a></h2>
<p>TBD</p>
<h1 id="5-get-in-touch"><a class="header" href="#5-get-in-touch">5. Get in touch.</a></h1>
<p>Join our developer community on Matrix: #synapse-dev:matrix.org !</p>
<h1 id="6-pick-an-issue"><a class="header" href="#6-pick-an-issue">6. Pick an issue.</a></h1>
<p>Fix your favorite problem or perhaps find a <a href="https://github.com/matrix-org/synapse/issues?q=is%3Aopen+is%3Aissue+label%3A%22Good+First+Issue%22">Good First Issue</a>
to work on.</p>
<h1 id="7-turn-coffee-and-documentation-into-code-and-documentation"><a class="header" href="#7-turn-coffee-and-documentation-into-code-and-documentation">7. Turn coffee and documentation into code and documentation!</a></h1>
<p>Synapse's code style is documented <a href="../docs/code_style.html">here</a>. Please follow
it, including the conventions for the <a href="../docs/code_style.html#configuration-file-format">sample configuration
file</a>.</p>
<p>There is a growing amount of documentation located in the <a href="../docs">docs</a>
directory. This documentation is intended primarily for sysadmins running their
own Synapse instance, as well as developers interacting externally with
Synapse. <a href="../docs/dev">docs/dev</a> exists primarily to house documentation for
Synapse developers. <a href="../docs/admin_api">docs/admin_api</a> houses documentation
regarding Synapse's Admin API, which is used mostly by sysadmins and external
service developers.</p>
<p>If you add new files added to either of these folders, please use <a href="https://guides.github.com/features/mastering-markdown/">GitHub-Flavoured
Markdown</a>.</p>
<p>Some documentation also exists in <a href="https://github.com/matrix-org/synapse/wiki">Synapse's GitHub
Wiki</a>, although this is primarily
contributed to by community authors.</p>
<h1 id="8-test-test-test"><a class="header" href="#8-test-test-test">8. Test, test, test!</a></h1>
<p><a name="test-test-test"></a></p>
<p>While you're developing and before submitting a patch, you'll
want to test your code.</p>
<h2 id="run-the-linters"><a class="header" href="#run-the-linters">Run the linters.</a></h2>
<p>The linters look at your code and do two things:</p>
<ul>
<li>ensure that your code follows the coding style adopted by the project;</li>
<li>catch a number of errors in your code.</li>
</ul>
<p>They're pretty fast, don't hesitate!</p>
<pre><code class="language-sh">source ./env/bin/activate
./scripts-dev/lint.sh
</code></pre>
<p>Note that this script <em>will modify your files</em> to fix styling errors.
Make sure that you have saved all your files.</p>
<p>If you wish to restrict the linters to only the files changed since the last commit
(much faster!), you can instead run:</p>
<pre><code class="language-sh">source ./env/bin/activate
./scripts-dev/lint.sh -d
</code></pre>
<p>Or if you know exactly which files you wish to lint, you can instead run:</p>
<pre><code class="language-sh">source ./env/bin/activate
./scripts-dev/lint.sh path/to/file1.py path/to/file2.py path/to/folder
</code></pre>
<h2 id="run-the-unit-tests"><a class="header" href="#run-the-unit-tests">Run the unit tests.</a></h2>
<p>The unit tests run parts of Synapse, including your changes, to see if anything
was broken. They are slower than the linters but will typically catch more errors.</p>
<pre><code class="language-sh">source ./env/bin/activate
trial tests
</code></pre>
<p>If you wish to only run <em>some</em> unit tests, you may specify
another module instead of <code>tests</code> - or a test class or a method:</p>
<pre><code class="language-sh">source ./env/bin/activate
trial tests.rest.admin.test_room tests.handlers.test_admin.ExfiltrateData.test_invite
</code></pre>
<p>If your tests fail, you may wish to look at the logs:</p>
<pre><code class="language-sh">less _trial_temp/test.log
</code></pre>
<h2 id="run-the-integration-tests"><a class="header" href="#run-the-integration-tests">Run the integration tests.</a></h2>
<p>The integration tests are a more comprehensive suite of tests. They
run a full version of Synapse, including your changes, to check if
anything was broken. They are slower than the unit tests but will
typically catch more errors.</p>
<p>The following command will let you run the integration test with the most common
configuration:</p>
<pre><code class="language-sh">$ docker run --rm -it -v /path/where/you/have/cloned/the/repository\:/src:ro -v /path/to/where/you/want/logs\:/logs matrixdotorg/sytest-synapse:py37
</code></pre>
<p>This configuration should generally cover  your needs. For more details about other configurations, see <a href="https://github.com/matrix-org/sytest/blob/develop/docker/README.md">documentation in the SyTest repo</a>.</p>
<h1 id="9-submit-your-patch"><a class="header" href="#9-submit-your-patch">9. Submit your patch.</a></h1>
<p>Once you're happy with your patch, it's time to prepare a Pull Request.</p>
<p>To prepare a Pull Request, please:</p>
<ol>
<li>verify that <a href="../CONTRIBUTING.html#test-test-test">all the tests pass</a>, including the coding style;</li>
<li><a href="../CONTRIBUTING.html#sign-off">sign off</a> your contribution;</li>
<li><code>git push</code> your commit to your fork of Synapse;</li>
<li>on GitHub, <a href="https://docs.github.com/en/github/collaborating-with-issues-and-pull-requests/creating-a-pull-request">create the Pull Request</a>;</li>
<li>add a <a href="../CONTRIBUTING.html#changelog">changelog entry</a> and push it to your Pull Request;</li>
<li>for most contributors, that's all - however, if you are a member of the organization <code>matrix-org</code>, on GitHub, please request a review from <code>matrix.org / Synapse Core</code>.</li>
</ol>
<h2 id="changelog"><a class="header" href="#changelog">Changelog</a></h2>
<p>All changes, even minor ones, need a corresponding changelog / newsfragment
entry. These are managed by <a href="https://github.com/hawkowl/towncrier">Towncrier</a>.</p>
<p>To create a changelog entry, make a new file in the <code>changelog.d</code> directory named
in the format of <code>PRnumber.type</code>. The type can be one of the following:</p>
<ul>
<li><code>feature</code></li>
<li><code>bugfix</code></li>
<li><code>docker</code> (for updates to the Docker image)</li>
<li><code>doc</code> (for updates to the documentation)</li>
<li><code>removal</code> (also used for deprecations)</li>
<li><code>misc</code> (for internal-only changes)</li>
</ul>
<p>This file will become part of our <a href="https://github.com/matrix-org/synapse/blob/master/CHANGES.md">changelog</a> at the next
release, so the content of the file should be a short description of your
change in the same style as the rest of the changelog. The file can contain Markdown
formatting, and should end with a full stop (.) or an exclamation mark (!) for
consistency.</p>
<p>Adding credits to the changelog is encouraged, we value your
contributions and would like to have you shouted out in the release notes!</p>
<p>For example, a fix in PR #1234 would have its changelog entry in
<code>changelog.d/1234.bugfix</code>, and contain content like:</p>
<blockquote>
<p>The security levels of Florbs are now validated when received
via the <code>/federation/florb</code> endpoint. Contributed by Jane Matrix.</p>
</blockquote>
<p>If there are multiple pull requests involved in a single bugfix/feature/etc,
then the content for each <code>changelog.d</code> file should be the same. Towncrier will
merge the matching files together into a single changelog entry when we come to
release.</p>
<h3 id="how-do-i-know-what-to-call-the-changelog-file-before-i-create-the-pr"><a class="header" href="#how-do-i-know-what-to-call-the-changelog-file-before-i-create-the-pr">How do I know what to call the changelog file before I create the PR?</a></h3>
<p>Obviously, you don't know if you should call your newsfile
<code>1234.bugfix</code> or <code>5678.bugfix</code> until you create the PR, which leads to a
chicken-and-egg problem.</p>
<p>There are two options for solving this:</p>
<ol>
<li>
<p>Open the PR without a changelog file, see what number you got, and <em>then</em>
add the changelog file to your branch (see <a href="../CONTRIBUTING.html#updating-your-pull-request">Updating your pull
request</a>), or:</p>
</li>
<li>
<p>Look at the <a href="https://github.com/matrix-org/synapse/issues?q=">list of all
issues/PRs</a>, add one to the
highest number you see, and quickly open the PR before somebody else claims
your number.</p>
<p><a href="https://github.com/richvdh/scripts/blob/master/next_github_number.sh">This
script</a>
might be helpful if you find yourself doing this a lot.</p>
</li>
</ol>
<p>Sorry, we know it's a bit fiddly, but it's <em>really</em> helpful for us when we come
to put together a release!</p>
<h3 id="debian-changelog"><a class="header" href="#debian-changelog">Debian changelog</a></h3>
<p>Changes which affect the debian packaging files (in <code>debian</code>) are an
exception to the rule that all changes require a <code>changelog.d</code> file.</p>
<p>In this case, you will need to add an entry to the debian changelog for the
next release. For this, run the following command:</p>
<pre><code>dch
</code></pre>
<p>This will make up a new version number (if there isn't already an unreleased
version in flight), and open an editor where you can add a new changelog entry.
(Our release process will ensure that the version number and maintainer name is
corrected for the release.)</p>
<p>If your change affects both the debian packaging <em>and</em> files outside the debian
directory, you will need both a regular newsfragment <em>and</em> an entry in the
debian changelog. (Though typically such changes should be submitted as two
separate pull requests.)</p>
<h2 id="sign-off"><a class="header" href="#sign-off">Sign off</a></h2>
<p>In order to have a concrete record that your contribution is intentional
and you agree to license it under the same terms as the project's license, we've adopted the
same lightweight approach that the Linux Kernel
<a href="https://www.kernel.org/doc/html/latest/process/submitting-patches.html#sign-your-work-the-developer-s-certificate-of-origin%3E">submitting patches process</a>,
<a href="https://github.com/docker/docker/blob/master/CONTRIBUTING.md">Docker</a>, and many other
projects use: the DCO (Developer Certificate of Origin:
http://developercertificate.org/). This is a simple declaration that you wrote
the contribution or otherwise have the right to contribute it to Matrix:</p>
<pre><code>Developer Certificate of Origin
Version 1.1

Copyright (C) 2004, 2006 The Linux Foundation and its contributors.
660 York Street, Suite 102,
San Francisco, CA 94110 USA

Everyone is permitted to copy and distribute verbatim copies of this
license document, but changing it is not allowed.

Developer's Certificate of Origin 1.1

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I
    have the right to submit it under the open source license
    indicated in the file; or

(b) The contribution is based upon previous work that, to the best
    of my knowledge, is covered under an appropriate open source
    license and I have the right under that license to submit that
    work with modifications, whether created in whole or in part
    by me, under the same open source license (unless I am
    permitted to submit under a different license), as indicated
    in the file; or

(c) The contribution was provided directly to me by some other
    person who certified (a), (b) or (c) and I have not modified
    it.

(d) I understand and agree that this project and the contribution
    are public and that a record of the contribution (including all
    personal information I submit with it, including my sign-off) is
    maintained indefinitely and may be redistributed consistent with
    this project or the open source license(s) involved.
</code></pre>
<p>If you agree to this for your contribution, then all that's needed is to
include the line in your commit or pull request comment:</p>
<pre><code>Signed-off-by: Your Name &lt;your@email.example.org&gt;
</code></pre>
<p>We accept contributions under a legally identifiable name, such as
your name on government documentation or common-law names (names
claimed by legitimate usage or repute). Unfortunately, we cannot
accept anonymous contributions at this time.</p>
<p>Git allows you to add this signoff automatically when using the <code>-s</code>
flag to <code>git commit</code>, which uses the name and email set in your
<code>user.name</code> and <code>user.email</code> git configs.</p>
<h1 id="10-turn-feedback-into-better-code"><a class="header" href="#10-turn-feedback-into-better-code">10. Turn feedback into better code.</a></h1>
<p>Once the Pull Request is opened, you will see a few things:</p>
<ol>
<li>our automated CI (Continuous Integration) pipeline will run (again) the linters, the unit tests, the integration tests and more;</li>
<li>one or more of the developers will take a look at your Pull Request and offer feedback.</li>
</ol>
<p>From this point, you should:</p>
<ol>
<li>Look at the results of the CI pipeline.
<ul>
<li>If there is any error, fix the error.</li>
</ul>
</li>
<li>If a developer has requested changes, make these changes and let us know if it is ready for a developer to review again.</li>
<li>Create a new commit with the changes.
<ul>
<li>Please do NOT overwrite the history. New commits make the reviewer's life easier.</li>
<li>Push this commits to your Pull Request.</li>
</ul>
</li>
<li>Back to 1.</li>
</ol>
<p>Once both the CI and the developers are happy, the patch will be merged into Synapse and released shortly!</p>
<h1 id="11-find-a-new-issue"><a class="header" href="#11-find-a-new-issue">11. Find a new issue.</a></h1>
<p>By now, you know the drill!</p>
<h1 id="notes-for-maintainers-on-merging-prs-etc"><a class="header" href="#notes-for-maintainers-on-merging-prs-etc">Notes for maintainers on merging PRs etc</a></h1>
<p>There are some notes for those with commit access to the project on how we
manage git <a href="../docs/dev/git.html">here</a>.</p>
<h1 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h1>
<p>That's it! Matrix is a very open and collaborative project as you might expect
given our obsession with open communication. If we're going to successfully
matrix together all the fragmented communication technologies out there we are
reliant on contributions and collaboration from the community to do so. So
please get involved - and we hope you have as much fun hacking on Matrix as we
do!</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="code-style"><a class="header" href="#code-style">Code Style</a></h1>
<h2 id="formatting-tools"><a class="header" href="#formatting-tools">Formatting tools</a></h2>
<p>The Synapse codebase uses a number of code formatting tools in order to
quickly and automatically check for formatting (and sometimes logical)
errors in code.</p>
<p>The necessary tools are detailed below.</p>
<p>First install them with:</p>
<pre><code>pip install -e &quot;.[lint,mypy]&quot;
</code></pre>
<ul>
<li>
<p><strong>black</strong></p>
<p>The Synapse codebase uses <a href="https://pypi.org/project/black/">black</a>
as an opinionated code formatter, ensuring all comitted code is
properly formatted.</p>
<p>Have <code>black</code> auto-format your code (it shouldn't change any
functionality) with:</p>
<pre><code>black . --exclude=&quot;\.tox|build|env&quot;
</code></pre>
</li>
<li>
<p><strong>flake8</strong></p>
<p><code>flake8</code> is a code checking tool. We require code to pass <code>flake8</code>
before being merged into the codebase.</p>
<p>Check all application and test code with:</p>
<pre><code>flake8 synapse tests
</code></pre>
</li>
<li>
<p><strong>isort</strong></p>
<p><code>isort</code> ensures imports are nicely formatted, and can suggest and
auto-fix issues such as double-importing.</p>
<p>Auto-fix imports with:</p>
<pre><code>isort -rc synapse tests
</code></pre>
<p><code>-rc</code> means to recursively search the given directories.</p>
</li>
</ul>
<p>It's worth noting that modern IDEs and text editors can run these tools
automatically on save. It may be worth looking into whether this
functionality is supported in your editor for a more convenient
development workflow. It is not, however, recommended to run <code>flake8</code> on
save as it takes a while and is very resource intensive.</p>
<h2 id="general-rules"><a class="header" href="#general-rules">General rules</a></h2>
<ul>
<li><strong>Naming</strong>:
<ul>
<li>Use camel case for class and type names</li>
<li>Use underscores for functions and variables.</li>
</ul>
</li>
<li><strong>Docstrings</strong>: should follow the <a href="https://google.github.io/styleguide/pyguide.html#38-comments-and-docstrings">google code
style</a>.
See the
<a href="http://sphinxcontrib-napoleon.readthedocs.io/en/latest/example_google.html">examples</a>
in the sphinx documentation.</li>
<li><strong>Imports</strong>:
<ul>
<li>
<p>Imports should be sorted by <code>isort</code> as described above.</p>
</li>
<li>
<p>Prefer to import classes and functions rather than packages or
modules.</p>
<p>Example:</p>
<pre><code>from synapse.types import UserID
...
user_id = UserID(local, server)
</code></pre>
<p>is preferred over:</p>
<pre><code>from synapse import types
...
user_id = types.UserID(local, server)
</code></pre>
<p>(or any other variant).</p>
<p>This goes against the advice in the Google style guide, but it
means that errors in the name are caught early (at import time).</p>
</li>
<li>
<p>Avoid wildcard imports (<code>from synapse.types import *</code>) and
relative imports (<code>from .types import UserID</code>).</p>
</li>
</ul>
</li>
</ul>
<h2 id="configuration-file-format"><a class="header" href="#configuration-file-format">Configuration file format</a></h2>
<p>The <a href="development/../../docs/sample_config.yaml">sample configuration file</a> acts as a
reference to Synapse's configuration options for server administrators.
Remember that many readers will be unfamiliar with YAML and server
administration in general, so that it is important that the file be as
easy to understand as possible, which includes following a consistent
format.</p>
<p>Some guidelines follow:</p>
<ul>
<li>
<p>Sections should be separated with a heading consisting of a single
line prefixed and suffixed with <code>##</code>. There should be <strong>two</strong> blank
lines before the section header, and <strong>one</strong> after.</p>
</li>
<li>
<p>Each option should be listed in the file with the following format:</p>
<ul>
<li>
<p>A comment describing the setting. Each line of this comment
should be prefixed with a hash (<code>#</code>) and a space.</p>
<p>The comment should describe the default behaviour (ie, what
happens if the setting is omitted), as well as what the effect
will be if the setting is changed.</p>
<p>Often, the comment end with something like &quot;uncomment the
following to <do action>&quot;.</p>
</li>
<li>
<p>A line consisting of only <code>#</code>.</p>
</li>
<li>
<p>A commented-out example setting, prefixed with only <code>#</code>.</p>
<p>For boolean (on/off) options, convention is that this example
should be the <em>opposite</em> to the default (so the comment will end
with &quot;Uncomment the following to enable [or disable]
<feature>.&quot; For other options, the example should give some
non-default value which is likely to be useful to the reader.</p>
</li>
</ul>
</li>
<li>
<p>There should be a blank line between each option.</p>
</li>
<li>
<p>Where several settings are grouped into a single dict, <em>avoid</em> the
convention where the whole block is commented out, resulting in
comment lines starting <code># #</code>, as this is hard to read and confusing
to edit. Instead, leave the top-level config option uncommented, and
follow the conventions above for sub-options. Ensure that your code
correctly handles the top-level option being set to <code>None</code> (as it
will be if no sub-options are enabled).</p>
</li>
<li>
<p>Lines should be wrapped at 80 characters.</p>
</li>
<li>
<p>Use two-space indents.</p>
</li>
<li>
<p><code>true</code> and <code>false</code> are spelt thus (as opposed to <code>True</code>, etc.)</p>
</li>
<li>
<p>Use single quotes (<code>'</code>) rather than double-quotes (<code>&quot;</code>) or backticks
(<code>`</code>) to refer to configuration options.</p>
</li>
</ul>
<p>Example:</p>
<pre><code>## Frobnication ##

# The frobnicator will ensure that all requests are fully frobnicated.
# To enable it, uncomment the following.
#
#frobnicator_enabled: true

# By default, the frobnicator will frobnicate with the default frobber.
# The following will make it use an alternative frobber.
#
#frobincator_frobber: special_frobber

# Settings for the frobber
#
frobber:
  # frobbing speed. Defaults to 1.
  #
  #speed: 10

  # frobbing distance. Defaults to 1000.
  #
  #distance: 100
</code></pre>
<p>Note that the sample configuration is generated from the synapse code
and is maintained by a script, <code>scripts-dev/generate_sample_config</code>.
Making sure that the output from this script matches the desired format
is left as an exercise for the reader!</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="some-notes-on-how-we-use-git"><a class="header" href="#some-notes-on-how-we-use-git">Some notes on how we use git</a></h1>
<h2 id="on-keeping-the-commit-history-clean"><a class="header" href="#on-keeping-the-commit-history-clean">On keeping the commit history clean</a></h2>
<p>In an ideal world, our git commit history would be a linear progression of
commits each of which contains a single change building on what came
before. Here, by way of an arbitrary example, is the top of <code>git log --graph b2dba0607</code>:</p>
<img src="development/git/clean.png" alt="clean git graph" width="500px">
<p>Note how the commit comment explains clearly what is changing and why. Also
note the <em>absence</em> of merge commits, as well as the absence of commits called
things like (to pick a few culprits):
<a href="https://github.com/matrix-org/synapse/commit/84691da6c">â€œpep8â€</a>, <a href="https://github.com/matrix-org/synapse/commit/474810d9d">â€œfix broken
testâ€</a>,
<a href="https://github.com/matrix-org/synapse/commit/c9d72e457">â€œoopsâ€</a>,
<a href="https://github.com/matrix-org/synapse/commit/836358823">â€œtypoâ€</a>, or <a href="https://github.com/matrix-org/synapse/commit/707374d5d">â€œWho's
the president?â€</a>.</p>
<p>There are a number of reasons why keeping a clean commit history is a good
thing:</p>
<ul>
<li>
<p>From time to time, after a change lands, it turns out to be necessary to
revert it, or to backport it to a release branch. Those operations are
<em>much</em> easier when the change is contained in a single commit.</p>
</li>
<li>
<p>Similarly, it's much easier to answer questions like â€œis the fix for
<code>/publicRooms</code> on the release branch?â€ if that change consists of a single
commit.</p>
</li>
<li>
<p>Likewise: â€œwhat has changed on this branch in the last week?â€ is much
clearer without merges and â€œpep8â€ commits everywhere.</p>
</li>
<li>
<p>Sometimes we need to figure out where a bug got introduced, or some
behaviour changed. One way of doing that is with <code>git bisect</code>: pick an
arbitrary commit between the known good point and the known bad point, and
see how the code behaves. However, that strategy fails if the commit you
chose is the middle of someone's epic branch in which they broke the world
before putting it back together again.</p>
</li>
</ul>
<p>One counterargument is that it is sometimes useful to see how a PR evolved as
it went through review cycles. This is true, but that information is always
available via the GitHub UI (or via the little-known <a href="https://help.github.com/en/github/collaborating-with-issues-and-pull-requests/checking-out-pull-requests-locally">refs/pull
namespace</a>).</p>
<p>Of course, in reality, things are more complicated than that. We have release
branches as well as <code>develop</code> and <code>master</code>, and we deliberately merge changes
between them. Bugs often slip through and have to be fixed later. That's all
fine: this not a cast-iron rule which must be obeyed, but an ideal to aim
towards.</p>
<h2 id="merges-squashes-rebases-wtf"><a class="header" href="#merges-squashes-rebases-wtf">Merges, squashes, rebases: wtf?</a></h2>
<p>Ok, so that's what we'd like to achieve. How do we achieve it?</p>
<p>The TL;DR is: when you come to merge a pull request, you <em>probably</em> want to
â€œsquash and mergeâ€:</p>
<p><img src="development/git/squash.png" alt="squash and merge" />.</p>
<p>(This applies whether you are merging your own PR, or that of another
contributor.)</p>
<p>â€œSquash and mergeâ€<sup id="a1"><a href="development/git.html#f1">1</a></sup> takes all of the changes in the
PR, and bundles them into a single commit. GitHub gives you the opportunity to
edit the commit message before you confirm, and normally you should do so,
because the default will be useless (again: <code>* woops typo</code> is not a useful
thing to keep in the historical record).</p>
<p>The main problem with this approach comes when you have a series of pull
requests which build on top of one another: as soon as you squash-merge the
first PR, you'll end up with a stack of conflicts to resolve in all of the
others. In general, it's best to avoid this situation in the first place by
trying not to have multiple related PRs in flight at the same time. Still,
sometimes that's not possible and doing a regular merge is the lesser evil.</p>
<p>Another occasion in which a regular merge makes more sense is a PR where you've
deliberately created a series of commits each of which makes sense in its own
right. For example: <a href="https://github.com/matrix-org/synapse/pull/6837">a PR which gradually propagates a refactoring operation
through the codebase</a>, or <a href="https://github.com/matrix-org/synapse/pull/5987">a
PR which is the culmination of several other
PRs</a>. In this case the ability
to figure out when a particular change/bug was introduced could be very useful.</p>
<p>Ultimately: <strong>this is not a hard-and-fast-rule</strong>. If in doubt, ask yourself â€œdo
each of the commits I am about to merge make sense in their own rightâ€, but
remember that we're just doing our best to balance â€œkeeping the commit history
cleanâ€ with other factors.</p>
<h2 id="git-branching-model"><a class="header" href="#git-branching-model">Git branching model</a></h2>
<p>A <a href="https://nvie.com/posts/a-successful-git-branching-model/">lot</a>
<a href="http://scottchacon.com/2011/08/31/github-flow.html">of</a>
<a href="https://www.endoflineblog.com/gitflow-considered-harmful">words</a> have been
written in the past about git branching models (no really, <a href="https://martinfowler.com/articles/branching-patterns.html">a
lot</a>). I tend to
think the whole thing is overblown. Fundamentally, it's not that
complicated. Here's how we do it.</p>
<p>Let's start with a picture:</p>
<p><img src="development/git/branches.jpg" alt="branching model" /></p>
<p>It looks complicated, but it's really not. There's one basic rule: <em>anyone</em> is
free to merge from <em>any</em> more-stable branch to <em>any</em> less-stable branch at
<em>any</em> time<sup id="a2"><a href="development/git.html#f2">2</a></sup>. (The principle behind this is that if a
change is good enough for the more-stable branch, then it's also good enough go
put in a less-stable branch.)</p>
<p>Meanwhile, merging (or squashing, as per the above) from a less-stable to a
more-stable branch is a deliberate action in which you want to publish a change
or a set of changes to (some subset of) the world: for example, this happens
when a PR is landed, or as part of our release process.</p>
<p>So, what counts as a more- or less-stable branch? A little reflection will show
that our active branches are ordered thus, from more-stable to less-stable:</p>
<ul>
<li><code>master</code> (tracks our last release).</li>
<li><code>release-vX.Y.Z</code> (the branch where we prepare the next release)<sup
   id="a3"><a href="development/git.html#f3">3</a></sup>.</li>
<li>PR branches which are targeting the release.</li>
<li><code>develop</code> (our &quot;mainline&quot; branch containing our bleeding-edge).</li>
<li>regular PR branches.</li>
</ul>
<p>The corollary is: if you have a bugfix that needs to land in both
<code>release-vX.Y.Z</code> <em>and</em> <code>develop</code>, then you should base your PR on
<code>release-vX.Y.Z</code>, get it merged there, and then merge from <code>release-vX.Y.Z</code> to
<code>develop</code>. (If a fix lands in <code>develop</code> and we later need it in a
release-branch, we can of course cherry-pick it, but landing it in the release
branch first helps reduce the chance of annoying conflicts.)</p>
<hr />
<p><b id="f1">[1]</b>: â€œSquash and mergeâ€ is GitHub's term for this
operation. Given that there is no merge involved, I'm not convinced it's the
most intuitive name. <a href="development/git.html#a1">^</a></p>
<p><b id="f2">[2]</b>: Well, anyone with commit access.<a href="development/git.html#a2">^</a></p>
<p><b id="f3">[3]</b>: Very, very occasionally (I think this has happened once in
the history of Synapse), we've had two releases in flight at once. Obviously,
<code>release-v1.2.3</code> is more-stable than <code>release-v1.3.0</code>. <a href="development/git.html#a3">^</a></p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="testing"><a class="header" href="#testing">Testing</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="opentracing"><a class="header" href="#opentracing">OpenTracing</a></h1>
<h2 id="background"><a class="header" href="#background">Background</a></h2>
<p>OpenTracing is a semi-standard being adopted by a number of distributed
tracing platforms. It is a common api for facilitating vendor-agnostic
tracing instrumentation. That is, we can use the OpenTracing api and
select one of a number of tracer implementations to do the heavy lifting
in the background. Our current selected implementation is Jaeger.</p>
<p>OpenTracing is a tool which gives an insight into the causal
relationship of work done in and between servers. The servers each track
events and report them to a centralised server - in Synapse's case:
Jaeger. The basic unit used to represent events is the span. The span
roughly represents a single piece of work that was done and the time at
which it occurred. A span can have child spans, meaning that the work of
the child had to be completed for the parent span to complete, or it can
have follow-on spans which represent work that is undertaken as a result
of the parent but is not depended on by the parent to in order to
finish.</p>
<p>Since this is undertaken in a distributed environment a request to
another server, such as an RPC or a simple GET, can be considered a span
(a unit or work) for the local server. This causal link is what
OpenTracing aims to capture and visualise. In order to do this metadata
about the local server's span, i.e the 'span context', needs to be
included with the request to the remote.</p>
<p>It is up to the remote server to decide what it does with the spans it
creates. This is called the sampling policy and it can be configured
through Jaeger's settings.</p>
<p>For OpenTracing concepts see
<a href="https://opentracing.io/docs/overview/what-is-tracing/">https://opentracing.io/docs/overview/what-is-tracing/</a>.</p>
<p>For more information about Jaeger's implementation see
<a href="https://www.jaegertracing.io/docs/">https://www.jaegertracing.io/docs/</a></p>
<h2 id="setting-up-opentracing"><a class="header" href="#setting-up-opentracing">Setting up OpenTracing</a></h2>
<p>To receive OpenTracing spans, start up a Jaeger server. This can be done
using docker like so:</p>
<pre><code class="language-sh">docker run -d --name jaeger
  -p 6831:6831/udp \
  -p 6832:6832/udp \
  -p 5778:5778 \
  -p 16686:16686 \
  -p 14268:14268 \
  jaegertracing/all-in-one:1.13
</code></pre>
<p>Latest documentation is probably at
<a href="https://www.jaegertracing.io/docs/1.13/getting-started/">https://www.jaegertracing.io/docs/1.13/getting-started/</a></p>
<h2 id="enable-opentracing-in-synapse"><a class="header" href="#enable-opentracing-in-synapse">Enable OpenTracing in Synapse</a></h2>
<p>OpenTracing is not enabled by default. It must be enabled in the
homeserver config by uncommenting the config options under <code>opentracing</code>
as shown in the <a href="development/../../docs/sample_config.yaml">sample config</a>. For example:</p>
<pre><code class="language-yaml">opentracing:
  tracer_enabled: true
  homeserver_whitelist:
    - &quot;mytrustedhomeserver.org&quot;
    - &quot;*.myotherhomeservers.com&quot;
</code></pre>
<h2 id="homeserver-whitelisting"><a class="header" href="#homeserver-whitelisting">Homeserver whitelisting</a></h2>
<p>The homeserver whitelist is configured using regular expressions. A list
of regular expressions can be given and their union will be compared
when propagating any spans contexts to another homeserver.</p>
<p>Though it's mostly safe to send and receive span contexts to and from
untrusted users since span contexts are usually opaque ids it can lead
to two problems, namely:</p>
<ul>
<li>If the span context is marked as sampled by the sending homeserver
the receiver will sample it. Therefore two homeservers with wildly
different sampling policies could incur higher sampling counts than
intended.</li>
<li>Sending servers can attach arbitrary data to spans, known as
'baggage'. For safety this has been disabled in Synapse but that
doesn't prevent another server sending you baggage which will be
logged to OpenTracing's logs.</li>
</ul>
<h2 id="configuring-jaeger"><a class="header" href="#configuring-jaeger">Configuring Jaeger</a></h2>
<p>Sampling strategies can be set as in this document:
<a href="https://www.jaegertracing.io/docs/1.13/sampling/">https://www.jaegertracing.io/docs/1.13/sampling/</a></p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="log-contexts"><a class="header" href="#log-contexts">Log Contexts</a></h1>
<p>To help track the processing of individual requests, synapse uses a
'<code>log context</code>' to track which request it is handling at any given
moment. This is done via a thread-local variable; a <code>logging.Filter</code> is
then used to fish the information back out of the thread-local variable
and add it to each log record.</p>
<p>Logcontexts are also used for CPU and database accounting, so that we
can track which requests were responsible for high CPU use or database
activity.</p>
<p>The <code>synapse.logging.context</code> module provides a facilities for managing
the current log context (as well as providing the <code>LoggingContextFilter</code>
class).</p>
<p>Deferreds make the whole thing complicated, so this document describes
how it all works, and how to write code which follows the rules.</p>
<p>##Logcontexts without Deferreds</p>
<p>In the absence of any Deferred voodoo, things are simple enough. As with
any code of this nature, the rule is that our function should leave
things as it found them:</p>
<pre><code class="language-python">from synapse.logging import context         # omitted from future snippets

def handle_request(request_id):
    request_context = context.LoggingContext()

    calling_context = context.set_current_context(request_context)
    try:
        request_context.request = request_id
        do_request_handling()
        logger.debug(&quot;finished&quot;)
    finally:
        context.set_current_context(calling_context)

def do_request_handling():
    logger.debug(&quot;phew&quot;)  # this will be logged against request_id
</code></pre>
<p>LoggingContext implements the context management methods, so the above
can be written much more succinctly as:</p>
<pre><code class="language-python">def handle_request(request_id):
    with context.LoggingContext() as request_context:
        request_context.request = request_id
        do_request_handling()
        logger.debug(&quot;finished&quot;)

def do_request_handling():
    logger.debug(&quot;phew&quot;)
</code></pre>
<h2 id="using-logcontexts-with-deferreds"><a class="header" href="#using-logcontexts-with-deferreds">Using logcontexts with Deferreds</a></h2>
<p>Deferreds --- and in particular, <code>defer.inlineCallbacks</code> --- break the
linear flow of code so that there is no longer a single entry point
where we should set the logcontext and a single exit point where we
should remove it.</p>
<p>Consider the example above, where <code>do_request_handling</code> needs to do some
blocking operation, and returns a deferred:</p>
<pre><code class="language-python">@defer.inlineCallbacks
def handle_request(request_id):
    with context.LoggingContext() as request_context:
        request_context.request = request_id
        yield do_request_handling()
        logger.debug(&quot;finished&quot;)
</code></pre>
<p>In the above flow:</p>
<ul>
<li>The logcontext is set</li>
<li><code>do_request_handling</code> is called, and returns a deferred</li>
<li><code>handle_request</code> yields the deferred</li>
<li>The <code>inlineCallbacks</code> wrapper of <code>handle_request</code> returns a deferred</li>
</ul>
<p>So we have stopped processing the request (and will probably go on to
start processing the next), without clearing the logcontext.</p>
<p>To circumvent this problem, synapse code assumes that, wherever you have
a deferred, you will want to yield on it. To that end, whereever
functions return a deferred, we adopt the following conventions:</p>
<p><strong>Rules for functions returning deferreds:</strong></p>
<blockquote>
<ul>
<li>If the deferred is already complete, the function returns with the
same logcontext it started with.</li>
<li>If the deferred is incomplete, the function clears the logcontext
before returning; when the deferred completes, it restores the
logcontext before running any callbacks.</li>
</ul>
</blockquote>
<p>That sounds complicated, but actually it means a lot of code (including
the example above) &quot;just works&quot;. There are two cases:</p>
<ul>
<li>
<p>If <code>do_request_handling</code> returns a completed deferred, then the
logcontext will still be in place. In this case, execution will
continue immediately after the <code>yield</code>; the &quot;finished&quot; line will
be logged against the right context, and the <code>with</code> block restores
the original context before we return to the caller.</p>
</li>
<li>
<p>If the returned deferred is incomplete, <code>do_request_handling</code> clears
the logcontext before returning. The logcontext is therefore clear
when <code>handle_request</code> yields the deferred. At that point, the
<code>inlineCallbacks</code> wrapper adds a callback to the deferred, and
returns another (incomplete) deferred to the caller, and it is safe
to begin processing the next request.</p>
<p>Once <code>do_request_handling</code>'s deferred completes, it will reinstate
the logcontext, before running the callback added by the
<code>inlineCallbacks</code> wrapper. That callback runs the second half of
<code>handle_request</code>, so again the &quot;finished&quot; line will be logged
against the right context, and the <code>with</code> block restores the
original context.</p>
</li>
</ul>
<p>As an aside, it's worth noting that <code>handle_request</code> follows our rules
-though that only matters if the caller has its own logcontext which it
cares about.</p>
<p>The following sections describe pitfalls and helpful patterns when
implementing these rules.</p>
<h2 id="always-yield-your-deferreds"><a class="header" href="#always-yield-your-deferreds">Always yield your deferreds</a></h2>
<p>Whenever you get a deferred back from a function, you should <code>yield</code> on
it as soon as possible. (Returning it directly to your caller is ok too,
if you're not doing <code>inlineCallbacks</code>.) Do not pass go; do not do any
logging; do not call any other functions.</p>
<pre><code class="language-python">@defer.inlineCallbacks
def fun():
    logger.debug(&quot;starting&quot;)
    yield do_some_stuff()       # just like this

    d = more_stuff()
    result = yield d            # also fine, of course

    return result

def nonInlineCallbacksFun():
    logger.debug(&quot;just a wrapper really&quot;)
    return do_some_stuff()      # this is ok too - the caller will yield on
                                # it anyway.
</code></pre>
<p>Provided this pattern is followed all the way back up to the callchain
to where the logcontext was set, this will make things work out ok:
provided <code>do_some_stuff</code> and <code>more_stuff</code> follow the rules above, then
so will <code>fun</code> (as wrapped by <code>inlineCallbacks</code>) and
<code>nonInlineCallbacksFun</code>.</p>
<p>It's all too easy to forget to <code>yield</code>: for instance if we forgot that
<code>do_some_stuff</code> returned a deferred, we might plough on regardless. This
leads to a mess; it will probably work itself out eventually, but not
before a load of stuff has been logged against the wrong context.
(Normally, other things will break, more obviously, if you forget to
<code>yield</code>, so this tends not to be a major problem in practice.)</p>
<p>Of course sometimes you need to do something a bit fancier with your
Deferreds - not all code follows the linear A-then-B-then-C pattern.
Notes on implementing more complex patterns are in later sections.</p>
<h2 id="where-you-create-a-new-deferred-make-it-follow-the-rules"><a class="header" href="#where-you-create-a-new-deferred-make-it-follow-the-rules">Where you create a new Deferred, make it follow the rules</a></h2>
<p>Most of the time, a Deferred comes from another synapse function.
Sometimes, though, we need to make up a new Deferred, or we get a
Deferred back from external code. We need to make it follow our rules.</p>
<p>The easy way to do it is with a combination of <code>defer.inlineCallbacks</code>,
and <code>context.PreserveLoggingContext</code>. Suppose we want to implement
<code>sleep</code>, which returns a deferred which will run its callbacks after a
given number of seconds. That might look like:</p>
<pre><code class="language-python"># not a logcontext-rules-compliant function
def get_sleep_deferred(seconds):
    d = defer.Deferred()
    reactor.callLater(seconds, d.callback, None)
    return d
</code></pre>
<p>That doesn't follow the rules, but we can fix it by wrapping it with
<code>PreserveLoggingContext</code> and <code>yield</code> ing on it:</p>
<pre><code class="language-python">@defer.inlineCallbacks
def sleep(seconds):
    with PreserveLoggingContext():
        yield get_sleep_deferred(seconds)
</code></pre>
<p>This technique works equally for external functions which return
deferreds, or deferreds we have made ourselves.</p>
<p>You can also use <code>context.make_deferred_yieldable</code>, which just does the
boilerplate for you, so the above could be written:</p>
<pre><code class="language-python">def sleep(seconds):
    return context.make_deferred_yieldable(get_sleep_deferred(seconds))
</code></pre>
<h2 id="fire-and-forget"><a class="header" href="#fire-and-forget">Fire-and-forget</a></h2>
<p>Sometimes you want to fire off a chain of execution, but not wait for
its result. That might look a bit like this:</p>
<pre><code class="language-python">@defer.inlineCallbacks
def do_request_handling():
    yield foreground_operation()

    # *don't* do this
    background_operation()

    logger.debug(&quot;Request handling complete&quot;)

@defer.inlineCallbacks
def background_operation():
    yield first_background_step()
    logger.debug(&quot;Completed first step&quot;)
    yield second_background_step()
    logger.debug(&quot;Completed second step&quot;)
</code></pre>
<p>The above code does a couple of steps in the background after
<code>do_request_handling</code> has finished. The log lines are still logged
against the <code>request_context</code> logcontext, which may or may not be
desirable. There are two big problems with the above, however. The first
problem is that, if <code>background_operation</code> returns an incomplete
Deferred, it will expect its caller to <code>yield</code> immediately, so will have
cleared the logcontext. In this example, that means that 'Request
handling complete' will be logged without any context.</p>
<p>The second problem, which is potentially even worse, is that when the
Deferred returned by <code>background_operation</code> completes, it will restore
the original logcontext. There is nothing waiting on that Deferred, so
the logcontext will leak into the reactor and possibly get attached to
some arbitrary future operation.</p>
<p>There are two potential solutions to this.</p>
<p>One option is to surround the call to <code>background_operation</code> with a
<code>PreserveLoggingContext</code> call. That will reset the logcontext before
starting <code>background_operation</code> (so the context restored when the
deferred completes will be the empty logcontext), and will restore the
current logcontext before continuing the foreground process:</p>
<pre><code class="language-python">@defer.inlineCallbacks
def do_request_handling():
    yield foreground_operation()

    # start background_operation off in the empty logcontext, to
    # avoid leaking the current context into the reactor.
    with PreserveLoggingContext():
        background_operation()

    # this will now be logged against the request context
    logger.debug(&quot;Request handling complete&quot;)
</code></pre>
<p>Obviously that option means that the operations done in
<code>background_operation</code> would be not be logged against a logcontext
(though that might be fixed by setting a different logcontext via a
<code>with LoggingContext(...)</code> in <code>background_operation</code>).</p>
<p>The second option is to use <code>context.run_in_background</code>, which wraps a
function so that it doesn't reset the logcontext even when it returns
an incomplete deferred, and adds a callback to the returned deferred to
reset the logcontext. In other words, it turns a function that follows
the Synapse rules about logcontexts and Deferreds into one which behaves
more like an external function --- the opposite operation to that
described in the previous section. It can be used like this:</p>
<pre><code class="language-python">@defer.inlineCallbacks
def do_request_handling():
    yield foreground_operation()

    context.run_in_background(background_operation)

    # this will now be logged against the request context
    logger.debug(&quot;Request handling complete&quot;)
</code></pre>
<h2 id="passing-synapse-deferreds-into-third-party-functions"><a class="header" href="#passing-synapse-deferreds-into-third-party-functions">Passing synapse deferreds into third-party functions</a></h2>
<p>A typical example of this is where we want to collect together two or
more deferred via <code>defer.gatherResults</code>:</p>
<pre><code class="language-python">d1 = operation1()
d2 = operation2()
d3 = defer.gatherResults([d1, d2])
</code></pre>
<p>This is really a variation of the fire-and-forget problem above, in that
we are firing off <code>d1</code> and <code>d2</code> without yielding on them. The difference
is that we now have third-party code attached to their callbacks. Anyway
either technique given in the <a href="development/log_contexts.html#fire-and-forget">Fire-and-forget</a>
section will work.</p>
<p>Of course, the new Deferred returned by <code>gatherResults</code> needs to be
wrapped in order to make it follow the logcontext rules before we can
yield it, as described in <a href="development/log_contexts.html#where-you-create-a-new-deferred-make-it-follow-the-rules">Where you create a new Deferred, make it
follow the
rules</a>.</p>
<p>So, option one: reset the logcontext before starting the operations to
be gathered:</p>
<pre><code class="language-python">@defer.inlineCallbacks
def do_request_handling():
    with PreserveLoggingContext():
        d1 = operation1()
        d2 = operation2()
        result = yield defer.gatherResults([d1, d2])
</code></pre>
<p>In this case particularly, though, option two, of using
<code>context.preserve_fn</code> almost certainly makes more sense, so that
<code>operation1</code> and <code>operation2</code> are both logged against the original
logcontext. This looks like:</p>
<pre><code class="language-python">@defer.inlineCallbacks
def do_request_handling():
    d1 = context.preserve_fn(operation1)()
    d2 = context.preserve_fn(operation2)()

    with PreserveLoggingContext():
        result = yield defer.gatherResults([d1, d2])
</code></pre>
<h2 id="was-all-this-really-necessary"><a class="header" href="#was-all-this-really-necessary">Was all this really necessary?</a></h2>
<p>The conventions used work fine for a linear flow where everything
happens in series via <code>defer.inlineCallbacks</code> and <code>yield</code>, but are
certainly tricky to follow for any more exotic flows. It's hard not to
wonder if we could have done something else.</p>
<p>We're not going to rewrite Synapse now, so the following is entirely of
academic interest, but I'd like to record some thoughts on an
alternative approach.</p>
<p>I briefly prototyped some code following an alternative set of rules. I
think it would work, but I certainly didn't get as far as thinking how
it would interact with concepts as complicated as the cache descriptors.</p>
<p>My alternative rules were:</p>
<ul>
<li>functions always preserve the logcontext of their caller, whether or
not they are returning a Deferred.</li>
<li>Deferreds returned by synapse functions run their callbacks in the
same context as the function was orignally called in.</li>
</ul>
<p>The main point of this scheme is that everywhere that sets the
logcontext is responsible for clearing it before returning control to
the reactor.</p>
<p>So, for example, if you were the function which started a
<code>with LoggingContext</code> block, you wouldn't <code>yield</code> within it --- instead
you'd start off the background process, and then leave the <code>with</code> block
to wait for it:</p>
<pre><code class="language-python">def handle_request(request_id):
    with context.LoggingContext() as request_context:
        request_context.request = request_id
        d = do_request_handling()

    def cb(r):
        logger.debug(&quot;finished&quot;)

    d.addCallback(cb)
    return d
</code></pre>
<p>(in general, mixing <code>with LoggingContext</code> blocks and
<code>defer.inlineCallbacks</code> in the same function leads to slighly
counter-intuitive code, under this scheme).</p>
<p>Because we leave the original <code>with</code> block as soon as the Deferred is
returned (as opposed to waiting for it to be resolved, as we do today),
the logcontext is cleared before control passes back to the reactor; so
if there is some code within <code>do_request_handling</code> which needs to wait
for a Deferred to complete, there is no need for it to worry about
clearing the logcontext before doing so:</p>
<pre><code class="language-python">def handle_request():
    r = do_some_stuff()
    r.addCallback(do_some_more_stuff)
    return r
</code></pre>
<p>--- and provided <code>do_some_stuff</code> follows the rules of returning a
Deferred which runs its callbacks in the original logcontext, all is
happy.</p>
<p>The business of a Deferred which runs its callbacks in the original
logcontext isn't hard to achieve --- we have it today, in the shape of
<code>context._PreservingContextDeferred</code>:</p>
<pre><code class="language-python">def do_some_stuff():
    deferred = do_some_io()
    pcd = _PreservingContextDeferred(LoggingContext.current_context())
    deferred.chainDeferred(pcd)
    return pcd
</code></pre>
<p>It turns out that, thanks to the way that Deferreds chain together, we
automatically get the property of a context-preserving deferred with
<code>defer.inlineCallbacks</code>, provided the final Defered the function
<code>yields</code> on has that property. So we can just write:</p>
<pre><code class="language-python">@defer.inlineCallbacks
def handle_request():
    yield do_some_stuff()
    yield do_some_more_stuff()
</code></pre>
<p>To conclude: I think this scheme would have worked equally well, with
less danger of messing it up, and probably made some more esoteric code
easier to write. But again --- changing the conventions of the entire
Synapse codebase is not a sensible option for the marginal improvement
offered.</p>
<h2 id="a-note-on-garbage-collection-of-deferred-chains"><a class="header" href="#a-note-on-garbage-collection-of-deferred-chains">A note on garbage-collection of Deferred chains</a></h2>
<p>It turns out that our logcontext rules do not play nicely with Deferred
chains which get orphaned and garbage-collected.</p>
<p>Imagine we have some code that looks like this:</p>
<pre><code class="language-python">listener_queue = []

def on_something_interesting():
    for d in listener_queue:
        d.callback(&quot;foo&quot;)

@defer.inlineCallbacks
def await_something_interesting():
    new_deferred = defer.Deferred()
    listener_queue.append(new_deferred)

    with PreserveLoggingContext():
        yield new_deferred
</code></pre>
<p>Obviously, the idea here is that we have a bunch of things which are
waiting for an event. (It's just an example of the problem here, but a
relatively common one.)</p>
<p>Now let's imagine two further things happen. First of all, whatever was
waiting for the interesting thing goes away. (Perhaps the request times
out, or something <em>even more</em> interesting happens.)</p>
<p>Secondly, let's suppose that we decide that the interesting thing is
never going to happen, and we reset the listener queue:</p>
<pre><code class="language-python">def reset_listener_queue():
    listener_queue.clear()
</code></pre>
<p>So, both ends of the deferred chain have now dropped their references,
and the deferred chain is now orphaned, and will be garbage-collected at
some point. Note that <code>await_something_interesting</code> is a generator
function, and when Python garbage-collects generator functions, it gives
them a chance to clean up by making the <code>yield</code> raise a <code>GeneratorExit</code>
exception. In our case, that means that the <code>__exit__</code> handler of
<code>PreserveLoggingContext</code> will carefully restore the request context, but
there is now nothing waiting for its return, so the request context is
never cleared.</p>
<p>To reiterate, this problem only arises when <em>both</em> ends of a deferred
chain are dropped. Dropping the the reference to a deferred you're
supposed to be calling is probably bad practice, so this doesn't
actually happen too much. Unfortunately, when it does happen, it will
lead to leaked logcontexts which are incredibly hard to track down.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="feature-documentation"><a class="header" href="#feature-documentation">Feature Documentation</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="media-repository"><a class="header" href="#media-repository">Media Repository</a></h1>
<p><em>Synapse implementation-specific details for the media repository</em></p>
<p>The media repository is where attachments and avatar photos are stored.
It stores attachment content and thumbnails for media uploaded by local users.
It caches attachment content and thumbnails for media uploaded by remote users.</p>
<h2 id="storage"><a class="header" href="#storage">Storage</a></h2>
<p>Each item of media is assigned a <code>media_id</code> when it is uploaded.
The <code>media_id</code> is a randomly chosen, URL safe 24 character string.</p>
<p>Metadata such as the MIME type, upload time and length are stored in the
sqlite3 database indexed by <code>media_id</code>.</p>
<p>Content is stored on the filesystem under a <code>&quot;local_content&quot;</code> directory.</p>
<p>Thumbnails are stored under a <code>&quot;local_thumbnails&quot;</code> directory.</p>
<p>The item with <code>media_id</code> <code>&quot;aabbccccccccdddddddddddd&quot;</code> is stored under
<code>&quot;local_content/aa/bb/ccccccccdddddddddddd&quot;</code>. Its thumbnail with width
<code>128</code> and height <code>96</code> and type <code>&quot;image/jpeg&quot;</code> is stored under
<code>&quot;local_thumbnails/aa/bb/ccccccccdddddddddddd/128-96-image-jpeg&quot;</code></p>
<p>Remote content is cached under <code>&quot;remote_content&quot;</code> directory. Each item of
remote content is assigned a local <code>&quot;filesystem_id&quot;</code> to ensure that the
directory structure <code>&quot;remote_content/server_name/aa/bb/ccccccccdddddddddddd&quot;</code>
is appropriate. Thumbnails for remote content are stored under
<code>&quot;remote_thumbnails/server_name/...&quot;</code></p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="room-and-user-statistics"><a class="header" href="#room-and-user-statistics">Room and User Statistics</a></h1>
<p>Synapse maintains room and user statistics (as well as a cache of room state),
in various tables. These can be used for administrative purposes but are also
used when generating the public room directory.</p>
<h1 id="synapse-developer-documentation"><a class="header" href="#synapse-developer-documentation">Synapse Developer Documentation</a></h1>
<h2 id="high-level-concepts"><a class="header" href="#high-level-concepts">High-Level Concepts</a></h2>
<h3 id="definitions"><a class="header" href="#definitions">Definitions</a></h3>
<ul>
<li><strong>subject</strong>: Something we are tracking stats about â€“ currently a room or user.</li>
<li><strong>current row</strong>: An entry for a subject in the appropriate current statistics
table. Each subject can have only one.</li>
<li><strong>historical row</strong>: An entry for a subject in the appropriate historical
statistics table. Each subject can have any number of these.</li>
</ul>
<h3 id="overview-2"><a class="header" href="#overview-2">Overview</a></h3>
<p>Stats are maintained as time series. There are two kinds of column:</p>
<ul>
<li>absolute columns â€“ where the value is correct for the time given by <code>end_ts</code>
in the stats row. (Imagine a line graph for these values)
<ul>
<li>They can also be thought of as 'gauges' in Prometheus, if you are familiar.</li>
</ul>
</li>
<li>per-slice columns â€“ where the value corresponds to how many of the occurrences
occurred within the time slice given by <code>(end_ts âˆ’ bucket_size)â€¦end_ts</code>
or <code>start_tsâ€¦end_ts</code>. (Imagine a histogram for these values)</li>
</ul>
<p>Stats are maintained in two tables (for each type): current and historical.</p>
<p>Current stats correspond to the present values. Each subject can only have one
entry.</p>
<p>Historical stats correspond to values in the past. Subjects may have multiple
entries.</p>
<h2 id="concepts-around-the-management-of-stats"><a class="header" href="#concepts-around-the-management-of-stats">Concepts around the management of stats</a></h2>
<h3 id="current-rows"><a class="header" href="#current-rows">Current rows</a></h3>
<p>Current rows contain the most up-to-date statistics for a room.
They only contain absolute columns</p>
<h3 id="historical-rows"><a class="header" href="#historical-rows">Historical rows</a></h3>
<p>Historical rows can always be considered to be valid for the time slice and
end time specified.</p>
<ul>
<li>historical rows will not exist for every time slice â€“ they will be omitted
if there were no changes. In this case, the following assumptions can be
made to interpolate/recreate missing rows:
<ul>
<li>absolute fields have the same values as in the preceding row</li>
<li>per-slice fields are zero (<code>0</code>)</li>
</ul>
</li>
<li>historical rows will not be retained forever â€“ rows older than a configurable
time will be purged.</li>
</ul>
<h4 id="purge"><a class="header" href="#purge">Purge</a></h4>
<p>The purging of historical rows is not yet implemented.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="replication-architecture"><a class="header" href="#replication-architecture">Replication Architecture</a></h1>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>We'd like to be able to split some of the work that synapse does into
multiple python processes. In theory multiple synapse processes could
share a single postgresql database and we'd scale up by running more
synapse processes. However much of synapse assumes that only one process
is interacting with the database, both for assigning unique identifiers
when inserting into tables, notifying components about new updates, and
for invalidating its caches.</p>
<p>So running multiple copies of the current code isn't an option. One way
to run multiple processes would be to have a single writer process and
multiple reader processes connected to the same database. In order to do
this we'd need a way for the reader process to invalidate its in-memory
caches when an update happens on the writer. One way to do this is for
the writer to present an append-only log of updates which the readers
can consume to invalidate their caches and to push updates to listening
clients or pushers.</p>
<p>Synapse already stores much of its data as an append-only log so that it
can correctly respond to <code>/sync</code> requests so the amount of code changes
needed to expose the append-only log to the readers should be fairly
minimal.</p>
<h2 id="architecture"><a class="header" href="#architecture">Architecture</a></h2>
<h3 id="the-replication-protocol"><a class="header" href="#the-replication-protocol">The Replication Protocol</a></h3>
<p>See <a href="development/feature_documentation/tcp_replication.html">tcp_replication.md</a></p>
<h3 id="the-slaved-datastore"><a class="header" href="#the-slaved-datastore">The Slaved DataStore</a></h3>
<p>There are read-only version of the synapse storage layer in
<code>synapse/replication/slave/storage</code> that use the response of the
replication API to invalidate their caches.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="tcp-replication"><a class="header" href="#tcp-replication">TCP Replication</a></h1>
<h2 id="motivation-1"><a class="header" href="#motivation-1">Motivation</a></h2>
<p>Previously the workers used an HTTP long poll mechanism to get updates
from the master, which had the problem of causing a lot of duplicate
work on the server. This TCP protocol replaces those APIs with the aim
of increased efficiency.</p>
<h2 id="overview-3"><a class="header" href="#overview-3">Overview</a></h2>
<p>The protocol is based on fire and forget, line based commands. An
example flow would be (where '&gt;' indicates master to worker and
'&lt;' worker to master flows):</p>
<pre><code>&gt; SERVER example.com
&lt; REPLICATE
&gt; POSITION events master 53 53
&gt; RDATA events master 54 [&quot;$foo1:bar.com&quot;, ...]
&gt; RDATA events master 55 [&quot;$foo4:bar.com&quot;, ...]
</code></pre>
<p>The example shows the server accepting a new connection and sending its identity
with the <code>SERVER</code> command, followed by the client server to respond with the
position of all streams. The server then periodically sends <code>RDATA</code> commands
which have the format <code>RDATA &lt;stream_name&gt; &lt;instance_name&gt; &lt;token&gt; &lt;row&gt;</code>, where
the format of <code>&lt;row&gt;</code> is defined by the individual streams. The
<code>&lt;instance_name&gt;</code> is the name of the Synapse process that generated the data
(usually &quot;master&quot;).</p>
<p>Error reporting happens by either the client or server sending an ERROR
command, and usually the connection will be closed.</p>
<p>Since the protocol is a simple line based, its possible to manually
connect to the server using a tool like netcat. A few things should be
noted when manually using the protocol:</p>
<ul>
<li>The federation stream is only available if federation sending has
been disabled on the main process.</li>
<li>The server will only time connections out that have sent a <code>PING</code>
command. If a ping is sent then the connection will be closed if no
further commands are receieved within 15s. Both the client and
server protocol implementations will send an initial PING on
connection and ensure at least one command every 5s is sent (not
necessarily <code>PING</code>).</li>
<li><code>RDATA</code> commands <em>usually</em> include a numeric token, however if the
stream has multiple rows to replicate per token the server will send
multiple <code>RDATA</code> commands, with all but the last having a token of
<code>batch</code>. See the documentation on <code>commands.RdataCommand</code> for
further details.</li>
</ul>
<h2 id="architecture-1"><a class="header" href="#architecture-1">Architecture</a></h2>
<p>The basic structure of the protocol is line based, where the initial
word of each line specifies the command. The rest of the line is parsed
based on the command. For example, the RDATA command is defined as:</p>
<pre><code>RDATA &lt;stream_name&gt; &lt;instance_name&gt; &lt;token&gt; &lt;row_json&gt;
</code></pre>
<p>(Note that &lt;row_json&gt; may contains spaces, but cannot contain
newlines.)</p>
<p>Blank lines are ignored.</p>
<h3 id="keep-alives"><a class="header" href="#keep-alives">Keep alives</a></h3>
<p>Both sides are expected to send at least one command every 5s or so, and
should send a <code>PING</code> command if necessary. If either side do not receive
a command within e.g. 15s then the connection should be closed.</p>
<p>Because the server may be connected to manually using e.g. netcat, the
timeouts aren't enabled until an initial <code>PING</code> command is seen. Both
the client and server implementations below send a <code>PING</code> command
immediately on connection to ensure the timeouts are enabled.</p>
<p>This ensures that both sides can quickly realize if the tcp connection
has gone and handle the situation appropriately.</p>
<h3 id="start-up"><a class="header" href="#start-up">Start up</a></h3>
<p>When a new connection is made, the server:</p>
<ul>
<li>Sends a <code>SERVER</code> command, which includes the identity of the server,
allowing the client to detect if its connected to the expected
server</li>
<li>Sends a <code>PING</code> command as above, to enable the client to time out
connections promptly.</li>
</ul>
<p>The client:</p>
<ul>
<li>Sends a <code>NAME</code> command, allowing the server to associate a human
friendly name with the connection. This is optional.</li>
<li>Sends a <code>PING</code> as above</li>
<li>Sends a <code>REPLICATE</code> to get the current position of all streams.</li>
<li>On receipt of a <code>SERVER</code> command, checks that the server name
matches the expected server name.</li>
</ul>
<h3 id="error-handling"><a class="header" href="#error-handling">Error handling</a></h3>
<p>If either side detects an error it can send an <code>ERROR</code> command and close
the connection.</p>
<p>If the client side loses the connection to the server it should
reconnect, following the steps above.</p>
<h3 id="congestion"><a class="header" href="#congestion">Congestion</a></h3>
<p>If the server sends messages faster than the client can consume them the
server will first buffer a (fairly large) number of commands and then
disconnect the client. This ensures that we don't queue up an unbounded
number of commands in memory and gives us a potential oppurtunity to
squawk loudly. When/if the client recovers it can reconnect to the
server and ask for missed messages.</p>
<h3 id="reliability"><a class="header" href="#reliability">Reliability</a></h3>
<p>In general the replication stream should be considered an unreliable
transport since e.g. commands are not resent if the connection
disappears.</p>
<p>The exception to that are the replication streams, i.e. RDATA commands,
since these include tokens which can be used to restart the stream on
connection errors.</p>
<p>The client should keep track of the token in the last RDATA command
received for each stream so that on reconneciton it can start streaming
from the correct place. Note: not all RDATA have valid tokens due to
batching. See <code>RdataCommand</code> for more details.</p>
<h3 id="example-4"><a class="header" href="#example-4">Example</a></h3>
<p>An example iteraction is shown below. Each line is prefixed with '&gt;'
or '&lt;' to indicate which side is sending, these are <em>not</em> included on
the wire:</p>
<pre><code>* connection established *
&gt; SERVER localhost:8823
&gt; PING 1490197665618
&lt; NAME synapse.app.appservice
&lt; PING 1490197665618
&lt; REPLICATE
&gt; POSITION events master 1 1
&gt; POSITION backfill master 1 1
&gt; POSITION caches master 1 1
&gt; RDATA caches master 2 [&quot;get_user_by_id&quot;,[&quot;@01register-user:localhost:8823&quot;],1490197670513]
&gt; RDATA events master 14 [&quot;$149019767112vOHxz:localhost:8823&quot;,
    &quot;!AFDCvgApUmpdfVjIXm:localhost:8823&quot;,&quot;m.room.guest_access&quot;,&quot;&quot;,null]
&lt; PING 1490197675618
&gt; ERROR server stopping
* connection closed by server *
</code></pre>
<p>The <code>POSITION</code> command sent by the server is used to set the clients
position without needing to send data with the <code>RDATA</code> command.</p>
<p>An example of a batched set of <code>RDATA</code> is:</p>
<pre><code>&gt; RDATA caches master batch [&quot;get_user_by_id&quot;,[&quot;@test:localhost:8823&quot;],1490197670513]
&gt; RDATA caches master batch [&quot;get_user_by_id&quot;,[&quot;@test2:localhost:8823&quot;],1490197670513]
&gt; RDATA caches master batch [&quot;get_user_by_id&quot;,[&quot;@test3:localhost:8823&quot;],1490197670513]
&gt; RDATA caches master 54 [&quot;get_user_by_id&quot;,[&quot;@test4:localhost:8823&quot;],1490197670513]
</code></pre>
<p>In this case the client shouldn't advance their caches token until it
sees the the last <code>RDATA</code>.</p>
<h3 id="list-of-commands"><a class="header" href="#list-of-commands">List of commands</a></h3>
<p>The list of valid commands, with which side can send it: server (S) or
client (C):</p>
<h4 id="server-s"><a class="header" href="#server-s">SERVER (S)</a></h4>
<p>Sent at the start to identify which server the client is talking to</p>
<h4 id="rdata-s"><a class="header" href="#rdata-s">RDATA (S)</a></h4>
<p>A single update in a stream</p>
<h4 id="position-s"><a class="header" href="#position-s">POSITION (S)</a></h4>
<p>On receipt of a POSITION command clients should check if they have missed any
updates, and if so then fetch them out of band. Sent in response to a
REPLICATE command (but can happen at any time).</p>
<p>The POSITION command includes the source of the stream. Currently all streams
are written by a single process (usually &quot;master&quot;). If fetching missing
updates via HTTP API, rather than via the DB, then processes should make the
request to the appropriate process.</p>
<p>Two positions are included, the &quot;new&quot; position and the last position sent respectively.
This allows servers to tell instances that the positions have advanced but no
data has been written, without clients needlessly checking to see if they
have missed any updates.</p>
<h4 id="error-s-c"><a class="header" href="#error-s-c">ERROR (S, C)</a></h4>
<p>There was an error</p>
<h4 id="ping-s-c"><a class="header" href="#ping-s-c">PING (S, C)</a></h4>
<p>Sent periodically to ensure the connection is still alive</p>
<h4 id="name-c"><a class="header" href="#name-c">NAME (C)</a></h4>
<p>Sent at the start by client to inform the server who they are</p>
<h4 id="replicate-c"><a class="header" href="#replicate-c">REPLICATE (C)</a></h4>
<p>Asks the server for the current position of all streams.</p>
<h4 id="user_sync-c"><a class="header" href="#user_sync-c">USER_SYNC (C)</a></h4>
<p>A user has started or stopped syncing on this process.</p>
<h4 id="clear_user_sync-c"><a class="header" href="#clear_user_sync-c">CLEAR_USER_SYNC (C)</a></h4>
<p>The server should clear all associated user sync data from the worker.</p>
<p>This is used when a worker is shutting down.</p>
<h4 id="federation_ack-c"><a class="header" href="#federation_ack-c">FEDERATION_ACK (C)</a></h4>
<p>Acknowledge receipt of some federation data</p>
<h3 id="remote_server_up-s-c"><a class="header" href="#remote_server_up-s-c">REMOTE_SERVER_UP (S, C)</a></h3>
<p>Inform other processes that a remote server may have come back online.</p>
<p>See <code>synapse/replication/tcp/commands.py</code> for a detailed description and
the format of each command.</p>
<h3 id="cache-invalidation-stream"><a class="header" href="#cache-invalidation-stream">Cache Invalidation Stream</a></h3>
<p>The cache invalidation stream is used to inform workers when they need
to invalidate any of their caches in the data store. This is done by
streaming all cache invalidations done on master down to the workers,
assuming that any caches on the workers also exist on the master.</p>
<p>Each individual cache invalidation results in a row being sent down
replication, which includes the cache name (the name of the function)
and they key to invalidate. For example:</p>
<pre><code>&gt; RDATA caches master 550953771 [&quot;get_user_by_id&quot;, [&quot;@bob:example.com&quot;], 1550574873251]
</code></pre>
<p>Alternatively, an entire cache can be invalidated by sending down a <code>null</code>
instead of the key. For example:</p>
<pre><code>&gt; RDATA caches master 550953772 [&quot;get_user_by_id&quot;, null, 1550574873252]
</code></pre>
<p>However, there are times when a number of caches need to be invalidated
at the same time with the same key. To reduce traffic we batch those
invalidations into a single poke by defining a special cache name that
workers understand to mean to expand to invalidate the correct caches.</p>
<p>Currently the special cache names are declared in
<code>synapse/storage/_base.py</code> and are:</p>
<ol>
<li><code>cs_cache_fake</code> â”€ invalidates caches that depend on the current
state</li>
</ol>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="scripts-1"><a class="header" href="#scripts-1">Scripts</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="other"><a class="header" href="#other">Other</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="dependency-deprecation-policy"><a class="header" href="#dependency-deprecation-policy">Dependency Deprecation Policy</a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
